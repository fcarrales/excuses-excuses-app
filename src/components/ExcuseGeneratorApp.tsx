"use client";

// üöÄ GitHub Actions Auto-Deployment Test - System Active!

import React, { useState, useEffect } from "react";
import { Button } from "@/components/ui/button";
import { Card, CardContent } from "@/components/ui/card";
import { Select, SelectTrigger, SelectValue, SelectContent, SelectItem } from "@/components/ui/select";
import { Switch } from "@/components/ui/switch";
import { Sparkles, Crown, Share2, Zap, Settings, Star, Calendar, Copy, Check, History, Trash2, MessageCircle, Mail, Twitter, Facebook, ThumbsUp, ThumbsDown, TrendingUp, Camera, FileText, MapPin, Cloud, MessageSquare, TestTube, Share } from "lucide-react";
import { BetaFeedbackForm } from "./BetaFeedbackForm";

export default function ExcuseGeneratorApp() {
  // Safe localStorage wrapper to handle security restrictions
  const safeLocalStorage = {
    isAvailable: () => {
      try {
        const test = '__localStorage_test__';
        window.localStorage.setItem(test, test);
        window.localStorage.removeItem(test);
        return true;
      } catch {
        return false;
      }
    },
    getItem: (key: string) => {
      if (!safeLocalStorage.isAvailable()) {
        return null;
      }
      try {
        return window.localStorage.getItem(key);
      } catch (error) {
        console.warn(`localStorage.getItem failed for key "${key}":`, error);
        return null;
      }
    },
    setItem: (key: string, value: string) => {
      if (!safeLocalStorage.isAvailable()) {
        return;
      }
      try {
        window.localStorage.setItem(key, value);
      } catch (error) {
        console.warn(`localStorage.setItem failed for key "${key}":`, error);
      }
    }
  };

  const [situation, setSituation] = useState("work");
  const [tone, setTone] = useState("funny");
  const [excuse, setExcuse] = useState("");
  const [showPremium, setShowPremium] = useState(false);
  const [showShare, setShowShare] = useState(false);
  const [onboarding, setOnboarding] = useState(() => {
    // Check URL parameter for forcing onboarding
    if (typeof window !== 'undefined') {
      const urlParams = new URLSearchParams(window.location.search);
      if (urlParams.get('onboard') === 'true') {
        return true;
      }
    }
    return true; // Default to true for first-time users
  });
  const [showSettings, setShowSettings] = useState(false);
  const [favorites, setFavorites] = useState<string[]>([]);
  const [dailyExcuse, setDailyExcuse] = useState("");
  const [copied, setCopied] = useState(false);
  const [excuseHistory, setExcuseHistory] = useState<{excuse: string, timestamp: Date, situation: string, tone: string}[]>([]);
  const [excuseRatings, setExcuseRatings] = useState<{[excuse: string]: {rating: 'up' | 'down', timestamp: Date}}>({});
  const [currentExcuseRated, setCurrentExcuseRated] = useState<'up' | 'down' | null>(null);
  const [isPremium, setIsPremium] = useState(false);
  const [showProofGenerator, setShowProofGenerator] = useState(false);
  const [proofFormat, setProofFormat] = useState<'document' | 'sms' | 'email'>('document');
  const [userEmailAddress, setUserEmailAddress] = useState('');
  const [emailSending, setEmailSending] = useState(false);
  const [userPhoneNumber, setUserPhoneNumber] = useState('');
  const [generatedProof, setGeneratedProof] = useState<{type: string, content: string, image?: string} | null>(null);
  
  // Patient information for medical certificates
  const [showPatientInfoDialog, setShowPatientInfoDialog] = useState(false);
  const [patientName, setPatientName] = useState('');
  const [patientDateOfBirth, setPatientDateOfBirth] = useState('');
  
  // New states for custom features
  const [customExcuses, setCustomExcuses] = useState<{[key: string]: {[key: string]: string[]}}>({}); 
  const [showCustomExcuse, setShowCustomExcuse] = useState(false);
  const [newCustomExcuse, setNewCustomExcuse] = useState("");
  const [customSituation, setCustomSituation] = useState("work");
  const [customTone, setCustomTone] = useState("funny");
  const [showTemplates, setShowTemplates] = useState(false);
  const [templateValues, setTemplateValues] = useState<{[key: string]: string}>({});
  const [showExport, setShowExport] = useState(false);
  
  // Loading and animation states
  const [isGenerating, setIsGenerating] = useState(false);
  const [isGeneratingProof, setIsGeneratingProof] = useState(false);
  const [animateExcuse, setAnimateExcuse] = useState(false);
  
  // Location and live data states
  const [userLocation, setUserLocation] = useState<{
    lat: number, 
    lon: number, 
    city?: string,
    state?: string,
    country?: string,
    address?: string,
    neighborhood?: string
  } | null>(null);
  const [locationPermission, setLocationPermission] = useState<'denied' | 'granted' | 'pending'>('pending');
  const [liveWeatherData, setLiveWeatherData] = useState<any>(null);
  const [liveTrafficData, setLiveTrafficData] = useState<any>(null);
  const [isLoadingLocation, setIsLoadingLocation] = useState(false);
  const [useRealData, setUseRealData] = useState(false);
  
  // Analytics and tracking states
  const [usageStats, setUsageStats] = useState<{
    situationCounts: {[key: string]: number};
    toneCounts: {[key: string]: number};
    combinationCounts: {[key: string]: number};
    totalGenerations: number;
  }>({
    situationCounts: {},
    toneCounts: {},
    combinationCounts: {},
    totalGenerations: 0
  });
  
  const [excuseAnalytics, setExcuseAnalytics] = useState<{
    [excuse: string]: {
      timesGenerated: number;
      timesRated: number;
      positiveRatings: number;
      negativeRatings: number;
      averageRating: number;
      effectiveness: number;
      lastUsed: Date;
      situation: string;
      tone: string;
    }
  }>({});
  
  const [abTestGroups, setAbTestGroups] = useState<{
    [testId: string]: {
      variantA: string[];
      variantB: string[];
      userGroup: 'A' | 'B';
      results: {
        A: { generations: number; ratings: number; positiveRatings: number };
        B: { generations: number; ratings: number; positiveRatings: number };
      };
    }
  }>({});
  
  const [showAnalytics, setShowAnalytics] = useState(false);
  
  // Language selection states
  const [selectedLanguage, setSelectedLanguage] = useState<'en' | 'es' | 'fr' | 'de' | 'it' | 'pt' | 'ru' | 'ja'>('en');
  const [showLanguageSelect, setShowLanguageSelect] = useState(false);
  
  // Beta feedback form state
  const [showBetaFeedback, setShowBetaFeedback] = useState(false);
  
  // Ad system states
  const [showAd, setShowAd] = useState(false);
  const [adType, setAdType] = useState<'banner' | 'interstitial'>('banner');
  const [adDismissed, setAdDismissed] = useState(false);
  const [excusesSinceAd, setExcusesSinceAd] = useState(0);
  
  // Subscription management states
  const [subscriptionTier, setSubscriptionTier] = useState<'free' | 'pro' | 'premium'>('free');
  const [showSubscription, setShowSubscription] = useState(false);
  const [subscriptionData, setSubscriptionData] = useState<{
    tier: 'free' | 'pro' | 'premium';
    startDate: Date;
    expiryDate?: Date;
    features: {
      dailyExcuseLimit: number;
      customExcusesLimit: number;
      templatesLimit: number;
      proofGeneration: boolean;
      analytics: boolean;
      prioritySupport: boolean;
      exportFeatures: boolean;
      advancedSettings: boolean;
    };
    usage: {
      excusesToday: number;
      customExcusesCreated: number;
      templatesUsed: number;
      lastReset: Date;
    };
  }>({
    tier: 'free',
    startDate: new Date(),
    features: {
      dailyExcuseLimit: 10,
      customExcusesLimit: 5,
      templatesLimit: 2,
      proofGeneration: false,
      analytics: false,
      prioritySupport: false,
      exportFeatures: false,
      advancedSettings: false,
    },
    usage: {
      excusesToday: 0,
      customExcusesCreated: 0,
      templatesUsed: 0,
      lastReset: new Date(),
    }
  });

  const subscriptionTiers = {
    free: {
      name: "Free",
      price: "$0",
      priceMonthly: 0,
      features: {
        dailyExcuseLimit: 10,
        customExcusesLimit: 5,
        templatesLimit: 2,
        proofGeneration: false,
        analytics: false,
        prioritySupport: false,
        exportFeatures: false,
        advancedSettings: false,
      },
      featureList: [
        "10 excuses per day",
        "5 custom excuses",
        "2 excuse templates",
        "Basic situations & tones",
        "Community support",
        "‚ö†Ô∏è Contains ads"
      ]
    },
    pro: {
      name: "Pro",
      price: "$4.99",
      priceMonthly: 4.99,
      features: {
        dailyExcuseLimit: 50,
        customExcusesLimit: 25,
        templatesLimit: 10,
        proofGeneration: true,
        analytics: true,
        prioritySupport: false,
        exportFeatures: true,
        advancedSettings: true,
      },
      featureList: [
        "50 excuses per day",
        "25 custom excuses",
        "10 excuse templates",
        "Professional proof generator",
        "Usage analytics & insights",
        "Export favorites",
        "Advanced customization",
        "Email support",
        "‚úÖ Ad-free experience"
      ]
    },
    premium: {
      name: "Premium",
      price: "$9.99",
      priceMonthly: 9.99,
      features: {
        dailyExcuseLimit: -1, // Unlimited
        customExcusesLimit: -1, // Unlimited
        templatesLimit: -1, // Unlimited
        proofGeneration: true,
        analytics: true,
        prioritySupport: true,
        exportFeatures: true,
        advancedSettings: true,
      },
      featureList: [
        "Unlimited excuses",
        "Unlimited custom excuses",
        "Unlimited templates",
        "Professional proof generator",
        "Advanced analytics & A/B testing",
        "Priority customer support",
        "Export in multiple formats",
        "Early access to new features",
        "AI-powered excuse optimization",
        "‚úÖ Ad-free experience"
      ]
    }
  };

  const availableLanguages = {
    en: { name: "English", flag: "üá∫üá∏", nativeName: "English" },
    es: { name: "Spanish", flag: "üá™üá∏", nativeName: "Espa√±ol" },
    fr: { name: "French", flag: "üá´üá∑", nativeName: "Fran√ßais" },
    de: { name: "German", flag: "üá©üá™", nativeName: "Deutsch" },
    it: { name: "Italian", flag: "üáÆüáπ", nativeName: "Italiano" },
    pt: { name: "Portuguese", flag: "üáµüáπ", nativeName: "Portugu√™s" },
    ru: { name: "Russian", flag: "üá∑üá∫", nativeName: "–†—É—Å—Å–∫–∏–π" },
    ja: { name: "Japanese", flag: "üáØüáµ", nativeName: "Êó•Êú¨Ë™û" }
  };

  // Translations for the entire app interface
  const translations = {
    en: {
      // App title
      appTitle: "Excuses, Excuses!",
      appSubtitle: "The Professional Excuse Generator",
      
      // Main interface
      situation: "Situation",
      situationPlaceholder: "Choose a situation",
      tone: "Tone",
      tonePlaceholder: "Choose a tone",
      language: "Language",
      languagePlaceholder: "Choose language",
      
      // Situations
      situations: {
        work: "üíº Work",
        school: "üéì School", 
        date: "üíï Date",
        family: "üë®‚Äçüë©‚Äçüëß‚Äçüë¶ Family",
        social: "üéâ Social",
        exercise: "üí™ Exercise",
        weather: "üå¶Ô∏è Weather",
        traffic: "üöó Traffic", 
        medical: "üè• Medical",
        emergency: "üö® Emergency (Premium)",
        travel: "‚úàÔ∏è Travel (Premium)"
      },
      
      // Tones
      tones: {
        funny: "üòÇ Funny",
        professional: "üíº Professional",
        believable: "‚úÖ Believable", 
        dramatic: "üé≠ Dramatic"
      },
      
      // Buttons
      generateExcuse: "Generate Excuse",
      generating: "Generating...",
      copyToClipboard: "Copy to Clipboard",
      saveFavorite: "Save Favorite",
      share: "Share",
      
      // Rating
      good: "Good",
      bad: "Bad", 
      thanks: "Thanks!",
      noted: "Noted!",
      rateThis: "Rate this excuse:",
      
      // Proof generators
      weather: "Weather",
      traffic: "Traffic", 
      medical: "Medical",
      
      // Loading messages
      generatingExcuse: "Generating your excuse...",
      craftingStory: "Crafting the perfect story",
      
      // Feature buttons
      custom: "Custom",
      templates: "Templates", 
      analytics: "Analytics",
      export: "Export",
      settings: "Settings",
      
      // Subscription
      subscriptionTitle: "Choose Your Plan",
      freePlan: "Free",
      proPlan: "Pro",
      premiumPlan: "Premium",
      currentPlan: "Current Plan",
      upgradePlan: "Upgrade Plan",
      
      // Daily widget
      dailyExcuseTitle: "Daily Excuse",
      copy: "Copy",
      copied: "Copied!",
      copyProof: "Copy Proof",
      
      // Main instructions  
      pickInstructions: "Pick a situation and tone, then let the magic happen!",
      
      // Stats
      successRate: "success rate",
      
      // Accessibility
      generateAriaLabel: "Generate a new excuse",
      generateAriaDescription: "Click to generate a new excuse based on your selected situation and tone",
      copyAriaLabel: "Copy excuse to clipboard",
      favoriteAriaLabel: "Save this excuse to favorites",
      
      // Proof generation
      issued: "Issued",
      area: "County and surrounding areas",
      location: "Location",
      reported: "REPORTED",
      clearance: "EST. CLEARANCE",
      delay: "Average delay",
      minutes: "minutes",
      medicalServices: "COMPREHENSIVE MEDICAL SERVICES",
      patientInfo: "PATIENT INFORMATION",
      patient: "Patient",
      serviceDate: "Date of Service",
      time: "Time",
      physician: "ATTENDING PHYSICIAN",
      license: "Medical License",
      returnDate: "Patient may return to normal activities on",
      date: "Date",
      day: "day",
      days: "days",
      // Additional proof labels
      office: "Office",
      alertId: "Alert ID",
      incidentId: "Incident ID", 
      documentId: "Document #",
      north: "North",
      south: "South",
      exit: "Exit",
      affectedArea: "AFFECTED AREA",
      
      // Onboarding
      welcomeTitle: "üéâ Welcome to Excuses, Excuses!",
      welcomeDescription: "The ultimate excuse generator for any situation! Choose your language above, then pick your preferred excuse style to get started.",
      chooseLanguageLabel: "üåç Choose Your Language",
      chooseStyleTitle: "Choose Your Style",
      funnyStyle: "üòÇ Funny & Hilarious",
      professionalStyle: "üíº Professional & Polished",
      believableStyle: "‚úÖ Believable & Realistic", 
      dramaticStyle: "üé≠ Dramatic & Over-the-Top"
    },
    es: {
      // App title
      appTitle: "¬°Excusas, Excusas!",
      appSubtitle: "El Generador Profesional de Excusas",
      
      // Main interface
      situation: "Situaci√≥n",
      situationPlaceholder: "Elige una situaci√≥n",
      tone: "Tono", 
      tonePlaceholder: "Elige un tono",
      language: "Idioma",
      languagePlaceholder: "Elige idioma",
      
      // Situations
      situations: {
        work: "üíº Trabajo",
        school: "üéì Escuela",
        date: "üíï Cita",
        family: "üë®‚Äçüë©‚Äçüëß‚Äçüë¶ Familia", 
        social: "üéâ Social",
        exercise: "üí™ Ejercicio",
        weather: "üå¶Ô∏è Clima",
        traffic: "üöó Tr√°fico", 
        medical: "üè• M√©dico",
        emergency: "üö® Emergencia (Premium)",
        travel: "‚úàÔ∏è Viaje (Premium)"
      },
      
      // Tones
      tones: {
        funny: "üòÇ Divertido",
        professional: "üíº Profesional",
        believable: "‚úÖ Cre√≠ble",
        dramatic: "üé≠ Dram√°tico"
      },
      
      // Buttons
      generateExcuse: "Generar Excusa",
      generating: "Generando...",
      copyToClipboard: "Copiar al Portapapeles", 
      copied: "¬°Copiado!",
      saveFavorite: "Guardar Favorito",
      share: "Compartir",
      
      // Rating
      good: "Bueno",
      bad: "Malo", 
      thanks: "¬°Gracias!",
      noted: "¬°Notado!",
      rateThis: "Califica esta excusa:",
      
      // Proof generators
      weather: "Clima",
      traffic: "Tr√°fico", 
      medical: "M√©dico",
      
      // Loading messages
      generatingExcuse: "Generando tu excusa...",
      craftingStory: "Creando la historia perfecta",
      
      // Feature buttons
      custom: "Personalizar",
      templates: "Plantillas",
      analytics: "An√°lisis", 
      export: "Exportar",
      settings: "Configuraci√≥n",
      
      // Subscription
      subscriptionTitle: "Elige Tu Plan",
      freePlan: "Gratis",
      proPlan: "Pro", 
      premiumPlan: "Premium",
      currentPlan: "Plan Actual",
      upgradePlan: "Actualizar Plan",
      
      // Daily widget
      dailyExcuseTitle: "Excusa Diaria",
      copyProof: "Copiar Prueba",
      copy: "Copiar",
      
      // Main instructions
      pickInstructions: "Elige una situaci√≥n y un tono, ¬°y deja que ocurra la magia!",
      
      // Stats  
      successRate: "tasa de √©xito",
      
      // Accessibility
      generateAriaLabel: "Generar nueva excusa",
      generateAriaDescription: "Haz clic para generar una nueva excusa basada en tu situaci√≥n y tono seleccionados",
      copyAriaLabel: "Copiar excusa al portapapeles",
      favoriteAriaLabel: "Guardar esta excusa en favoritos",
      // Additional proof labels  
      office: "Oficina",
      alertId: "ID de Alerta",
      incidentId: "ID de Incidente",
      documentId: "Documento #",
      north: "Norte", 
      south: "Sur",
      exit: "Salida",
      affectedArea: "√ÅREA AFECTADA",
      
      // Onboarding
      welcomeTitle: "üéâ ¬°Bienvenido a Excusas, Excusas!",
      welcomeDescription: "¬°El mejor generador de excusas para cualquier situaci√≥n! Elige tu idioma arriba, luego selecciona tu estilo de excusa preferido para comenzar.",
      chooseLanguageLabel: "üåç Elige Tu Idioma",
      chooseStyleTitle: "Elige Tu Estilo",
      funnyStyle: "üòÇ Divertido e Hilarante",
      professionalStyle: "üíº Profesional y Pulido",
      believableStyle: "‚úÖ Cre√≠ble y Realista", 
      dramaticStyle: "üé≠ Dram√°tico y Exagerado"
    },
    fr: {
      // App title
      appTitle: "Excuses, Excuses!",
      appSubtitle: "Le G√©n√©rateur Professionnel d'Excuses",
      
      // Main interface
      situation: "Situation",
      situationPlaceholder: "Choisir une situation",
      tone: "Ton",
      tonePlaceholder: "Choisir un ton", 
      language: "Langue",
      languagePlaceholder: "Choisir la langue",
      
      // Situations
      situations: {
        work: "üíº Travail",
        school: "üéì √âcole",
        date: "üíï Rendez-vous",
        family: "üë®‚Äçüë©‚Äçüëß‚Äçüë¶ Famille",
        social: "üéâ Social", 
        exercise: "üí™ Exercice",
        weather: "üå¶Ô∏è M√©t√©o",
        traffic: "üöó Trafic", 
        medical: "üè• M√©dical",
        emergency: "üö® Urgence (Premium)",
        travel: "‚úàÔ∏è Voyage (Premium)"
      },
      
      // Tones
      tones: {
        funny: "üòÇ Amusant",
        professional: "üíº Professionnel",
        believable: "‚úÖ Cr√©dible",
        dramatic: "üé≠ Dramatique"
      },
      
      // Buttons
      generateExcuse: "G√©n√©rer Excuse",
      generating: "G√©n√©ration...",
      copyToClipboard: "Copier dans le Presse-papiers",
      copied: "Copi√©!",
      saveFavorite: "Sauvegarder Favori",
      share: "Partager",
      
      // Rating
      good: "Bien",
      bad: "Mal", 
      thanks: "Merci!",
      noted: "Not√©!",
      rateThis: "√âvaluez cette excuse:",
      
      // Proof generators
      weather: "M√©t√©o",
      traffic: "Trafic", 
      medical: "M√©dical",
      
      // Loading messages
      generatingExcuse: "G√©n√©ration de votre excuse...",
      craftingStory: "Cr√©ation de l'histoire parfaite",
      
      // Feature buttons
      custom: "Personnaliser",
      templates: "Mod√®les",
      analytics: "Analyse",
      export: "Exporter", 
      settings: "Param√®tres",
      
      // Subscription
      subscriptionTitle: "Choisissez Votre Plan",
      freePlan: "Gratuit",
      proPlan: "Pro",
      premiumPlan: "Premium",
      currentPlan: "Plan Actuel",
      upgradePlan: "Mettre √† Niveau",
      
      // Daily widget
      dailyExcuseTitle: "Excuse Quotidienne",
      copyProof: "Copier Preuve",
      copy: "Copier",
      
      // Main instructions
      pickInstructions: "Choisissez une situation et un ton, puis laissez la magie op√©rer!",
      
      // Stats
      successRate: "taux de r√©ussite",
      
      // Accessibility
      generateAriaLabel: "G√©n√©rer nouvelle excuse",
      generateAriaDescription: "Cliquez pour g√©n√©rer une nouvelle excuse bas√©e sur votre situation et ton s√©lectionn√©s",
      copyAriaLabel: "Copier excuse dans le presse-papiers",
      favoriteAriaLabel: "Sauvegarder cette excuse dans les favoris",
      // Additional proof labels
      office: "Bureau",
      alertId: "ID d'Alerte",
      incidentId: "ID d'Incident", 
      documentId: "Document #",
      north: "Nord",
      south: "Sud", 
      exit: "Sortie",
      affectedArea: "ZONE AFFECT√âE",
      
      // Onboarding
      welcomeTitle: "üéâ Bienvenue dans Excuses, Excuses!",
      welcomeDescription: "Le g√©n√©rateur d'excuses ultime pour toute situation! Choisissez votre langue ci-dessus, puis s√©lectionnez votre style d'excuse pr√©f√©r√© pour commencer.",
      chooseLanguageLabel: "üåç Choisissez Votre Langue",
      chooseStyleTitle: "Choisissez Votre Style",
      funnyStyle: "üòÇ Amusant et Hilarant",
      professionalStyle: "üíº Professionnel et Poli",
      believableStyle: "‚úÖ Cr√©dible et R√©aliste", 
      dramaticStyle: "üé≠ Dramatique et Exag√©r√©"
    },
    de: {
      // App title
      appTitle: "Ausreden, Ausreden!",
      appSubtitle: "Der Professionelle Ausreden-Generator",
      
      // Main interface
      situation: "Situation",
      situationPlaceholder: "Situation w√§hlen",
      tone: "Ton",
      tonePlaceholder: "Ton w√§hlen",
      language: "Sprache", 
      languagePlaceholder: "Sprache w√§hlen",
      
      // Situations
      situations: {
        work: "üíº Arbeit",
        school: "üéì Schule",
        date: "üíï Date",
        family: "üë®‚Äçüë©‚Äçüëß‚Äçüë¶ Familie",
        social: "üéâ Sozial",
        exercise: "üí™ Sport",
        weather: "üå¶Ô∏è Wetter",
        traffic: "üöó Verkehr",
        medical: "üè• Medizinisch",
        emergency: "üö® Notfall (Premium)",
        travel: "‚úàÔ∏è Reise (Premium)"
      },
      
      // Tones
      tones: {
        funny: "üòÇ Lustig",
        professional: "üíº Professionell", 
        believable: "‚úÖ Glaubw√ºrdig",
        dramatic: "üé≠ Dramatisch"
      },
      
      // Buttons
      generateExcuse: "Ausrede Generieren",
      generating: "Generiere...",
      copyToClipboard: "In Zwischenablage Kopieren",
      copied: "Kopiert!",
      saveFavorite: "Favorit Speichern",
      share: "Teilen",
      
      // Rating
      good: "Gut",
      bad: "Schlecht", 
      thanks: "Danke!",
      noted: "Notiert!",
      rateThis: "Bewerte diese Ausrede:",
      
      // Proof generators
      weather: "Wetter",
      traffic: "Verkehr", 
      medical: "Medizinisch",
      
      // Loading messages
      generatingExcuse: "Generiere deine Ausrede...",
      craftingStory: "Die perfekte Geschichte erschaffen",
      
      // Feature buttons
      custom: "Anpassen",
      templates: "Vorlagen",
      analytics: "Analyse",
      export: "Exportieren",
      settings: "Einstellungen",
      
      // Subscription
      subscriptionTitle: "Plan W√§hlen",
      freePlan: "Kostenlos",
      proPlan: "Pro",
      premiumPlan: "Premium", 
      currentPlan: "Aktueller Plan",
      upgradePlan: "Plan Upgraden",
      
      // Daily widget
      dailyExcuseTitle: "T√§gliche Ausrede",
      copyProof: "Beweis Kopieren",
      copy: "Kopieren",
      
      // Main instructions
      pickInstructions: "W√§hlen Sie eine Situation und einen Ton, dann lassen Sie die Magie geschehen!",
      
      // Stats
      successRate: "Erfolgsrate",
      
      // Accessibility
      generateAriaLabel: "Neue Ausrede generieren",
      generateAriaDescription: "Klicken Sie, um eine neue Ausrede basierend auf Ihrer ausgew√§hlten Situation und Ihrem Ton zu generieren",
      copyAriaLabel: "Ausrede in Zwischenablage kopieren",
      favoriteAriaLabel: "Diese Ausrede zu Favoriten hinzuf√ºgen",
      // Additional proof labels
      office: "B√ºro", 
      alertId: "Alarm-ID",
      incidentId: "Vorfall-ID",
      documentId: "Dokument #",
      north: "Nord",
      south: "S√ºd",
      exit: "Ausfahrt", 
      affectedArea: "BETROFFENES GEBIET",
      
      // Onboarding
      welcomeTitle: "üéâ Willkommen bei Excuses, Excuses!",
      welcomeDescription: "Der ultimative Ausredengenerator f√ºr jede Situation! W√§hlen Sie oben Ihre Sprache und dann Ihren bevorzugten Ausredenstil, um zu beginnen.",
      chooseLanguageLabel: "üåç W√§hlen Sie Ihre Sprache",
      chooseStyleTitle: "W√§hlen Sie Ihren Stil",
      funnyStyle: "üòÇ Lustig und Urkomisch",
      professionalStyle: "üíº Professionell und Gepflegt",
      believableStyle: "‚úÖ Glaubw√ºrdig und Realistisch", 
      dramaticStyle: "üé≠ Dramatisch und √úbertrieben"
    },
    it: {
      // App title
      appTitle: "Scuse, Scuse!",
      appSubtitle: "Il Generatore Professionale di Scuse",
      
      // Main interface
      situation: "Situazione",
      situationPlaceholder: "Scegli una situazione",
      tone: "Tono",
      tonePlaceholder: "Scegli un tono",
      language: "Lingua",
      languagePlaceholder: "Scegli lingua",
      
      // Situations
      situations: {
        work: "üíº Lavoro",
        school: "üéì Scuola",
        date: "üíï Appuntamento",
        family: "üë®‚Äçüë©‚Äçüëß‚Äçüë¶ Famiglia",
        social: "üéâ Sociale",
        exercise: "üí™ Esercizio",
        weather: "üå¶Ô∏è Meteo",
        traffic: "üöó Traffico",
        medical: "üè• Medico",
        emergency: "üö® Emergenza (Premium)",
        travel: "‚úàÔ∏è Viaggio (Premium)"
      },
      
      // Tones
      tones: {
        funny: "üòÇ Divertente",
        professional: "üíº Professionale",
        believable: "‚úÖ Credibile",
        dramatic: "üé≠ Drammatico"
      },
      
      // Buttons
      generateExcuse: "Genera Scusa",
      generating: "Generando...",
      copyToClipboard: "Copia negli Appunti",
      copied: "Copiato!",
      saveFavorite: "Salva Preferito",
      share: "Condividi",
      
      // Rating
      good: "Bene",
      bad: "Male", 
      thanks: "Grazie!",
      noted: "Notato!",
      rateThis: "Valuta questa scusa:",
      
      // Proof generators
      weather: "Meteo",
      traffic: "Traffico", 
      medical: "Medico",
      
      // Loading messages
      generatingExcuse: "Generando la tua scusa...",
      craftingStory: "Creando la storia perfetta",
      
      // Feature buttons
      custom: "Personalizzato",
      templates: "Modelli",
      analytics: "Analisi",
      export: "Esporta",
      settings: "Impostazioni",
      
      // Subscription
      subscriptionTitle: "Scegli Il Tuo Piano",
      freePlan: "Gratuito",
      proPlan: "Pro",
      premiumPlan: "Premium",
      currentPlan: "Piano Attuale",
      upgradePlan: "Aggiorna Piano",
      
      // Daily widget
      dailyExcuseTitle: "Scusa Giornaliera",
      copyProof: "Copia Prova",
      copy: "Copia",
      
      // Main instructions
      pickInstructions: "Scegli una situazione e un tono, poi lascia che accada la magia!",
      
      // Stats
      successRate: "tasso di successo",
      
      // Accessibility
      generateAriaLabel: "Genera nuova scusa",
      generateAriaDescription: "Clicca per generare una nuova scusa basata sulla situazione e il tono selezionati",
      copyAriaLabel: "Copia scusa negli appunti", 
      favoriteAriaLabel: "Salva questa scusa nei preferiti",
      // Additional proof labels
      office: "Ufficio",
      alertId: "ID Allerta", 
      incidentId: "ID Incidente",
      documentId: "Documento #",
      north: "Nord",
      south: "Sud",
      exit: "Uscita",
      affectedArea: "AREA INTERESSATA",
      
      // Onboarding
      welcomeTitle: "üéâ Benvenuto in Excuses, Excuses!",
      welcomeDescription: "Il generatore di scuse definitivo per ogni situazione! Scegli la tua lingua sopra, poi seleziona il tuo stile di scusa preferito per iniziare.",
      chooseLanguageLabel: "üåç Scegli La Tua Lingua",
      chooseStyleTitle: "Scegli Il Tuo Stile",
      funnyStyle: "üòÇ Divertente e Esilarante",
      professionalStyle: "üíº Professionale e Raffinato",
      believableStyle: "‚úÖ Credibile e Realistico", 
      dramaticStyle: "üé≠ Drammatico e Esagerato"
    },
    pt: {
      // App title
      appTitle: "Desculpas, Desculpas!",
      appSubtitle: "O Gerador Profissional de Desculpas",
      
      // Main interface
      situation: "Situa√ß√£o",
      situationPlaceholder: "Escolher situa√ß√£o",
      tone: "Tom",
      tonePlaceholder: "Escolher tom",
      language: "Idioma",
      languagePlaceholder: "Escolher idioma",
      
      // Situations
      situations: {
        work: "üíº Trabalho",
        school: "üéì Escola",
        date: "üíï Encontro",
        family: "üë®‚Äçüë©‚Äçüëß‚Äçüë¶ Fam√≠lia",
        social: "üéâ Social",
        exercise: "üí™ Exerc√≠cio",
        weather: "üå¶Ô∏è Clima",
        traffic: "üöó Tr√¢nsito",
        medical: "üè• M√©dico",
        emergency: "üö® Emerg√™ncia (Premium)",
        travel: "‚úàÔ∏è Viagem (Premium)"
      },
      
      // Tones
      tones: {
        funny: "üòÇ Engra√ßado",
        professional: "üíº Profissional",
        believable: "‚úÖ Acredit√°vel",
        dramatic: "üé≠ Dram√°tico"
      },
      
      // Buttons
      generateExcuse: "Gerar Desculpa",
      generating: "Gerando...",
      copyToClipboard: "Copiar para √Årea de Transfer√™ncia",
      copied: "Copiado!",
      saveFavorite: "Salvar Favorito",
      share: "Compartilhar",
      
      // Rating
      good: "Bom",
      bad: "Ruim", 
      thanks: "Obrigado!",
      noted: "Anotado!",
      rateThis: "Avalie esta desculpa:",
      
      // Proof generators
      weather: "Clima",
      traffic: "Tr√¢nsito", 
      medical: "M√©dico",
      
      // Loading messages
      generatingExcuse: "Gerando sua desculpa...",
      craftingStory: "Criando a hist√≥ria perfeita",
      
      // Feature buttons
      custom: "Personalizado",
      templates: "Modelos",
      analytics: "An√°lise",
      export: "Exportar",
      settings: "Configura√ß√µes",
      
      // Subscription
      subscriptionTitle: "Escolha Seu Plano",
      freePlan: "Gratuito",
      proPlan: "Pro",
      premiumPlan: "Premium",
      currentPlan: "Plano Atual",
      upgradePlan: "Atualizar Plano",
      
      // Daily widget
      dailyExcuseTitle: "Desculpa Di√°ria",
      copyProof: "Copiar Prova",
      copy: "Copiar",
      
      // Main instructions
      pickInstructions: "Escolha uma situa√ß√£o e um tom, ent√£o deixe a magia acontecer!",
      
      // Stats
      successRate: "taxa de sucesso",
      
      // Accessibility
      generateAriaLabel: "Gerar nova desculpa",
      generateAriaDescription: "Clique para gerar uma nova desculpa baseada na situa√ß√£o e tom selecionados",
      copyAriaLabel: "Copiar desculpa para √°rea de transfer√™ncia",
      favoriteAriaLabel: "Salvar esta desculpa nos favoritos",
      // Additional proof labels
      office: "Escrit√≥rio",
      alertId: "ID do Alerta",
      incidentId: "ID do Incidente", 
      documentId: "Documento #",
      north: "Norte",
      south: "Sul",
      exit: "Sa√≠da", 
      affectedArea: "√ÅREA AFETADA",
      
      // Onboarding
      welcomeTitle: "üéâ Bem-vindo ao Excuses, Excuses!",
      welcomeDescription: "O melhor gerador de desculpas para qualquer situa√ß√£o! Escolha seu idioma acima, depois selecione seu estilo de desculpa preferido para come√ßar.",
      chooseLanguageLabel: "üåç Escolha Seu Idioma",
      chooseStyleTitle: "Escolha Seu Estilo",
      funnyStyle: "üòÇ Engra√ßado e Hil√°rio",
      professionalStyle: "üíº Profissional e Polido",
      believableStyle: "‚úÖ Acredit√°vel e Realista", 
      dramaticStyle: "üé≠ Dram√°tico e Exagerado"
    },
    ru: {
      // App title
      appTitle: "–û–ø—Ä–∞–≤–¥–∞–Ω–∏—è, –û–ø—Ä–∞–≤–¥–∞–Ω–∏—è!",
      appSubtitle: "–ü—Ä–æ—Ñ–µ—Å—Å–∏–æ–Ω–∞–ª—å–Ω—ã–π –ì–µ–Ω–µ—Ä–∞—Ç–æ—Ä –û–ø—Ä–∞–≤–¥–∞–Ω–∏–π",
      
      // Main interface
      situation: "–°–∏—Ç—É–∞—Ü–∏—è",
      situationPlaceholder: "–í—ã–±–µ—Ä–∏—Ç–µ —Å–∏—Ç—É–∞—Ü–∏—é",
      tone: "–¢–æ–Ω",
      tonePlaceholder: "–í—ã–±–µ—Ä–∏—Ç–µ —Ç–æ–Ω",
      language: "–Ø–∑—ã–∫",
      languagePlaceholder: "–í—ã–±–µ—Ä–∏—Ç–µ —è–∑—ã–∫",
      
      // Situations
      situations: {
        work: "üíº –†–∞–±–æ—Ç–∞",
        school: "üéì –®–∫–æ–ª–∞",
        date: "üíï –°–≤–∏–¥–∞–Ω–∏–µ",
        family: "üë®‚Äçüë©‚Äçüëß‚Äçüë¶ –°–µ–º—å—è",
        social: "üéâ –û–±—â–µ—Å—Ç–≤–µ–Ω–Ω–æ–µ",
        exercise: "üí™ –°–ø–æ—Ä—Ç",
        weather: "üå¶Ô∏è –ü–æ–≥–æ–¥–∞",
        traffic: "üöó –¢—Ä–∞—Ñ–∏–∫",
        medical: "üè• –ú–µ–¥–∏—Ü–∏–Ω—Å–∫–∏–π",
        emergency: "üö® –≠–∫—Å—Ç—Ä–µ–Ω–Ω–∞—è (Premium)",
        travel: "‚úàÔ∏è –ü—É—Ç–µ—à–µ—Å—Ç–≤–∏–µ (Premium)"
      },
      
      // Tones
      tones: {
        funny: "üòÇ –°–º–µ—à–Ω–æ–π",
        professional: "üíº –ü—Ä–æ—Ñ–µ—Å—Å–∏–æ–Ω–∞–ª—å–Ω—ã–π",
        believable: "‚úÖ –ü—Ä–∞–≤–¥–æ–ø–æ–¥–æ–±–Ω—ã–π",
        dramatic: "üé≠ –î—Ä–∞–º–∞—Ç–∏—á–Ω—ã–π"
      },
      
      // Buttons
      generateExcuse: "–°–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞—Ç—å –û–ø—Ä–∞–≤–¥–∞–Ω–∏–µ",
      generating: "–ì–µ–Ω–µ—Ä–∞—Ü–∏—è...",
      copyToClipboard: "–ö–æ–ø–∏—Ä–æ–≤–∞—Ç—å –≤ –ë—É—Ñ–µ—Ä",
      copied: "–°–∫–æ–ø–∏—Ä–æ–≤–∞–Ω–æ!",
      saveFavorite: "–°–æ—Ö—Ä–∞–Ω–∏—Ç—å –≤ –ò–∑–±—Ä–∞–Ω–Ω–æ–µ",
      share: "–ü–æ–¥–µ–ª–∏—Ç—å—Å—è",
      
      // Rating
      good: "–•–æ—Ä–æ—à–æ",
      bad: "–ü–ª–æ—Ö–æ", 
      thanks: "–°–ø–∞—Å–∏–±–æ!",
      noted: "–û—Ç–º–µ—á–µ–Ω–æ!",
      rateThis: "–û—Ü–µ–Ω–∏—Ç–µ —ç—Ç–æ –æ–ø—Ä–∞–≤–¥–∞–Ω–∏–µ:",
      
      // Proof generators
      weather: "–ü–æ–≥–æ–¥–∞",
      traffic: "–¢—Ä–∞—Ñ–∏–∫", 
      medical: "–ú–µ–¥–∏—Ü–∏–Ω—Å–∫–∏–π",
      
      // Loading messages
      generatingExcuse: "–ì–µ–Ω–µ—Ä–∞—Ü–∏—è –≤–∞—à–µ–≥–æ –æ–ø—Ä–∞–≤–¥–∞–Ω–∏—è...",
      craftingStory: "–°–æ–∑–¥–∞–Ω–∏–µ –∏–¥–µ–∞–ª—å–Ω–æ–π –∏—Å—Ç–æ—Ä–∏–∏",
      
      // Feature buttons
      custom: "–ù–∞—Å—Ç—Ä–æ–∏—Ç—å",
      templates: "–®–∞–±–ª–æ–Ω—ã",
      analytics: "–ê–Ω–∞–ª–∏—Ç–∏–∫–∞",
      export: "–≠–∫—Å–ø–æ—Ä—Ç",
      settings: "–ù–∞—Å—Ç—Ä–æ–π–∫–∏",
      
      // Subscription
      subscriptionTitle: "–í—ã–±–µ—Ä–∏—Ç–µ –ü–ª–∞–Ω",
      freePlan: "–ë–µ—Å–ø–ª–∞—Ç–Ω—ã–π",
      proPlan: "–ü—Ä–æ",
      premiumPlan: "–ü—Ä–µ–º–∏—É–º",
      currentPlan: "–¢–µ–∫—É—â–∏–π –ü–ª–∞–Ω",
      upgradePlan: "–û–±–Ω–æ–≤–∏—Ç—å –ü–ª–∞–Ω",
      
      // Daily widget
      dailyExcuseTitle: "–û–ø—Ä–∞–≤–¥–∞–Ω–∏–µ –î–Ω—è",
      copyProof: "–ö–æ–ø–∏—Ä–æ–≤–∞—Ç—å –î–æ–∫–∞–∑–∞—Ç–µ–ª—å—Å—Ç–≤–æ",
      copy: "–ö–æ–ø–∏—Ä–æ–≤–∞—Ç—å",
      
      // Main instructions
      pickInstructions: "–í—ã–±–µ—Ä–∏—Ç–µ —Å–∏—Ç—É–∞—Ü–∏—é –∏ —Ç–æ–Ω, –∑–∞—Ç–µ–º –ø–æ–∑–≤–æ–ª—å—Ç–µ –º–∞–≥–∏–∏ –ø—Ä–æ–∏–∑–æ–π—Ç–∏!",
      
      // Stats
      successRate: "–ø—Ä–æ—Ü–µ–Ω—Ç —É—Å–ø–µ—Ö–∞",
      
      // Accessibility
      generateAriaLabel: "–°–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞—Ç—å –Ω–æ–≤–æ–µ –æ–ø—Ä–∞–≤–¥–∞–Ω–∏–µ",
      generateAriaDescription: "–ù–∞–∂–º–∏—Ç–µ, —á—Ç–æ–±—ã —Å–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞—Ç—å –Ω–æ–≤–æ–µ –æ–ø—Ä–∞–≤–¥–∞–Ω–∏–µ –Ω–∞ –æ—Å–Ω–æ–≤–µ –≤—ã–±—Ä–∞–Ω–Ω–æ–π —Å–∏—Ç—É–∞—Ü–∏–∏ –∏ —Ç–æ–Ω–∞",
      copyAriaLabel: "–ö–æ–ø–∏—Ä–æ–≤–∞—Ç—å –æ–ø—Ä–∞–≤–¥–∞–Ω–∏–µ –≤ –±—É—Ñ–µ—Ä –æ–±–º–µ–Ω–∞",
      favoriteAriaLabel: "–°–æ—Ö—Ä–∞–Ω–∏—Ç—å —ç—Ç–æ –æ–ø—Ä–∞–≤–¥–∞–Ω–∏–µ –≤ –∏–∑–±—Ä–∞–Ω–Ω–æ–º",
      // Additional proof labels  
      office: "–û—Ñ–∏—Å",
      alertId: "ID –û–ø–æ–≤–µ—â–µ–Ω–∏—è",
      incidentId: "ID –ò–Ω—Ü–∏–¥–µ–Ω—Ç–∞",
      documentId: "–î–æ–∫—É–º–µ–Ω—Ç #", 
      north: "–°–µ–≤–µ—Ä",
      south: "–Æ–≥",
      exit: "–í—ã–µ–∑–¥",
      affectedArea: "–ü–û–°–¢–†–ê–î–ê–í–®–ê–Ø –û–ë–õ–ê–°–¢–¨",
      
      // Onboarding
      welcomeTitle: "üéâ –î–æ–±—Ä–æ –ø–æ–∂–∞–ª–æ–≤–∞—Ç—å –≤ Excuses, Excuses!",
      welcomeDescription: "–ò–¥–µ–∞–ª—å–Ω—ã–π –≥–µ–Ω–µ—Ä–∞—Ç–æ—Ä –æ–ø—Ä–∞–≤–¥–∞–Ω–∏–π –¥–ª—è –ª—é–±–æ–π —Å–∏—Ç—É–∞—Ü–∏–∏! –í—ã–±–µ—Ä–∏—Ç–µ —Å–≤–æ–π —è–∑—ã–∫ –≤—ã—à–µ, –∑–∞—Ç–µ–º –≤—ã–±–µ—Ä–∏—Ç–µ –ø—Ä–µ–¥–ø–æ—á—Ç–∏—Ç–µ–ª—å–Ω—ã–π —Å—Ç–∏–ª—å –æ–ø—Ä–∞–≤–¥–∞–Ω–∏–π, —á—Ç–æ–±—ã –Ω–∞—á–∞—Ç—å.",
      chooseLanguageLabel: "üåç –í—ã–±–µ—Ä–∏—Ç–µ –í–∞—à –Ø–∑—ã–∫",
      chooseStyleTitle: "–í—ã–±–µ—Ä–∏—Ç–µ –í–∞—à –°—Ç–∏–ª—å",
      funnyStyle: "üòÇ –°–º–µ—à–Ω–æ –∏ –í–µ—Å–µ–ª–æ",
      professionalStyle: "üíº –ü—Ä–æ—Ñ–µ—Å—Å–∏–æ–Ω–∞–ª—å–Ω–æ –∏ –ò–∑—è—â–Ω–æ",
      believableStyle: "‚úÖ –ü—Ä–∞–≤–¥–æ–ø–æ–¥–æ–±–Ω–æ –∏ –†–µ–∞–ª–∏—Å—Ç–∏—á–Ω–æ", 
      dramaticStyle: "üé≠ –î—Ä–∞–º–∞—Ç–∏—á–Ω–æ –∏ –ü—Ä–µ—É–≤–µ–ª–∏—á–µ–Ω–Ω–æ"
    },
    ja: {
      // App title
      appTitle: "Ë®Ä„ÅÑË®≥„ÄÅË®Ä„ÅÑË®≥ÔºÅ",
      appSubtitle: "„Éó„É≠„Éï„Çß„ÉÉ„Ç∑„Éß„Éä„É´Ë®Ä„ÅÑË®≥„Ç∏„Çß„Éç„É¨„Éº„Çø„Éº",
      
      // Main interface
      situation: "Áä∂Ê≥Å",
      situationPlaceholder: "Áä∂Ê≥Å„ÇíÈÅ∏Êäû",
      tone: "„Éà„Éº„É≥",
      tonePlaceholder: "„Éà„Éº„É≥„ÇíÈÅ∏Êäû",
      language: "Ë®ÄË™û",
      languagePlaceholder: "Ë®ÄË™û„ÇíÈÅ∏Êäû",
      
      // Situations
      situations: {
        work: "üíº ‰ªï‰∫ã",
        school: "üéì Â≠¶Ê†°",
        date: "üíï „Éá„Éº„Éà",
        family: "üë®‚Äçüë©‚Äçüëß‚Äçüë¶ ÂÆ∂Êóè",
        social: "üéâ Á§æ‰∫§",
        exercise: "üí™ ÈÅãÂãï",
        weather: "üå¶Ô∏è Â§©Ê∞ó",
        traffic: "üöó ‰∫§ÈÄö",
        medical: "üè• ÂåªÁôÇ",
        emergency: "üö® Á∑äÊÄ• („Éó„É¨„Éü„Ç¢„É†)",
        travel: "‚úàÔ∏è ÊóÖË°å („Éó„É¨„Éü„Ç¢„É†)"
      },
      
      // Tones
      tones: {
        funny: "üòÇ Èù¢ÁôΩ„ÅÑ",
        professional: "üíº „Éó„É≠„Éï„Çß„ÉÉ„Ç∑„Éß„Éä„É´",
        believable: "‚úÖ ‰ø°È†º„Åß„Åç„Çã",
        dramatic: "üé≠ „Éâ„É©„Éû„ÉÅ„ÉÉ„ÇØ"
      },
      
      // Buttons
      generateExcuse: "Ë®Ä„ÅÑË®≥„ÇíÁîüÊàê",
      generating: "ÁîüÊàê‰∏≠...",
      copyToClipboard: "„ÇØ„É™„ÉÉ„Éó„Éú„Éº„Éâ„Å´„Ç≥„Éî„Éº",
      copied: "„Ç≥„Éî„Éº„Åó„Åæ„Åó„ÅüÔºÅ",
      saveFavorite: "„ÅäÊ∞ó„Å´ÂÖ•„Çä„Å´‰øùÂ≠ò",
      share: "„Ç∑„Çß„Ç¢",
      
      // Rating
      good: "ËâØ„ÅÑ",
      bad: "ÊÇ™„ÅÑ", 
      thanks: "„ÅÇ„Çä„Åå„Å®„ÅÜÔºÅ",
      noted: "‰∫ÜËß£ÔºÅ",
      rateThis: "„Åì„ÅÆË®Ä„ÅÑË®≥„ÇíË©ï‰æ°:",
      
      // Proof generators
      weather: "Â§©Ê∞ó",
      traffic: "‰∫§ÈÄö", 
      medical: "ÂåªÁôÇ",
      
      // Loading messages
      generatingExcuse: "Ë®Ä„ÅÑË®≥„ÇíÁîüÊàê‰∏≠...",
      craftingStory: "ÂÆåÁíß„Å™Áâ©Ë™û„Çí‰ΩúÊàê‰∏≠",
      
      // Feature buttons
      custom: "„Ç´„Çπ„Çø„É†",
      templates: "„ÉÜ„É≥„Éó„É¨„Éº„Éà",
      analytics: "ÂàÜÊûê",
      export: "„Ç®„ÇØ„Çπ„Éù„Éº„Éà",
      settings: "Ë®≠ÂÆö",
      
      // Subscription
      subscriptionTitle: "„Éó„É©„É≥„ÇíÈÅ∏Êäû",
      freePlan: "ÁÑ°Êñô",
      proPlan: "„Éó„É≠",
      premiumPlan: "„Éó„É¨„Éü„Ç¢„É†",
      currentPlan: "ÁèæÂú®„ÅÆ„Éó„É©„É≥",
      upgradePlan: "„Éó„É©„É≥„Çí„Ç¢„ÉÉ„Éó„Ç∞„É¨„Éº„Éâ",
      
      // Daily widget
      dailyExcuseTitle: "‰ªäÊó•„ÅÆË®Ä„ÅÑË®≥",
      copyProof: "Ë®ºÊòé„Çí„Ç≥„Éî„Éº",
      copy: "„Ç≥„Éî„Éº",
      
      // Main instructions
      pickInstructions: "Áä∂Ê≥Å„Å®„Éà„Éº„É≥„ÇíÈÅ∏„Çì„Åß„ÄÅÈ≠îÊ≥ï„ÇíËµ∑„Åì„Åó„Åæ„Åó„Çá„ÅÜÔºÅ",
      
      // Stats
      successRate: "ÊàêÂäüÁéá",
      
      // Accessibility
      generateAriaLabel: "Êñ∞„Åó„ÅÑË®Ä„ÅÑË®≥„ÇíÁîüÊàê",
      generateAriaDescription: "ÈÅ∏Êäû„Åó„ÅüÁä∂Ê≥Å„Å®„Éà„Éº„É≥„Å´Âü∫„Å•„ÅÑ„Å¶Êñ∞„Åó„ÅÑË®Ä„ÅÑË®≥„ÇíÁîüÊàê„Åô„Çã„Å´„ÅØ„ÇØ„É™„ÉÉ„ÇØ",
      copyAriaLabel: "Ë®Ä„ÅÑË®≥„Çí„ÇØ„É™„ÉÉ„Éó„Éú„Éº„Éâ„Å´„Ç≥„Éî„Éº",
      favoriteAriaLabel: "„Åì„ÅÆË®Ä„ÅÑË®≥„Çí„ÅäÊ∞ó„Å´ÂÖ•„Çä„Å´‰øùÂ≠ò",
      // Additional proof labels
      office: "„Ç™„Éï„Ç£„Çπ", 
      alertId: "Ë≠¶Â†±ID",
      incidentId: "‰∫ãÊïÖID",
      documentId: "ÊñáÊõ∏ #",
      north: "Âåó",
      south: "Âçó", 
      exit: "Âá∫Âè£",
      affectedArea: "ÂΩ±Èüø„ÇíÂèó„Åë„ÇãÂú∞Âüü",
      
      // Onboarding
      welcomeTitle: "üéâ Excuses, Excuses!„Å∏„Çà„ÅÜ„Åì„ÅùÔºÅ",
      welcomeDescription: "„ÅÇ„Çâ„ÇÜ„ÇãÁä∂Ê≥Å„Å´ÂØæÂøú„Åô„ÇãÁ©∂Ê•µ„ÅÆË®Ä„ÅÑË®≥„Ç∏„Çß„Éç„É¨„Éº„Çø„ÉºÔºÅ‰∏äË®ò„ÅßË®ÄË™û„ÇíÈÅ∏Êäû„Åó„ÄÅ„ÅäÂ•Ω„Åø„ÅÆË®Ä„ÅÑË®≥„Çπ„Çø„Ç§„É´„ÇíÈÅ∏„Çì„ÅßÂßã„ÇÅ„Åæ„Åó„Çá„ÅÜ„ÄÇ",
      chooseLanguageLabel: "üåç Ë®ÄË™û„ÇíÈÅ∏Êäû",
      chooseStyleTitle: "„Çπ„Çø„Ç§„É´„ÇíÈÅ∏Êäû",
      funnyStyle: "üòÇ Èù¢ÁôΩ„Åè„Å¶„É¶„Éº„É¢„É©„Çπ",
      professionalStyle: "üíº „Éó„É≠„Éï„Çß„ÉÉ„Ç∑„Éß„Éä„É´„ÅßÊ¥óÁ∑¥",
      believableStyle: "‚úÖ ‰ø°ÊÜëÊÄß„Åå„ÅÇ„ÇäÁèæÂÆüÁöÑ", 
      dramaticStyle: "üé≠ „Éâ„É©„Éû„ÉÅ„ÉÉ„ÇØ„ÅßÂ§ßË¢àË£ü"
    }
  };

  const multilingualExcuses = {
    en: {
      work: {
        funny: [
          "My WiFi got stage fright during the meeting.",
          "My cat scheduled an emergency meeting on my keyboard.",
          "I'm stuck in an elevator with terrible cell service... again.",
          "My coffee maker is holding me hostage until I fix it."
        ],
        professional: [
          "I'm dealing with unexpected technical issues and will join shortly.",
          "I have an urgent client matter that requires immediate attention.",
          "I'm experiencing connectivity issues and need to resolve them first.",
          "I need to handle a time-sensitive project deliverable before joining."
        ],
        believable: [
          "Traffic was heavier than expected, I'll be late.",
          "My train/bus is running significantly behind schedule.",
          "I have a family emergency I need to address quickly.",
          "My car won't start, I'm arranging alternative transportation."
        ],
        dramatic: [
          "The universe is clearly conspiring against my attendance today!",
          "I'm trapped in a maze of construction detours with no escape!",
          "My entire morning has been a series of catastrophic events!",
          "The powers that be have decided today is not my day to shine!"
        ]
      },
      social: {
        funny: [
          "My social battery died and I can't find the charger.",
          "I'm having a deep philosophical crisis about pants.",
          "My couch and I are in the middle of important negotiations.",
          "I just remembered I'm allergic to small talk."
        ],
        professional: [
          "I have a family commitment that requires my immediate attention.",
          "I'm experiencing some personal circumstances that prevent my attendance.",
          "I need to handle an urgent personal matter this evening.",
          "I have a prior engagement that I cannot reschedule."
        ],
        believable: [
          "I'm not feeling well and don't want to risk getting others sick.",
          "I have a family member visiting unexpectedly.",
          "My babysitter canceled last minute and I can't find a replacement.",
          "I'm dealing with a home maintenance emergency."
        ],
        dramatic: [
          "I'm currently trapped in a web of social obligations beyond my control!",
          "The very fabric of my evening has been torn asunder by chaos!",
          "I'm battling forces that seek to prevent my social participation!",
          "My presence would only bring darkness to this joyous occasion!"
        ]
      },
      weather: {
        funny: [
          "Mother Nature decided to throw a tantrum and I'm caught in the crossfire.",
          "The weather app lied to me worse than my ex did.",
          "I'm currently being held hostage by a rogue rainstorm.",
          "The sun called in sick and took all my motivation with it.",
          "I'm having an intense staring contest with a lightning bolt.",
          "The weather is more unpredictable than my WiFi connection."
        ],
        professional: [
          "Severe weather conditions have made travel unsafe in my area.",
          "I'm experiencing weather-related transportation delays that will impact my arrival time.",
          "Due to hazardous weather conditions, I need to prioritize safety and delay my departure.",
          "Local weather advisories are recommending against non-essential travel at this time.",
          "Weather-related power outages in my area are affecting my ability to participate remotely.",
          "I'm monitoring weather conditions and will update you on my availability shortly."
        ],
        believable: [
          "There's a severe storm warning in my area and roads are flooded.",
          "Heavy snow has made driving conditions extremely dangerous.",
          "My power went out due to the storm and my phone is nearly dead.",
          "The weather is so bad that public transportation has been suspended.",
          "Ice storm has made it impossible to safely leave my driveway.",
          "Flash flood warnings mean I need to stay put until conditions improve."
        ],
        dramatic: [
          "The heavens have opened and are unleashing their fury upon me!",
          "I'm trapped in nature's violent ballet of wind and rain!",
          "The storm gods have chosen me as their personal target today!",
          "I'm caught in an epic battle between the elements themselves!",
          "Mother Nature is having a full-scale meltdown and I'm in the blast zone!",
          "The weather has conspired to create a perfect storm of inconvenience!"
        ]
      },
      traffic: {
        funny: [
          "I'm stuck in traffic so bad, I've started a small civilization in my car.",
          "The highway has become a very expensive parking lot.",
          "I'm moving slower than a Windows 95 computer loading the internet.",
          "Traffic is so backed up, I've aged three years in the last hour.",
          "I'm trapped in what appears to be the world's slowest parade.",
          "The GPS is laughing at me - actual arrival time: sometime next week."
        ],
        professional: [
          "I'm experiencing significant traffic delays due to an accident on my route.",
          "Unexpected road construction has created substantial delays in my commute.",
          "I'm currently navigating through heavy traffic congestion and will be delayed.",
          "A major traffic incident has blocked my usual route, causing significant delays.",
          "Peak traffic conditions are heavier than anticipated, impacting my arrival time.",
          "I'm working through alternative routes due to current traffic conditions."
        ],
        believable: [
          "Major accident on the freeway has traffic at a complete standstill.",
          "There's construction I wasn't aware of that's caused a huge backup.",
          "My usual route is blocked due to emergency road repairs.",
          "Traffic is backed up for miles due to a multi-car accident ahead.",
          "Road closure due to utility work has diverted all traffic to side streets.",
          "Rush hour traffic is particularly heavy today due to a special event."
        ],
        dramatic: [
          "I'm trapped in an endless river of metal and fury!",
          "The great migration of vehicles has claimed me as its prisoner!",
          "I've become one with the eternal traffic jam of souls!",
          "The highway gods are testing my patience with this automotive purgatory!",
          "I'm caught in the epic saga of ten thousand commuters versus one small road!",
          "The traffic has achieved sentience and chosen me as its unwilling victim!"
        ]
      },
      medical: {
        funny: [
          "My body decided to stage a rebellion and I'm the unwilling dictator.",
          "I'm having technical difficulties with my human operating system.",
          "My immune system is throwing a tantrum like a toddler in a grocery store.",
          "I woke up feeling like I was hit by the struggle bus... twice.",
          "My body's warranty expired and everything is malfunctioning at once.",
          "I'm experiencing a temporary glitch in my human software."
        ],
        professional: [
          "I'm experiencing health-related symptoms that require medical attention.",
          "I need to address a medical situation that has developed suddenly.",
          "I'm following medical advice to rest and avoid potential exposure to others.",
          "I have a medical appointment that cannot be rescheduled due to scheduling constraints.",
          "I'm managing a health condition that requires immediate attention today.",
          "Medical circumstances require me to prioritize my health and recovery."
        ],
        believable: [
          "I woke up with severe flu symptoms and don't want to risk spreading it.",
          "I'm experiencing food poisoning symptoms from something I ate last night.",
          "I have a migraine so severe that I can't focus or function properly.",
          "I'm dealing with a stomach virus and need to stay close to home.",
          "I have a severe allergic reaction and need to see a doctor immediately.",
          "I threw out my back and can barely move without significant pain."
        ],
        dramatic: [
          "My mortal vessel has betrayed me in the most spectacular fashion!",
          "I'm locked in an epic battle with microscopic invaders!",
          "My body has declared war on itself and I'm caught in the crossfire!",
          "The plague of inconvenience has chosen me as its latest victim!",
          "I'm experiencing a full-scale revolt of my biological systems!",
          "My health has abandoned me like a fair-weather friend!"
        ]
      }
    },
    es: {
      work: {
        funny: [
          "Mi WiFi tiene miedo esc√©nico durante las reuniones.",
          "Mi gato program√≥ una reuni√≥n de emergencia en mi teclado.",
          "Estoy atrapado en un ascensor sin se√±al... otra vez.",
          "Mi cafetera me tiene como reh√©n hasta que la arregle."
        ],
        professional: [
          "Estoy resolviendo problemas t√©cnicos inesperados, me unir√© pronto.",
          "Tengo un asunto urgente de cliente que requiere atenci√≥n inmediata.",
          "Estoy experimentando problemas de conectividad que debo resolver primero.",
          "Necesito manejar una entrega de proyecto urgente antes de unirme."
        ],
        believable: [
          "El tr√°fico estaba m√°s pesado de lo esperado, llegar√© tarde.",
          "Mi tren/autob√∫s est√° muy retrasado.",
          "Tengo una emergencia familiar que debo atender r√°pidamente.",
          "Mi coche no arranca, estoy organizando transporte alternativo."
        ],
        dramatic: [
          "¬°El universo claramente est√° conspirando contra mi asistencia hoy!",
          "¬°Estoy atrapado en un laberinto de desv√≠os de construcci√≥n sin escape!",
          "¬°Toda mi ma√±ana ha sido una serie de eventos catastr√≥ficos!",
          "¬°Los poderes superiores han decidido que hoy no es mi d√≠a para brillar!"
        ]
      },
      social: {
        funny: [
          "Mi bater√≠a social muri√≥ y no encuentro el cargador.",
          "Estoy teniendo una crisis filos√≥fica profunda sobre los pantalones.",
          "Mi sof√° y yo estamos en medio de negociaciones importantes.",
          "Acabo de recordar que soy al√©rgico a la charla trivial."
        ],
        professional: [
          "Tengo un compromiso familiar que requiere mi atenci√≥n inmediata.",
          "Estoy experimentando algunas circunstancias personales que impiden mi asistencia.",
          "Necesito manejar un asunto personal urgente esta noche.",
          "Tengo un compromiso previo que no puedo reprogramar."
        ],
        believable: [
          "No me siento bien y no quiero arriesgar contagiar a otros.",
          "Tengo un miembro de la familia visitando inesperadamente.",
          "Mi ni√±era cancel√≥ a √∫ltimo minuto y no puedo encontrar reemplazo.",
          "Estoy lidiando con una emergencia de mantenimiento del hogar."
        ],
        dramatic: [
          "¬°Actualmente estoy atrapado en una red de obligaciones sociales fuera de mi control!",
          "¬°La misma tela de mi noche ha sido desgarrada por el caos!",
          "¬°Estoy luchando contra fuerzas que buscan impedir mi participaci√≥n social!",
          "¬°Mi presencia solo traer√≠a oscuridad a esta ocasi√≥n alegre!"
        ]
      },
      weather: {
        funny: [
          "La Madre Naturaleza decidi√≥ hacer berrinche y estoy atrapado en el fuego cruzado.",
          "La app del clima me minti√≥ peor que mi ex.",
          "Actualmente estoy siendo reh√©n de una tormenta rebelde.",
          "El sol pidi√≥ d√≠a libre y se llev√≥ toda mi motivaci√≥n con √©l.",
          "Estoy teniendo un concurso intenso de miradas con un rayo.",
          "El clima es m√°s impredecible que mi conexi√≥n WiFi."
        ],
        professional: [
          "Las condiciones clim√°ticas severas han hecho que viajar sea inseguro en mi √°rea.",
          "Estoy experimentando retrasos de transporte relacionados con el clima.",
          "Debido a las condiciones clim√°ticas peligrosas, debo priorizar la seguridad.",
          "Los avisos meteorol√≥gicos locales recomiendan evitar viajes no esenciales.",
          "Cortes de energ√≠a relacionados con el clima est√°n afectando mi participaci√≥n remota.",
          "Estoy monitoreando las condiciones clim√°ticas y actualizar√© mi disponibilidad pronto."
        ],
        believable: [
          "Hay una advertencia de tormenta severa en mi √°rea y las carreteras est√°n inundadas.",
          "La nieve pesada ha hecho que las condiciones de manejo sean extremadamente peligrosas.",
          "Se fue la luz por la tormenta y mi tel√©fono est√° casi sin bater√≠a.",
          "El clima est√° tan malo que el transporte p√∫blico ha sido suspendido.",
          "La tormenta de hielo ha hecho imposible salir de mi entrada de forma segura.",
          "Las advertencias de inundaci√≥n repentina significan que debo quedarme hasta que mejore."
        ],
        dramatic: [
          "¬°Los cielos se han abierto y est√°n desatando su furia sobre m√≠!",
          "¬°Estoy atrapado en el ballet violento de viento y lluvia de la naturaleza!",
          "¬°Los dioses de la tormenta me han elegido como su objetivo personal hoy!",
          "¬°Estoy atrapado en una batalla √©pica entre los elementos mismos!",
          "¬°La Madre Naturaleza est√° teniendo un colapso total y estoy en la zona de impacto!",
          "¬°El clima ha conspirado para crear una tormenta perfecta de inconvenientes!"
        ]
      },
      traffic: {
        funny: [
          "Estoy atrapado en tr√°fico tan malo que he comenzado una peque√±a civilizaci√≥n en mi carro.",
          "La autopista se ha convertido en un estacionamiento muy caro.",
          "Me muevo m√°s lento que una computadora Windows 95 cargando internet.",
          "El tr√°fico est√° tan atascado que he envejecido tres a√±os en la √∫ltima hora.",
          "Estoy atrapado en lo que parece ser el desfile m√°s lento del mundo.",
          "El GPS se est√° riendo de m√≠ - tiempo real de llegada: alg√∫n momento la pr√≥xima semana."
        ],
        professional: [
          "Estoy experimentando retrasos significativos de tr√°fico debido a un accidente en mi ruta.",
          "La construcci√≥n inesperada de carreteras ha creado retrasos sustanciales en mi viaje.",
          "Actualmente estoy navegando a trav√©s de congesti√≥n de tr√°fico pesada.",
          "Un incidente de tr√°fico mayor ha bloqueado mi ruta usual, causando retrasos significativos.",
          "Las condiciones de tr√°fico pico son m√°s pesadas de lo anticipado.",
          "Estoy trabajando en rutas alternativas debido a las condiciones actuales de tr√°fico."
        ],
        believable: [
          "Accidente mayor en la autopista tiene el tr√°fico completamente parado.",
          "Hay construcci√≥n de la que no estaba consciente que ha causado un gran atasco.",
          "Mi ruta usual est√° bloqueada debido a reparaciones de emergencia del camino.",
          "El tr√°fico est√° atascado por millas debido a un accidente de m√∫ltiples carros adelante.",
          "Cierre de carretera debido a trabajo de servicios ha desviado todo el tr√°fico.",
          "El tr√°fico de hora pico est√° particularmente pesado hoy debido a un evento especial."
        ],
        dramatic: [
          "¬°Estoy atrapado en un r√≠o sin fin de metal y furia!",
          "¬°La gran migraci√≥n de veh√≠culos me ha reclamado como su prisionero!",
          "¬°Me he vuelto uno con el atasco de tr√°fico eterno de almas!",
          "¬°Los dioses de la autopista est√°n probando mi paciencia con este purgatorio automotriz!",
          "¬°Estoy atrapado en la saga √©pica de diez mil viajeros versus un camino peque√±o!",
          "¬°El tr√°fico ha alcanzado conciencia y me ha elegido como su v√≠ctima involuntaria!"
        ]
      },
      medical: {
        funny: [
          "Mi cuerpo decidi√≥ organizar una rebeli√≥n y soy el dictador involuntario.",
          "Estoy teniendo dificultades t√©cnicas con mi sistema operativo humano.",
          "Mi sistema inmunol√≥gico est√° haciendo berrinche como un ni√±o en el supermercado.",
          "Despert√© sinti√©ndome como si me hubiera golpeado el autob√∫s de la lucha... dos veces.",
          "La garant√≠a de mi cuerpo expir√≥ y todo est√° funcionando mal a la vez.",
          "Estoy experimentando un error temporal en mi software humano."
        ],
        professional: [
          "Estoy experimentando s√≠ntomas relacionados con la salud que requieren atenci√≥n m√©dica.",
          "Necesito atender una situaci√≥n m√©dica que se ha desarrollado repentinamente.",
          "Estoy siguiendo consejos m√©dicos para descansar y evitar exposici√≥n potencial a otros.",
          "Tengo una cita m√©dica que no puede ser reprogramada debido a restricciones de horario.",
          "Estoy manejando una condici√≥n de salud que requiere atenci√≥n inmediata hoy.",
          "Las circunstancias m√©dicas requieren que priorice mi salud y recuperaci√≥n."
        ],
        believable: [
          "Despert√© con s√≠ntomas severos de gripe y no quiero arriesgar propagarlo.",
          "Estoy experimentando s√≠ntomas de intoxicaci√≥n alimentaria por algo que com√≠ anoche.",
          "Tengo una migra√±a tan severa que no puedo enfocarme o funcionar adecuadamente.",
          "Estoy lidiando con un virus estomacal y necesito quedarme cerca de casa.",
          "Tengo una reacci√≥n al√©rgica severa y necesito ver a un doctor inmediatamente.",
          "Me lastim√© la espalda y apenas puedo moverme sin dolor significativo."
        ],
        dramatic: [
          "¬°Mi vasija mortal me ha traicionado de la manera m√°s espectacular!",
          "¬°Estoy encerrado en una batalla √©pica con invasores microsc√≥picos!",
          "¬°Mi cuerpo ha declarado guerra contra s√≠ mismo y estoy atrapado en el fuego cruzado!",
          "¬°La plaga de la inconveniencia me ha elegido como su √∫ltima v√≠ctima!",
          "¬°Estoy experimentando una revuelta total de mis sistemas biol√≥gicos!",
          "¬°Mi salud me ha abandonado como un amigo de buen tiempo!"
        ]
      }
    },
    fr: {
      work: {
        funny: [
          "Mon WiFi a le trac pendant les r√©unions.",
          "Mon chat a programm√© une r√©union d'urgence sur mon clavier.",
          "Je suis coinc√© dans un ascenseur sans r√©seau... encore.",
          "Ma machine √† caf√© me tient en otage jusqu'√† ce que je la r√©pare."
        ],
        professional: [
          "Je r√®gle des probl√®mes techniques inattendus, je vais rejoindre bient√¥t.",
          "J'ai une affaire client urgente qui n√©cessite une attention imm√©diate.",
          "Je rencontre des probl√®mes de connectivit√© que je dois r√©soudre d'abord.",
          "Je dois traiter un livrable de projet urgent avant de rejoindre."
        ],
        believable: [
          "Le trafic √©tait plus dense que pr√©vu, je vais √™tre en retard.",
          "Mon train/bus est tr√®s en retard.",
          "J'ai une urgence familiale √† r√©gler rapidement.",
          "Ma voiture ne d√©marre pas, j'organise un transport alternatif."
        ],
        dramatic: [
          "L'univers conspire clairement contre ma pr√©sence aujourd'hui !",
          "Je suis pris au pi√®ge dans un labyrinthe de d√©viations sans issue !",
          "Toute ma matin√©e a √©t√© une s√©rie d'√©v√©nements catastrophiques !",
          "Les forces sup√©rieures ont d√©cid√© qu'aujourd'hui n'est pas mon jour de briller !"
        ]
      },
      social: {
        funny: [
          "Ma batterie sociale est morte et je ne trouve pas le chargeur.",
          "J'ai une crise philosophique profonde √† propos des pantalons.",
          "Mon canap√© et moi sommes au milieu de n√©gociations importantes.",
          "Je viens de me rappeler que je suis allergique aux bavardages."
        ],
        professional: [
          "J'ai un engagement familial qui n√©cessite mon attention imm√©diate.",
          "Je traverse des circonstances personnelles qui emp√™chent ma pr√©sence.",
          "Je dois g√©rer une affaire personnelle urgente ce soir.",
          "J'ai un engagement pr√©alable que je ne peux pas reprogrammer."
        ],
        believable: [
          "Je ne me sens pas bien et ne veux pas risquer de contaminer les autres.",
          "J'ai un membre de la famille qui visite de mani√®re inattendue.",
          "Ma baby-sitter a annul√© √† la derni√®re minute et je ne trouve pas de rempla√ßant.",
          "Je g√®re une urgence d'entretien de maison."
        ],
        dramatic: [
          "Je suis actuellement pris au pi√®ge dans une toile d'obligations sociales hors de mon contr√¥le !",
          "Le tissu m√™me de ma soir√©e a √©t√© d√©chir√© par le chaos !",
          "Je combats des forces qui cherchent √† emp√™cher ma participation sociale !",
          "Ma pr√©sence ne ferait qu'apporter des t√©n√®bres √† cette joyeuse occasion !"
        ]
      }
    },
    de: {
      work: {
        funny: [
          "Mein WLAN hat Lampenfieber w√§hrend Meetings.",
          "Meine Katze hat ein Notfallmeeting auf meiner Tastatur einberufen.",
          "Ich stecke in einem Aufzug ohne Empfang fest... schon wieder.",
          "Meine Kaffeemaschine h√§lt mich als Geisel, bis ich sie repariere."
        ],
        professional: [
          "Ich l√∂se unerwartete technische Probleme und werde bald beitreten.",
          "Ich habe eine dringende Kundenangelegenheit, die sofortige Aufmerksamkeit erfordert.",
          "Ich habe Verbindungsprobleme, die ich zuerst l√∂sen muss.",
          "Ich muss eine zeitkritische Projektlieferung vor dem Beitritt bearbeiten."
        ],
        believable: [
          "Der Verkehr war schwerer als erwartet, ich werde zu sp√§t kommen.",
          "Mein Zug/Bus hat erhebliche Versp√§tung.",
          "Ich habe einen Familiennotfall, den ich schnell kl√§ren muss.",
          "Mein Auto springt nicht an, ich organisiere alternative Bef√∂rderung."
        ],
        dramatic: [
          "Das Universum verschw√∂rt sich eindeutig gegen meine Anwesenheit heute!",
          "Ich bin in einem Labyrinth von Baustellen-Umleitungen ohne Ausweg gefangen!",
          "Mein ganzer Morgen war eine Serie katastrophaler Ereignisse!",
          "Die M√§chte haben entschieden, dass heute nicht mein Tag zum Gl√§nzen ist!"
        ]
      }
    },
    it: {
      work: {
        funny: [
          "Il mio WiFi ha la paura del palcoscenico durante le riunioni.",
          "Il mio gatto ha programmato una riunione di emergenza sulla mia tastiera.",
          "Sono bloccato in un ascensore senza segnale... di nuovo.",
          "La mia macchina del caff√® mi tiene in ostaggio finch√© non la riparo."
        ],
        professional: [
          "Sto risolvendo problemi tecnici imprevisti, mi unir√≤ presto.",
          "Ho una questione cliente urgente che richiede attenzione immediata.",
          "Ho problemi di connettivit√† che devo risolvere prima.",
          "Devo gestire una consegna di progetto urgente prima di unirmi."
        ],
        believable: [
          "Il traffico era pi√π intenso del previsto, arriver√≤ in ritardo.",
          "Il mio treno/autobus √® molto in ritardo.",
          "Ho un'emergenza familiare da gestire rapidamente.",
          "La mia auto non si avvia, sto organizzando un trasporto alternativo."
        ],
        dramatic: [
          "L'universo sta chiaramente cospirando contro la mia presenza oggi!",
          "Sono intrappolato in un labirinto di deviazioni senza via d'uscita!",
          "Tutta la mia mattinata √® stata una serie di eventi catastrofici!",
          "I poteri superiori hanno deciso che oggi non √® il mio giorno per brillare!"
        ]
      }
    },
    pt: {
      work: {
        funny: [
          "Meu Wi-Fi teve um ataque de ansiedade social durante a reuni√£o.",
          "Meu gato marcou uma reuni√£o de emerg√™ncia no meu teclado.",
          "Estou preso num elevador com p√©ssimo sinal... de novo.",
          "Minha cafeteira est√° me fazendo ref√©m at√© eu consert√°-la."
        ],
        professional: [
          "Estou lidando com quest√µes t√©cnicas inesperadas e me juntarei em breve.",
          "Tenho um assunto urgente com cliente que requer aten√ß√£o imediata.",
          "Estou enfrentando problemas de conectividade e preciso resolv√™-los primeiro.",
          "Tenho uma quest√£o priorit√°ria que devo completar primeiro."
        ],
        believable: [
          "Tr√¢nsito na rodovia est√° congestionado devido a acidente, chegarei 20 minutos atrasado.",
          "Meu carro quebrou e estou esperando o guincho.",
          "Tenho uma emerg√™ncia familiar que preciso resolver.",
          "A operadora de internet est√° com problema na minha √°rea."
        ],
        dramatic: [
          "O universo est√° claramente conspirando contra minha presen√ßa hoje!",
          "Estou preso num labirinto de desvios sem sa√≠da!",
          "Toda minha manh√£ foi uma s√©rie de eventos catastr√≥ficos!",
          "Os poderes superiores decidiram que hoje n√£o √© meu dia para brilhar!"
        ]
      }
    },
    ru: {
      work: {
        funny: [
          "–ú–æ–π Wi-Fi –ø–æ–ª—É—á–∏–ª —Å–æ—Ü–∏–æ—Ñ–æ–±–∏—é –≤–æ –≤—Ä–µ–º—è –≤—Å—Ç—Ä–µ—á–∏.",
          "–ú–æ–π –∫–æ—Ç –Ω–∞–∑–Ω–∞—á–∏–ª —ç–∫—Å—Ç—Ä–µ–Ω–Ω–æ–µ —Å–æ–≤–µ—â–∞–Ω–∏–µ –Ω–∞ –º–æ–µ–π –∫–ª–∞–≤–∏–∞—Ç—É—Ä–µ.",
          "–Ø –∑–∞—Å—Ç—Ä—è–ª –≤ –ª–∏—Ñ—Ç–µ —Å —É–∂–∞—Å–Ω–æ–π —Å–≤—è–∑—å—é... –æ–ø—è—Ç—å.",
          "–ú–æ—è –∫–æ—Ñ–µ–≤–∞—Ä–∫–∞ –¥–µ—Ä–∂–∏—Ç –º–µ–Ω—è –≤ –∑–∞–ª–æ–∂–Ω–∏–∫–∞—Ö, –ø–æ–∫–∞ —è –µ—ë –Ω–µ –ø–æ—á–∏–Ω—é."
        ],
        professional: [
          "–Ø —Ä–µ—à–∞—é –Ω–µ–æ–∂–∏–¥–∞–Ω–Ω—ã–µ —Ç–µ—Ö–Ω–∏—á–µ—Å–∫–∏–µ –ø—Ä–æ–±–ª–µ–º—ã –∏ —Å–∫–æ—Ä–æ –ø—Ä–∏—Å–æ–µ–¥–∏–Ω—é—Å—å.",
          "–£ –º–µ–Ω—è —Å—Ä–æ—á–Ω–æ–µ –¥–µ–ª–æ —Å –∫–ª–∏–µ–Ω—Ç–æ–º, —Ç—Ä–µ–±—É—é—â–µ–µ –Ω–µ–º–µ–¥–ª–µ–Ω–Ω–æ–≥–æ –≤–Ω–∏–º–∞–Ω–∏—è.",
          "–£ –º–µ–Ω—è –ø—Ä–æ–±–ª–µ–º—ã —Å –ø–æ–¥–∫–ª—é—á–µ–Ω–∏–µ–º, –Ω—É–∂–Ω–æ –∏—Ö —Å–Ω–∞—á–∞–ª–∞ —Ä–µ—à–∏—Ç—å.",
          "–£ –º–µ–Ω—è –ø—Ä–∏–æ—Ä–∏—Ç–µ—Ç–Ω–∞—è –∑–∞–¥–∞—á–∞, –∫–æ—Ç–æ—Ä—É—é –Ω—É–∂–Ω–æ –≤—ã–ø–æ–ª–Ω–∏—Ç—å –≤ –ø–µ—Ä–≤—É—é –æ—á–µ—Ä–µ–¥—å."
        ],
        believable: [
          "–ü—Ä–æ–±–∫–∞ –Ω–∞ —à–æ—Å—Å–µ –∏–∑-–∑–∞ –∞–≤–∞—Ä–∏–∏, –æ–ø–æ–∑–¥–∞—é –Ω–∞ 20 –º–∏–Ω—É—Ç.",
          "–ú–æ—è –º–∞—à–∏–Ω–∞ —Å–ª–æ–º–∞–ª–∞—Å—å, –∂–¥—É —ç–≤–∞–∫—É–∞—Ç–æ—Ä.",
          "–£ –º–µ–Ω—è —Å–µ–º–µ–π–Ω–∞—è —á—Ä–µ–∑–≤—ã—á–∞–π–Ω–∞—è —Å–∏—Ç—É–∞—Ü–∏—è, –∫–æ—Ç–æ—Ä—É—é –Ω—É–∂–Ω–æ —Ä–µ—à–∏—Ç—å.",
          "–£ –∏–Ω—Ç–µ—Ä–Ω–µ—Ç-–ø—Ä–æ–≤–∞–π–¥–µ—Ä–∞ —Å–±–æ–π –≤ –º–æ—ë–º —Ä–∞–π–æ–Ω–µ."
        ],
        dramatic: [
          "–í—Å–µ–ª–µ–Ω–Ω–∞—è —è–≤–Ω–æ –∑–∞–º—ã—à–ª—è–µ—Ç –ø—Ä–æ—Ç–∏–≤ –º–æ–µ–≥–æ –ø—Ä–∏—Å—É—Ç—Å—Ç–≤–∏—è —Å–µ–≥–æ–¥–Ω—è!",
          "–Ø –∑–∞–ø–µ—Ä—Ç –≤ –ª–∞–±–∏—Ä–∏–Ω—Ç–µ –æ–±—ä–µ–∑–¥–æ–≤ –±–µ–∑ –≤—ã—Ö–æ–¥–∞!",
          "–í—Å—ë –º–æ—ë —É—Ç—Ä–æ –±—ã–ª–æ —Å–µ—Ä–∏–µ–π –∫–∞—Ç–∞—Å—Ç—Ä–æ—Ñ–∏—á–µ—Å–∫–∏—Ö —Å–æ–±—ã—Ç–∏–π!",
          "–í—ã—Å—à–∏–µ —Å–∏–ª—ã —Ä–µ—à–∏–ª–∏, —á—Ç–æ —Å–µ–≥–æ–¥–Ω—è –Ω–µ –º–æ–π –¥–µ–Ω—å –¥–ª—è –±–ª–µ—Å–∫–∞!"
        ]
      }
    },
    ja: {
      work: {
        funny: [
          "Wi-Fi„Åå„Éü„Éº„ÉÜ„Ç£„É≥„Ç∞‰∏≠„Å´Á§æ‰∫§‰∏çÂÆâ„ÇíËµ∑„Åì„Åó„Åæ„Åó„Åü„ÄÇ",
          "Áå´„Åå„Ç≠„Éº„Éú„Éº„Éâ„ÅßÁ∑äÊÄ•‰ºöË≠∞„ÇíÊãõÈõÜ„Åó„Åæ„Åó„Åü„ÄÇ",
          "ÈõªÊ≥¢„ÅÆÊÇ™„ÅÑ„Ç®„É¨„Éô„Éº„Çø„Éº„Å´Èñâ„ÅòËæº„ÇÅ„Çâ„Çå„Å¶„ÅÑ„Åæ„Åô...„Åæ„Åü„ÄÇ",
          "„Ç≥„Éº„Éí„Éº„É°„Éº„Ç´„Éº„Å´‰øÆÁêÜ„Åô„Çã„Åæ„Åß‰∫∫Ë≥™„Å´Âèñ„Çâ„Çå„Å¶„ÅÑ„Åæ„Åô„ÄÇ"
        ],
        professional: [
          "‰∫àÊúü„Åó„Å™„ÅÑÊäÄË°ìÁöÑÂïèÈ°å„Å´ÂØæÂá¶„Åó„Å¶„Åä„Çä„ÄÅ„Åô„Åê„Å´ÂèÇÂä†„ÅÑ„Åü„Åó„Åæ„Åô„ÄÇ",
          "„ÅäÂÆ¢Êßò„Å®„ÅÆÁ∑äÊÄ•Ê°à‰ª∂„Åå„ÅÇ„Çä„ÄÅ„Åô„Åê„Å´ÂØæÂøú„ÅåÂøÖË¶Å„Åß„Åô„ÄÇ",
          "Êé•Á∂ö„Å´ÂïèÈ°å„ÅåÁîü„Åò„Å¶„Åä„Çä„ÄÅ„Åæ„ÅöËß£Ê±∫„Åô„ÇãÂøÖË¶Å„Åå„ÅÇ„Çä„Åæ„Åô„ÄÇ",
          "ÂÑ™ÂÖàÁöÑ„Å´ÂÆå‰∫Ü„Åó„Å™„Åë„Çå„Å∞„Å™„Çâ„Å™„ÅÑÊ•≠Âãô„Åå„ÅÇ„Çä„Åæ„Åô„ÄÇ"
        ],
        believable: [
          "È´òÈÄüÈÅìË∑Ø„Åß‰∫ãÊïÖ„Å´„Çà„ÇãÊ∏ãÊªû„Åß20ÂàÜÈÅÖ„Çå„Åæ„Åô„ÄÇ",
          "Ëªä„ÅåÊïÖÈöú„Åó„Å¶„É¨„ÉÉ„Ç´„Éº„ÇíÂæÖ„Å£„Å¶„ÅÑ„Åæ„Åô„ÄÇ",
          "ÂÆ∂Êóè„ÅÆÁ∑äÊÄ•‰∫ãÊÖã„Å´ÂØæÂøú„Åô„ÇãÂøÖË¶Å„Åå„ÅÇ„Çä„Åæ„Åô„ÄÇ",
          "ÁßÅ„ÅÆÂú∞Âüü„Åß„Ç§„É≥„Çø„Éº„Éç„ÉÉ„Éà„Éó„É≠„Éê„Ç§„ÉÄ„Éº„Å´ÈöúÂÆ≥„ÅåÁô∫Áîü„Åó„Å¶„ÅÑ„Åæ„Åô„ÄÇ"
        ],
        dramatic: [
          "ÂÆáÂÆô„ÅåÊòé„Çâ„Åã„Å´‰ªäÊó•„ÅÆÁßÅ„ÅÆÂèÇÂä†„ÇíÈòª„Çì„Åß„ÅÑ„Åæ„ÅôÔºÅ",
          "Âá∫Âè£„ÅÆ„Å™„ÅÑËøÇÂõûË∑Ø„ÅÆËø∑Ë∑Ø„Å´Èñâ„ÅòËæº„ÇÅ„Çâ„Çå„Å¶„ÅÑ„Åæ„ÅôÔºÅ",
          "ÁßÅ„ÅÆÊúù„ÅØÁ†¥ÊªÖÁöÑ„Å™Âá∫Êù•‰∫ã„ÅÆÈÄ£Á∂ö„Åß„Åó„ÅüÔºÅ",
          "‰∏ä‰Ωç„ÅÆÂäõ„Åå‰ªäÊó•„ÅØÁßÅ„ÅåËºù„ÅèÊó•„Åß„ÅØ„Å™„ÅÑ„Å®Ê±∫„ÇÅ„Åæ„Åó„ÅüÔºÅ"
        ]
      }
    }
  };

  // Get excuses for current language (fallback to English)
  const getCurrentLanguageExcuses = () => {
    return multilingualExcuses[selectedLanguage] || multilingualExcuses.en;
  };

  // Get translations for current language (fallback to English)
  const t = translations[selectedLanguage] || translations.en;

  const sampleExcuses = getCurrentLanguageExcuses();

  // Excuse templates with placeholders
  const excuseTemplates = {
    work: {
      funny: [
        "My {pet} just {action} and I need to {solution} before I can join.",
        "I'm stuck in an elevator with {person} and we're having a {type_of_discussion}.",
        "My {device} decided to {malfunction} at the worst possible moment.",
        "I'm currently in a standoff with my {appliance} over {issue}."
      ],
      professional: [
        "I have an urgent {type_of_matter} with {entity} that requires immediate attention.",
        "Due to unexpected {situation}, I need to {action} before I can participate.",
        "I'm experiencing {technical_issue} and need {time_estimate} to resolve it.",
        "I have a {priority_level} {task_type} that I must complete first."
      ],
      believable: [
        "Traffic on {road_name} is backed up due to {reason}, I'll be {time_estimate} late.",
        "My {vehicle} has {problem} and I'm waiting for {solution}.",
        "I have a {family_relation} {emergency_type} that I need to handle.",
        "The {service_provider} has an outage in my area affecting {service}."
      ],
      dramatic: [
        "The {entity_type} of {location} are conspiring against my {goal} today!",
        "I'm trapped in a maze of {obstacle_type} with no {solution_type} in sight!",
        "My entire {time_period} has been a series of {event_type} events!",
        "The {force_type} have decided today is not my day to {achievement}!"
      ]
    },
    school: {
      funny: [
        "My {pet} just {action} my {school_item} and I need to {solution}.",
        "I got lost in my own {location} looking for my {item}.",
        "My {device} went on strike without {notice_type}.",
        "My {school_supply} is holding my {important_item} hostage."
      ],
      professional: [
        "I'm dealing with a {family_type} situation that requires my immediate attention.",
        "I have a {medical_type} appointment that ran longer than expected.",
        "Due to {transportation_issue}, I will be {time_estimate} late.",
        "I'm experiencing {technical_problem} that prevents me from {action}."
      ],
      believable: [
        "The {transport_method} was delayed due to {reason}.",
        "I had a {appointment_type} appointment that ran over.",
        "My {vehicle} broke down on {location}.",
        "I'm feeling {symptom} and don't want to spread {illness_type}."
      ],
      dramatic: [
        "My academic destiny hangs in the balance of {obstacle_type} failures!",
        "I'm battling the forces of {challenge_type} chaos!",
        "The educational {entity_type} have forsaken me this {time_period}!",
        "I'm trapped in a vortex of {event_type} disasters!"
      ]
    },
    date: {
      funny: [
        "My {clothing_item} is having an identity crisis and I need to {action}.",
        "My {service_provider} driver is giving me {advice_type}, this might take a while.",
        "I'm currently negotiating with my {body_part} about tonight's {event}.",
        "My {device} says {excuse_type} in retrograde, bad night to {activity}."
      ],
      professional: [
        "An urgent {work_type} matter came up that I need to handle.",
        "I have a {family_type} obligation I completely forgot about.",
        "Something unexpected came up that requires my immediate {action}.",
        "I'm not feeling {health_condition} enough to go out tonight."
      ],
      believable: [
        "{family_type} emergency, can we push {activity} to {time}?",
        "I'm running really late due to {reason}, can we reschedule?",
        "I'm not feeling {symptom}, I think I should stay in tonight.",
        "Something came up at {location}, I need to handle it first."
      ],
      dramatic: [
        "The forces of {entity_type} are conspiring against our {event_type} tonight!",
        "I'm caught in an epic battle between {obstacle1} and {obstacle2}!",
        "My {time_period} plans have been sabotaged by the {force_type} of {challenge}!",
        "The universe is clearly {action} our romantic {event_type} this evening!"
      ]
    }
  };

  const generateExcuse = async () => {
    try {
      console.log('generateExcuse called - isGenerating:', isGenerating);
      if (isGenerating) return; // Prevent multiple simultaneous generations
      
      // Check subscription limits
      const canGenerate = checkSubscriptionLimits('generate');
      console.log('Can generate:', canGenerate, 'subscriptionData:', subscriptionData);
      if (!canGenerate) {
        console.log('Subscription limits exceeded, showing subscription modal');
        setShowSubscription(true);
        return;
      }
      
      console.log('Starting excuse generation...');
      setIsGenerating(true);
      
      // Small delay for better UX
      await new Promise(resolve => setTimeout(resolve, 800));
      
      console.log('Current situation:', situation, 'Current tone:', tone);
      
      // Combine sample excuses with custom excuses
      let situationExcuses = sampleExcuses[situation as keyof typeof sampleExcuses];
      
      // Fallback mechanism for missing situations - use work excuses as default
      if (!situationExcuses) {
        console.log(`Situation '${situation}' not found, falling back to work`);
        situationExcuses = sampleExcuses['work'];
        
        // If work doesn't exist either, create basic fallback excuses
        if (!situationExcuses) {
          console.log('Work situation also missing, using emergency fallback');
          situationExcuses = {
            funny: ["Something unexpected came up!", "I'm dealing with a situation.", "Life happened!", "The universe has other plans for me."],
            professional: ["I have an urgent matter to attend to.", "Due to unforeseen circumstances, I cannot make it.", "I need to handle a priority issue.", "I have a conflict that requires my attention."],
            believable: ["I'm not feeling well.", "I have a family emergency.", "My transportation fell through.", "I have a prior commitment."],
            dramatic: ["The forces of chaos have conspired against me!", "I am battling unforeseen circumstances!", "Destiny has other plans!", "I am trapped in a whirlwind of obligations!"]
          };
        }
      }
      
      const customSituationExcuses = customExcuses[situation] || {};
      
      console.log('situationExcuses:', situationExcuses);
      console.log('customSituationExcuses:', customSituationExcuses);
      
      if (!situationExcuses) {
        console.error('No situation excuses found for situation:', situation);
        setIsGenerating(false);
        return; // Handle case where situation doesn't exist
      }
      
      let toneExcuses = situationExcuses[tone as keyof typeof situationExcuses] as string[];
      const customToneExcuses = customSituationExcuses[tone] || [];
      
      // Fallback mechanism for missing tones
      if (!toneExcuses || toneExcuses.length === 0) {
        console.log(`Tone '${tone}' not found for situation '${situation}', trying fallback tones`);
        // Try other tones in order of preference
        const fallbackTones: (keyof typeof situationExcuses)[] = ['professional', 'believable', 'funny', 'dramatic'];
        for (const fallbackTone of fallbackTones) {
          if (fallbackTone !== tone && situationExcuses[fallbackTone] && situationExcuses[fallbackTone].length > 0) {
            toneExcuses = situationExcuses[fallbackTone] as string[];
            console.log(`Using fallback tone '${fallbackTone}' for tone '${tone}'`);
            break;
          }
        }
        
        // If still no excuses, create generic ones based on tone
        if (!toneExcuses || toneExcuses.length === 0) {
          console.log(`Creating emergency excuses for tone '${tone}'`);
          switch (tone) {
            case 'funny':
              toneExcuses = ["Something hilariously unexpected happened!", "Life decided to be comedic today!", "I'm having a sitcom moment!"];
              break;
            case 'professional':
              toneExcuses = ["I have an urgent commitment.", "Due to circumstances beyond my control, I cannot attend.", "I need to address a priority matter."];
              break;
            case 'believable':
              toneExcuses = ["I'm not feeling well.", "I have a family situation.", "My transportation plans fell through."];
              break;
            case 'dramatic':
              toneExcuses = ["Fate has conspired against me!", "I am trapped in a whirlwind of chaos!", "The universe demands my attention elsewhere!"];
              break;
            default:
              toneExcuses = ["I cannot make it.", "Something came up.", "I have a conflict."];
          }
        }
      }
      
      console.log('toneExcuses:', toneExcuses);
      console.log('customToneExcuses:', customToneExcuses);
      
      if (!toneExcuses && customToneExcuses.length === 0) {
        console.error('No excuses found for tone:', tone);
        setIsGenerating(false);
        return; // Handle case where no excuses exist
      }
      
      // Combine all available excuses
      const allExcuses = [...(toneExcuses || []), ...customToneExcuses];
      console.log('allExcuses length:', allExcuses.length);
      console.log('allExcuses sample:', allExcuses.slice(0, 3));
      
      // Generate live data-enhanced excuse if location and live data are available
      let finalExcuse = '';
      if (useRealData && userLocation && (liveWeatherData || liveTrafficData)) {
        finalExcuse = generateLiveDataExcuse(situation, tone, liveWeatherData, liveTrafficData);
        console.log('Generated live data excuse:', finalExcuse);
      } else {
        // Use traditional random selection from available excuses
        
        // Get recently used excuses (last 10 or within last 10 minutes - reduced from 1 hour)
        const recentExcuses = excuseHistory
          .filter(entry => {
            const timeDiff = Date.now() - entry.timestamp.getTime();
            return timeDiff < 600000; // 10 minutes in milliseconds (reduced from 1 hour)
          })
          .map(entry => entry.excuse);
        
        console.log('recentExcuses:', recentExcuses);
        
        // Filter out recently used excuses
        let availableExcuses = allExcuses.filter((excuse: string) => !recentExcuses.includes(excuse));
        console.log('availableExcuses after filter:', availableExcuses.length);
        
        // If all excuses were recently used, use all excuses (reset the pool)
        if (availableExcuses.length === 0) {
          availableExcuses = [...allExcuses];
          console.log('All excuses were recent, resetting pool');
        }
        
        // For debugging - always ensure we have variety by shuffling the array
        const shuffled = [...availableExcuses].sort(() => Math.random() - 0.5);
        
        // Weight excuses based on ratings (highly rated excuses are more likely to be chosen)
        const weightedExcuses: string[] = [];
        for (const excuse of shuffled) {
          const rating = getExcuseRating(excuse);
          if (rating === 'up') {
            // Add highly-rated excuses 3 times to increase their chances
            weightedExcuses.push(excuse, excuse, excuse);
          } else if (rating === 'down') {
            // Add poorly-rated excuses only once (reduce their chances)
            weightedExcuses.push(excuse);
          } else {
            // Add unrated excuses twice (normal chance)
            weightedExcuses.push(excuse, excuse);
          }
        }
        
        // Add extra randomization - shuffle the weighted array
        const shuffledWeighted = [...weightedExcuses].sort(() => Math.random() - 0.5);
        
        // Select random excuse from weighted pool
        finalExcuse = shuffledWeighted[Math.floor(Math.random() * shuffledWeighted.length)];
        console.log('Selected from', shuffledWeighted.length, 'weighted options');
        console.log('Generated excuse:', finalExcuse);
      }
      
      // Add to history
      const newHistoryEntry = {
        excuse: finalExcuse,
        timestamp: new Date(),
        situation: situation,
        tone: tone
      };
      
      setExcuseHistory(prev => [newHistoryEntry, ...prev].slice(0, 50)); // Keep last 50 excuses
      setExcuse(finalExcuse);
      setCurrentExcuseRated(null); // Reset rating visual feedback for new excuse
      
      // Track usage analytics
      trackUsageAnalytics(situation, tone, finalExcuse);
      
      // Increment usage counter for subscription tracking
      incrementUsage('generate');
      
      // Track ad views and show ads for free users
      if (subscriptionTier === 'free') {
        setExcusesSinceAd(prev => prev + 1);
        showAdAfterExcuses(3); // Show interstitial ad every 3 excuses for free users
      }
      
      console.log('Excuse generation completed successfully');
      setIsGenerating(false);
    } catch (error) {
      console.error('Error in generateExcuse:', error);
      setIsGenerating(false);
    }
  };

  const saveFavorite = () => {
    if (excuse && !favorites.includes(excuse)) {
      setFavorites([...favorites, excuse]);
    }
  };

  const copyToClipboard = async (text: string) => {
    try {
      if (navigator.clipboard && window.isSecureContext) {
        // Modern browsers with secure context
        await navigator.clipboard.writeText(text);
      } else {
        // Fallback for older browsers or non-secure contexts
        const textArea = document.createElement("textarea");
        textArea.value = text;
        textArea.style.position = "fixed";
        textArea.style.left = "-999999px";
        textArea.style.top = "-999999px";
        document.body.appendChild(textArea);
        textArea.focus();
        textArea.select();
        document.execCommand('copy');
        textArea.remove();
      }
      setCopied(true);
      // Reset the copied state after 2 seconds
      setTimeout(() => setCopied(false), 2000);
    } catch (err) {
      console.error('Failed to copy text: ', err);
    }
  };

  const sendAsSMS = (text: string, phoneNumber?: string) => {
    // Clean the text for SMS - remove formatting characters
    const cleanText = text
      .replace(/‚îÅ/g, '-')  // Replace fancy line characters
      .replace(/üì±|üå©Ô∏è|üö®|üè•|‚õàÔ∏è|üí®|üßä|üåä/g, '')  // Remove emojis
      .replace(/\s+/g, ' ')  // Replace multiple spaces with single space
      .trim();
    
    // Create SMS URL with optional phone number
    const smsBody = encodeURIComponent(cleanText);
    const smsUrl = phoneNumber 
      ? `sms:${phoneNumber}?body=${smsBody}`
      : `sms:?body=${smsBody}`;
    
    try {
      // Open SMS app with pre-filled message
      window.open(smsUrl, '_self');
    } catch (err) {
      console.error('Failed to open SMS app: ', err);
      // Fallback: copy to clipboard
      copyToClipboard(cleanText);
    }
  };

  const sendAsEmail = async (content: string, recipientEmail: string) => {
    setEmailSending(true);
    try {
      // Create a simple, clean email format
      const subject = 'Medical Excuse Documentation';
      
      // Clean up the content for email
      let emailContent = content;
      
      // If it's an email format, clean it up
      if (content.includes('Subject:')) {
        emailContent = content.replace(/Subject:.*\n/, '').replace(/To:.*\n/, '').replace(/From:.*\n/, '').trim();
      }
      
      // Create mailto URL with simple encoding
      const mailtoUrl = `mailto:${recipientEmail}?subject=${encodeURIComponent(subject)}&body=${encodeURIComponent(emailContent)}`;
      
      // Try multiple methods to ensure it works
      try {
        // Method 1: Direct window location
        window.location.href = mailtoUrl;
      } catch (e) {
        // Method 2: Window.open as fallback
        window.open(mailtoUrl);
      }
      
      // Show success message
      alert('‚úÖ Email client should be opening now!\n\nIf your email client didn\'t open automatically:\n1. Copy the proof text below\n2. Create a new email\n3. Paste the content');
      
      setTimeout(() => {
        setEmailSending(false);
      }, 1000);
    } catch (error) {
      console.error('Error sending email:', error);
      alert('‚ùå Could not open email client automatically.\n\nPlease copy the proof text and paste it into your email manually.');
      setEmailSending(false);
    }
  };

  // Location and Live Data Functions
  const requestLocation = async () => {
    setIsLoadingLocation(true);
    
    if (!navigator.geolocation) {
      alert('Geolocation is not supported by this browser.');
      setLocationPermission('denied');
      setIsLoadingLocation(false);
      return;
    }

    try {
      const position = await new Promise<GeolocationPosition>((resolve, reject) => {
        navigator.geolocation.getCurrentPosition(resolve, reject, {
          enableHighAccuracy: true,
          timeout: 15000,
          maximumAge: 0 // Always get fresh location data
        });
      });

      const { latitude, longitude } = position.coords;
      const location: {
        lat: number, 
        lon: number, 
        city?: string,
        state?: string,
        country?: string,
        address?: string,
        neighborhood?: string
      } = { lat: latitude, lon: longitude };
      
      // Get detailed location info from coordinates using multiple sources
      try {
        // Try OpenWeatherMap reverse geocoding first
        const weatherResponse = await fetch(`https://api.openweathermap.org/geo/1.0/reverse?lat=${latitude}&lon=${longitude}&limit=1&appid=demo`);
        if (weatherResponse.ok) {
          const weatherData = await weatherResponse.json();
          if (weatherData[0]) {
            location.city = weatherData[0].name;
            location.state = weatherData[0].state;
            location.country = weatherData[0].country;
          }
        }
        
        // Try more detailed reverse geocoding with Nominatim (OpenStreetMap)
        try {
          const nominatimResponse = await fetch(
            `https://nominatim.openstreetmap.org/reverse?format=json&lat=${latitude}&lon=${longitude}&zoom=18&addressdetails=1`,
            {
              headers: {
                'User-Agent': 'ExcusesApp/1.0'
              }
            }
          );
          
          if (nominatimResponse.ok) {
            const nominatimData = await nominatimResponse.json();
            if (nominatimData && nominatimData.address) {
              const addr = nominatimData.address;
              
              // Extract detailed address components
              location.neighborhood = addr.neighbourhood || addr.suburb || addr.residential;
              location.city = location.city || addr.city || addr.town || addr.village;
              location.state = location.state || addr.state || addr.region;
              location.country = location.country || addr.country;
              
              // Create readable address
              const addressParts = [];
              if (addr.house_number && addr.road) {
                addressParts.push(`${addr.house_number} ${addr.road}`);
              } else if (addr.road) {
                addressParts.push(addr.road);
              }
              if (location.neighborhood && location.neighborhood !== location.city) {
                addressParts.push(location.neighborhood);
              }
              if (location.city) {
                addressParts.push(location.city);
              }
              if (location.state) {
                addressParts.push(location.state);
              }
              
              location.address = addressParts.filter(Boolean).join(', ');
            }
          }
        } catch (nominatimError) {
          console.log('Nominatim geocoding failed, using basic location');
        }
        
      } catch (e) {
        console.log('Could not get detailed location, using coordinates only');
        // Fallback: create basic location display from coordinates
        location.address = `Lat: ${latitude.toFixed(4)}, Lon: ${longitude.toFixed(4)}`;
      }

      setUserLocation(location);
      setLocationPermission('granted');
      
      // Automatically fetch live data
      await Promise.all([
        fetchLiveWeather(location),
        fetchLiveTraffic(location)
      ]);
      
    } catch (error) {
      console.error('Error getting location:', error);
      setLocationPermission('denied');
      alert('Location access denied. Using generic location data instead.');
    }
    
    setIsLoadingLocation(false);
  };

  const fetchLiveWeather = async (location: {
    lat: number, 
    lon: number, 
    city?: string,
    state?: string,
    country?: string,
    address?: string,
    neighborhood?: string
  }) => {
    try {
      // Using free weather API from weatherapi.com or open-meteo.com (no key required)
      const response = await fetch(`https://api.open-meteo.com/v1/forecast?latitude=${location.lat}&longitude=${location.lon}&current=temperature_2m,relative_humidity_2m,weather_code,wind_speed_10m,visibility&temperature_unit=fahrenheit&wind_speed_unit=mph&timezone=auto`);
      
      if (response.ok) {
        const data = await response.json();
        const current = data.current;
        
        // Weather code mapping for Open-Meteo
        const getWeatherDescription = (code: number) => {
          const weatherCodes: { [key: number]: { main: string, description: string } } = {
            0: { main: 'Clear', description: 'clear sky' },
            1: { main: 'Clouds', description: 'mainly clear' },
            2: { main: 'Clouds', description: 'partly cloudy' },
            3: { main: 'Clouds', description: 'overcast' },
            45: { main: 'Fog', description: 'fog' },
            48: { main: 'Fog', description: 'depositing rime fog' },
            51: { main: 'Drizzle', description: 'light drizzle' },
            53: { main: 'Drizzle', description: 'moderate drizzle' },
            55: { main: 'Drizzle', description: 'dense drizzle' },
            61: { main: 'Rain', description: 'slight rain' },
            63: { main: 'Rain', description: 'moderate rain' },
            65: { main: 'Rain', description: 'heavy rain' },
            71: { main: 'Snow', description: 'slight snow fall' },
            73: { main: 'Snow', description: 'moderate snow fall' },
            75: { main: 'Snow', description: 'heavy snow fall' },
            80: { main: 'Rain', description: 'slight rain showers' },
            81: { main: 'Rain', description: 'moderate rain showers' },
            82: { main: 'Rain', description: 'violent rain showers' },
            95: { main: 'Thunderstorm', description: 'thunderstorm' },
            96: { main: 'Thunderstorm', description: 'thunderstorm with slight hail' },
            99: { main: 'Thunderstorm', description: 'thunderstorm with heavy hail' }
          };
          return weatherCodes[code] || { main: 'Unknown', description: 'unknown weather' };
        };
        
        const weather = getWeatherDescription(current.weather_code);
        
        setLiveWeatherData({
          condition: weather.main,
          description: weather.description,
          temperature: Math.round(current.temperature_2m),
          humidity: current.relative_humidity_2m,
          windSpeed: Math.round(current.wind_speed_10m),
          visibility: current.visibility / 1000, // Convert to km
          city: location.city || location.address || 'Your Location'
        });
      } else {
        // Fallback to mock data if API fails
        setLiveWeatherData({
          condition: 'Rain',
          description: 'heavy rain',
          temperature: 46, // 46¬∞F 
          humidity: 95,
          windSpeed: 25,
          visibility: 0.5,
          city: location.city || location.address || 'Your Location'
        });
      }
    } catch (error) {
      console.log('Using mock weather data');
      // Mock realistic weather data as fallback
      setLiveWeatherData({
        condition: 'Thunderstorm',
        description: 'severe thunderstorm with heavy rain',
        temperature: 54, // 54¬∞F 
        humidity: 98,
        windSpeed: 45,
        visibility: 0.2,
        city: location.city || location.address || 'Your Location'
      });
    }
  };

  const fetchLiveTraffic = async (location: {
    lat: number, 
    lon: number, 
    city?: string,
    state?: string,
    country?: string,
    address?: string,
    neighborhood?: string
  }) => {
    try {
      // Get local roads using OpenStreetMap/Nominatim API for nearby roads
      const nearbyResponse = await fetch(
        `https://nominatim.openstreetmap.org/reverse?format=json&lat=${location.lat}&lon=${location.lon}&zoom=16&addressdetails=1`,
        {
          headers: {
            'User-Agent': 'ExcusesApp/1.0'
          }
        }
      );
      
      let localStreets: string[] = [];
      if (nearbyResponse.ok) {
        const data = await nearbyResponse.json();
        if (data?.address) {
          // Extract local street names
          const addr = data.address;
          if (addr.road) localStreets.push(addr.road);
          
          // Get nearby roads using Overpass API (OpenStreetMap)
          try {
            const overpassQuery = `
              [out:json][timeout:5];
              (
                way["highway"~"^(primary|secondary|tertiary|residential|trunk)$"](around:1000,${location.lat},${location.lon});
              );
              out geom;
            `;
            
            const overpassResponse = await fetch('https://overpass-api.de/api/interpreter', {
              method: 'POST',
              body: overpassQuery,
              headers: {
                'Content-Type': 'text/plain'
              }
            });
            
            if (overpassResponse.ok) {
              const overpassData = await overpassResponse.json();
              const nearbyRoads = overpassData.elements
                .map((way: any) => way.tags?.name)
                .filter((name: string) => name && !localStreets.includes(name))
                .slice(0, 3); // Get up to 3 additional roads
              
              localStreets.push(...nearbyRoads);
            }
          } catch (e) {
            console.log('Could not fetch nearby roads from Overpass API');
          }
        }
      }
      
      // Fallback to common street names if no local streets found
      if (localStreets.length === 0) {
        localStreets = ['Main Street', 'Oak Avenue', 'First Street'];
      }
      
      // Create realistic traffic scenarios using actual local streets
      const trafficTypes = ['accident', 'construction', 'weather_related', 'heavy_traffic', 'road_closure'];
      const selectedType = trafficTypes[Math.floor(Math.random() * trafficTypes.length)];
      const selectedStreet = localStreets[Math.floor(Math.random() * localStreets.length)];
      
      const scenarios = {
        accident: {
          type: 'accident',
          location: selectedStreet,
          description: `Multi-vehicle accident on ${selectedStreet} blocking lanes`,
          delay: `${15 + Math.floor(Math.random() * 45)} minutes`,
          distance: `${0.1 + Math.random() * 2}`.slice(0,3) + ' miles from current location'
        },
        construction: {
          type: 'construction',
          location: selectedStreet,
          description: `Road construction on ${selectedStreet} - single lane traffic`,
          delay: `${10 + Math.floor(Math.random() * 30)} minutes`,
          distance: `${0.2 + Math.random() * 1.5}`.slice(0,3) + ' miles from current location'
        },
        weather_related: {
          type: 'weather_related',
          location: selectedStreet,
          description: `Weather-related hazards on ${selectedStreet} - reduced visibility`,
          delay: `${20 + Math.floor(Math.random() * 40)} minutes`,
          distance: `${0.1 + Math.random() * 1.2}`.slice(0,3) + ' miles from current location'
        },
        heavy_traffic: {
          type: 'heavy_traffic',
          location: selectedStreet,
          description: `Heavy congestion on ${selectedStreet} during rush hour`,
          delay: `${15 + Math.floor(Math.random() * 35)} minutes`,
          distance: `${0.2 + Math.random() * 1.8}`.slice(0,3) + ' miles from current location'
        },
        road_closure: {
          type: 'road_closure',
          location: selectedStreet,
          description: `${selectedStreet} closed due to emergency maintenance`,
          delay: `${30 + Math.floor(Math.random() * 45)} minutes detour required`,
          distance: `${0.1 + Math.random() * 1}`.slice(0,3) + ' miles from current location'
        }
      };
      
      setLiveTrafficData(scenarios[selectedType as keyof typeof scenarios]);
      
    } catch (error) {
      console.log('Using fallback traffic data');
      setLiveTrafficData({
        type: 'accident',
        location: location.address?.split(',')[0] || 'Main Street',
        description: `Traffic incident on ${location.address?.split(',')[0] || 'Main Street'} causing delays`,
        delay: `${15 + Math.floor(Math.random() * 30)} minutes`,
        distance: '0.5 miles from current location'
      });
    }
  };

  const generateLiveDataExcuse = (situation: string, tone: string, weather: any, traffic: any) => {
    // Create more specific location description
    const getLocationDescription = () => {
      if (userLocation?.neighborhood && userLocation?.city) {
        return `${userLocation.neighborhood}, ${userLocation.city}`;
      }
      if (userLocation?.city && userLocation?.state) {
        return `${userLocation.city}, ${userLocation.state}`;
      }
      if (userLocation?.city) {
        return userLocation.city;
      }
      if (weather?.city) {
        return weather.city;
      }
      return 'my area';
    };

    const city = getLocationDescription();
    const specificArea = userLocation?.address || city;
    const templates = {
      weather: {
        professional: [
          `Due to severe ${weather.description} in ${city}, I cannot safely travel to the office. Visibility is only ${weather.visibility}km and wind speeds are ${weather.windSpeed}km/h.`,
          `The current weather conditions in ${city} (${weather.description}, ${weather.temperature}¬∞F) make it unsafe to travel. I will work from home today.`,
          `Weather alert in ${city}: ${weather.description} with ${weather.humidity}% humidity. I need to stay home for safety reasons.`,
          `I'm currently at ${specificArea} and the weather conditions (${weather.description}, ${weather.temperature}¬∞F) make travel unsafe. Working remotely today.`
        ],
        believable: [
          `I'm stuck at home because of the ${weather.description} in ${city}. Roads are not safe with only ${weather.visibility}km visibility.`,
          `Can't make it in today - there's ${weather.description} and it's only ${weather.temperature}¬∞F outside. Too dangerous to drive.`,
          `The weather is terrible here in ${city} (${weather.description}). I don't feel safe driving in these conditions.`,
          `I'm at ${specificArea} and can't get out due to the ${weather.description}. Roads are impassable with ${weather.temperature}¬∞F weather.`
        ],
        funny: [
          `Mother Nature decided to have a tantrum in ${city} today! There's ${weather.description} and I'm not brave enough to face her wrath.`,
          `The weather gods are angry in ${city} - it's ${weather.temperature}¬∞F with ${weather.description}. I'm staying inside like a smart human!`,
          `Current weather in ${city}: ${weather.description}. My car and I have decided to stay in hibernation mode today!`
        ],
        dramatic: [
          `The heavens have unleashed their fury upon ${city}! With ${weather.description} and winds of ${weather.windSpeed}km/h, I am trapped by nature's wrath!`,
          `I am held captive by the storm gods in ${city}! The ${weather.description} makes travel impossible - visibility is a mere ${weather.visibility}km!`,
          `The elements conspire against me in ${city}! ${weather.description} at ${weather.temperature}¬∞F - I cannot battle such forces of nature!`
        ]
      },
      traffic: {
        professional: [
          `I'm experiencing significant delays due to a ${traffic.description} on ${traffic.location}. The estimated delay is ${traffic.delay}, which will make me very late.`,
          `There's a major traffic incident (${traffic.description}) ${traffic.distance}. Current delay time is ${traffic.delay}. I'll work from home instead.`,
          `Traffic conditions are severe today - ${traffic.description} on ${traffic.location}. I'm looking at a ${traffic.delay} delay.`
        ],
        believable: [
          `I'm stuck in traffic due to ${traffic.description} on ${traffic.location}. It's going to be at least a ${traffic.delay} delay.`,
          `There's a big accident ${traffic.distance} that's causing ${traffic.delay} delays. I'm not going to make it on time.`,
          `Traffic is completely backed up because of ${traffic.description}. Looking at ${traffic.delay} just to get through.`
        ],
        funny: [
          `I'm currently part of the world's slowest parade on ${traffic.location}! There's ${traffic.description} and I've moved 3 feet in 20 minutes.`,
          `The highway has turned into a parking lot thanks to ${traffic.description}. I'm thinking of setting up camp here for ${traffic.delay}!`,
          `I'm experiencing the joy of ${traffic.description} on ${traffic.location}. At this rate, I'll arrive sometime next week!`
        ],
        dramatic: [
          `I am trapped in a vehicular prison on ${traffic.location}! The ${traffic.description} has created a ${traffic.delay} nightmare of epic proportions!`,
          `The traffic gods have cursed ${traffic.location} with ${traffic.description}! I am but a prisoner in this ${traffic.delay} ordeal!`,
          `Behold! The great ${traffic.description} has transformed ${traffic.location} into a monument to human suffering! I face ${traffic.delay} of torment!`
        ]
      }
    };

    // Choose weather or traffic based on what's more severe/interesting
    let selectedData, selectedType;
    if (weather && traffic) {
      // Prefer severe weather conditions or major traffic incidents
      if ((weather.windSpeed > 30 || weather.visibility < 1) || traffic.delay.includes('60')) {
        selectedData = weather.windSpeed > 30 || weather.visibility < 1 ? weather : traffic;
        selectedType = weather.windSpeed > 30 || weather.visibility < 1 ? 'weather' : 'traffic';
      } else {
        // Random selection if both are moderate
        selectedType = Math.random() > 0.5 ? 'weather' : 'traffic';
        selectedData = selectedType === 'weather' ? weather : traffic;
      }
    } else {
      selectedData = weather || traffic;
      selectedType = weather ? 'weather' : 'traffic';
    }

    const typeTemplates = templates[selectedType as keyof typeof templates];
    const toneTemplates = typeTemplates[tone as keyof typeof typeTemplates] || typeTemplates.professional;
    
    return toneTemplates[Math.floor(Math.random() * toneTemplates.length)];
  };

  // Subscription Management Functions
  const checkSubscriptionLimits = (action: 'generate' | 'custom' | 'template') => {
    const today = new Date().toDateString();
    const lastReset = new Date(subscriptionData.usage.lastReset).toDateString();
    
    // Reset daily usage if it's a new day
    if (today !== lastReset) {
      setSubscriptionData(prev => ({
        ...prev,
        usage: {
          ...prev.usage,
          excusesToday: 0,
          lastReset: new Date(),
        }
      }));
    }
    
    const { features, usage } = subscriptionData;
    
    switch (action) {
      case 'generate':
        if (features.dailyExcuseLimit === -1) return true; // Unlimited
        return usage.excusesToday < features.dailyExcuseLimit;
      case 'custom':
        if (features.customExcusesLimit === -1) return true; // Unlimited
        return usage.customExcusesCreated < features.customExcusesLimit;
      case 'template':
        if (features.templatesLimit === -1) return true; // Unlimited
        return usage.templatesUsed < features.templatesLimit;
      default:
        return false;
    }
  };

  const incrementUsage = (action: 'generate' | 'custom' | 'template') => {
    setSubscriptionData(prev => ({
      ...prev,
      usage: {
        ...prev.usage,
        excusesToday: action === 'generate' ? prev.usage.excusesToday + 1 : prev.usage.excusesToday,
        customExcusesCreated: action === 'custom' ? prev.usage.customExcusesCreated + 1 : prev.usage.customExcusesCreated,
        templatesUsed: action === 'template' ? prev.usage.templatesUsed + 1 : prev.usage.templatesUsed,
      }
    }));
  };

  const hasFeature = (feature: keyof typeof subscriptionData.features) => {
    return subscriptionData.features[feature];
  };

  const upgradeSubscription = (newTier: 'pro' | 'premium') => {
    const tierConfig = subscriptionTiers[newTier];
    setSubscriptionData(prev => ({
      ...prev,
      tier: newTier,
      features: tierConfig.features,
      startDate: new Date(),
      expiryDate: new Date(Date.now() + 30 * 24 * 60 * 60 * 1000), // 30 days from now
    }));
    setSubscriptionTier(newTier);
    
    // Automatically unlock premium features for both Pro and Premium tiers
    setIsPremium(true);
    safeLocalStorage.setItem('isPremium', 'true');
    safeLocalStorage.setItem('subscriptionTier', newTier);
    
    setShowSubscription(false);
    setShowAd(false); // Hide ads for premium users
    setAdDismissed(true); // Dismiss any existing ads
    
    // Show success message
    console.log(`Successfully upgraded to ${newTier} tier with premium features unlocked!`);
  };

  const getRemainingUsage = () => {
    const { features, usage } = subscriptionData;
    return {
      excuses: features.dailyExcuseLimit === -1 ? 'Unlimited' : `${Math.max(0, features.dailyExcuseLimit - usage.excusesToday)} left today`,
      customExcuses: features.customExcusesLimit === -1 ? 'Unlimited' : `${Math.max(0, features.customExcusesLimit - usage.customExcusesCreated)} remaining`,
      templates: features.templatesLimit === -1 ? 'Unlimited' : `${Math.max(0, features.templatesLimit - usage.templatesUsed)} remaining`,
    };
  };

  // Ad Management Functions
  const shouldShowAd = () => {
    // Always show banner ads for free users unless dismissed in the last 5 minutes
    return subscriptionTier === 'free' && !adDismissed;
  };

  const shouldShowBannerAd = () => {
    // Always show banner ad for free users (separate from interstitial logic)
    return subscriptionTier === 'free';
  };

  const showAdAfterExcuses = (count: number) => {
    if (subscriptionTier === 'free' && excusesSinceAd >= count) {
      setShowAd(true);
      setAdType('interstitial');
      setExcusesSinceAd(0);
    }
  };

  const dismissAd = () => {
    setShowAd(false);
    setAdDismissed(true);
    // Reset ad dismissal after 5 minutes for banner ads
    setTimeout(() => setAdDismissed(false), 5 * 60 * 1000);
  };

  const trackAdView = () => {
    // In a real app, this would track ad impressions for analytics
    console.log('Ad viewed by free tier user');
  };

  const resetDailyUsage = () => {
    setSubscriptionData(prev => ({
      ...prev,
      usage: {
        ...prev.usage,
        excusesToday: 0,
        lastReset: new Date(),
      }
    }));
  };

  const shareViaSMS = (text: string) => {
    const message = encodeURIComponent(`Check out this excuse: "${text}" üòÑ`);
    window.open(`sms:?body=${message}`, '_self');
  };

  const shareViaEmail = (text: string) => {
    const subject = encodeURIComponent('Perfect Excuse for You!');
    const body = encodeURIComponent(`Hey! I found the perfect excuse for you:\n\n"${text}"\n\nüòÑ Pretty good, right? Generated with Excuses, Excuses!`);
    window.open(`mailto:?subject=${subject}&body=${body}`, '_self');
  };

  const shareViaTwitter = (text: string) => {
    const tweet = encodeURIComponent(`"${text}" üòÇ #ExcusesExcuses #PerfectExcuse`);
    window.open(`https://twitter.com/intent/tweet?text=${tweet}`, '_blank');
  };

  const shareViaFacebook = (text: string) => {
    const quote = encodeURIComponent(`Check out this perfect excuse: "${text}"`);
    window.open(`https://www.facebook.com/sharer/sharer.php?u=${encodeURIComponent(window.location.href)}&quote=${quote}`, '_blank');
  };

  const shareViaWhatsApp = (text: string) => {
    const message = encodeURIComponent(`Check out this excuse: "${text}" üòÑ`);
    window.open(`https://wa.me/?text=${message}`, '_blank');
  };

  const shareNative = async (text: string) => {
    if (typeof navigator !== 'undefined' && 'share' in navigator && navigator.share) {
      try {
        await navigator.share({
          title: 'Perfect Excuse!',
          text: `"${text}" üòÑ`,
          url: window.location.href
        });
      } catch (err) {
        console.log('Native sharing was cancelled or failed');
      }
    } else {
      // Fallback to showing the share screen
      setShowShare(true);
    }
  };

  const rateExcuse = (excuse: string, rating: 'up' | 'down') => {
    setExcuseRatings(prev => ({
      ...prev,
      [excuse]: {
        rating,
        timestamp: new Date()
      }
    }));
    setCurrentExcuseRated(rating);
    
    // Track rating in analytics
    trackExcuseRating(excuse, rating);
    
    // Auto-clear rating visual feedback after 2 seconds
    setTimeout(() => {
      setCurrentExcuseRated(null);
    }, 2000);
  };

  const getExcuseRating = (excuse: string): 'up' | 'down' | null => {
    return excuseRatings[excuse]?.rating || null;
  };

  const getRatingStats = () => {
    const ratings = Object.values(excuseRatings);
    const upCount = ratings.filter(r => r.rating === 'up').length;
    const downCount = ratings.filter(r => r.rating === 'down').length;
    const totalRatings = upCount + downCount;
    
    return {
      upCount,
      downCount,
      totalRatings,
      percentage: totalRatings > 0 ? Math.round((upCount / totalRatings) * 100) : 0
    };
  };

  const getTopRatedExcuses = () => {
    return Object.entries(excuseRatings)
      .filter(([_, data]) => data.rating === 'up')
      .sort((a, b) => b[1].timestamp.getTime() - a[1].timestamp.getTime())
      .slice(0, 5)
      .map(([excuse]) => excuse);
  };

  // Analytics and tracking functions
  const trackUsageAnalytics = (situation: string, tone: string, excuse: string) => {
    const combinationKey = `${situation}-${tone}`;
    
    // Update usage statistics
    setUsageStats(prev => ({
      situationCounts: {
        ...prev.situationCounts,
        [situation]: (prev.situationCounts[situation] || 0) + 1
      },
      toneCounts: {
        ...prev.toneCounts,
        [tone]: (prev.toneCounts[tone] || 0) + 1
      },
      combinationCounts: {
        ...prev.combinationCounts,
        [combinationKey]: (prev.combinationCounts[combinationKey] || 0) + 1
      },
      totalGenerations: prev.totalGenerations + 1
    }));
    
    // Update excuse analytics
    setExcuseAnalytics(prev => ({
      ...prev,
      [excuse]: {
        timesGenerated: (prev[excuse]?.timesGenerated || 0) + 1,
        timesRated: prev[excuse]?.timesRated || 0,
        positiveRatings: prev[excuse]?.positiveRatings || 0,
        negativeRatings: prev[excuse]?.negativeRatings || 0,
        averageRating: prev[excuse]?.averageRating || 0,
        effectiveness: calculateExcuseEffectiveness(excuse, prev[excuse]),
        lastUsed: new Date(),
        situation,
        tone
      }
    }));
  };

  const trackExcuseRating = (excuse: string, rating: 'up' | 'down') => {
    setExcuseAnalytics(prev => {
      const currentData = prev[excuse];
      if (!currentData) return prev;
      
      const newPositive = currentData.positiveRatings + (rating === 'up' ? 1 : 0);
      const newNegative = currentData.negativeRatings + (rating === 'down' ? 1 : 0);
      const newTotalRated = currentData.timesRated + 1;
      
      return {
        ...prev,
        [excuse]: {
          ...currentData,
          timesRated: newTotalRated,
          positiveRatings: newPositive,
          negativeRatings: newNegative,
          averageRating: newTotalRated > 0 ? newPositive / newTotalRated : 0,
          effectiveness: calculateExcuseEffectiveness(excuse, {
            ...currentData,
            timesRated: newTotalRated,
            positiveRatings: newPositive,
            negativeRatings: newNegative
          })
        }
      };
    });
  };

  const calculateExcuseEffectiveness = (excuse: string, data?: any) => {
    if (!data || data.timesRated === 0) return 0.5; // Neutral rating for unrated excuses
    
    const ratingScore = data.averageRating || (data.positiveRatings / data.timesRated);
    const usageScore = Math.min(data.timesGenerated / 10, 1); // Normalize usage to 0-1 scale
    const recentUsageBonus = data.lastUsed && (Date.now() - new Date(data.lastUsed).getTime()) < 86400000 ? 0.1 : 0;
    
    // Weighted effectiveness score
    return Math.min((ratingScore * 0.6) + (usageScore * 0.3) + recentUsageBonus, 1);
  };

  const getMostPopularSituation = () => {
    const counts = usageStats.situationCounts;
    return Object.keys(counts).length > 0 
      ? Object.entries(counts).sort(([,a], [,b]) => b - a)[0][0]
      : 'work';
  };

  const getMostPopularTone = () => {
    const counts = usageStats.toneCounts;
    return Object.keys(counts).length > 0 
      ? Object.entries(counts).sort(([,a], [,b]) => b - a)[0][0]
      : 'funny';
  };

  const getTopPerformingExcuses = () => {
    return Object.entries(excuseAnalytics)
      .filter(([_, data]) => data.timesRated > 0)
      .sort(([,a], [,b]) => b.effectiveness - a.effectiveness)
      .slice(0, 5)
      .map(([excuse, data]) => ({ excuse, ...data }));
  };

  const getLeastPopularCombinations = () => {
    const allCombinations = ['work-funny', 'work-professional', 'work-believable', 'work-dramatic',
                             'school-funny', 'school-professional', 'school-believable', 'school-dramatic',
                             'date-funny', 'date-professional', 'date-believable', 'date-dramatic'];
    
    return allCombinations
      .map(combo => ({ combo, count: usageStats.combinationCounts[combo] || 0 }))
      .sort((a, b) => a.count - b.count)
      .slice(0, 3);
  };

  const initializeABTest = () => {
    // Simple A/B test for excuse variations
    const testId = 'excuse-effectiveness-test';
    const userGroup = Math.random() > 0.5 ? 'A' : 'B';
    
    setAbTestGroups(prev => ({
      ...prev,
      [testId]: {
        variantA: ['I\'m stuck in traffic', 'My car broke down', 'The train is delayed'],
        variantB: ['Traffic is unusually heavy today', 'I\'m experiencing vehicle troubles', 'Public transport is running behind'],
        userGroup,
        results: prev[testId]?.results || {
          A: { generations: 0, ratings: 0, positiveRatings: 0 },
          B: { generations: 0, ratings: 0, positiveRatings: 0 }
        }
      }
    }));
  };

  // Custom excuse functions
  const addCustomExcuse = () => {
    if (!newCustomExcuse.trim()) return;
    
    setCustomExcuses(prev => {
      const newExcuses = { ...prev };
      if (!newExcuses[customSituation]) {
        newExcuses[customSituation] = {};
      }
      if (!newExcuses[customSituation][customTone]) {
        newExcuses[customSituation][customTone] = [];
      }
      newExcuses[customSituation][customTone] = [
        ...newExcuses[customSituation][customTone],
        newCustomExcuse.trim()
      ];
      return newExcuses;
    });
    
    setNewCustomExcuse("");
    setShowCustomExcuse(false);
  };

  const deleteCustomExcuse = (excuse: string, situation: string, tone: string) => {
    setCustomExcuses(prev => {
      const newExcuses = { ...prev };
      if (newExcuses[situation] && newExcuses[situation][tone]) {
        newExcuses[situation][tone] = newExcuses[situation][tone].filter(e => e !== excuse);
        
        // Clean up empty arrays and objects
        if (newExcuses[situation][tone].length === 0) {
          delete newExcuses[situation][tone];
        }
        if (Object.keys(newExcuses[situation]).length === 0) {
          delete newExcuses[situation];
        }
      }
      return newExcuses;
    });
  };

  // Template functions
  const generateFromTemplate = (template: string) => {
    const placeholders = template.match(/{([^}]+)}/g) || [];
    let generatedExcuse = template;
    
    placeholders.forEach(placeholder => {
      const key = placeholder.slice(1, -1); // Remove { and }
      const value = templateValues[key] || '[FILL IN]';
      generatedExcuse = generatedExcuse.replace(placeholder, value);
    });
    
    return generatedExcuse;
  };

  const fillTemplate = (templateExcuse: string) => {
    setExcuse(generateFromTemplate(templateExcuse));
    // Add to history
    const historyEntry = {
      excuse: generateFromTemplate(templateExcuse),
      timestamp: new Date(),
      situation,
      tone
    };
    setExcuseHistory(prev => [historyEntry, ...prev].slice(0, 50));
    setShowTemplates(false);
  };

  // Export functions
  const exportFavorites = (format: 'txt' | 'json' | 'csv') => {
    let content = '';
    let filename = '';
    let mimeType = '';

    switch (format) {
      case 'txt':
        content = favorites.join('\n');
        filename = 'favorite-excuses.txt';
        mimeType = 'text/plain';
        break;
      case 'json':
        content = JSON.stringify({
          favorites,
          exportDate: new Date().toISOString(),
          totalCount: favorites.length
        }, null, 2);
        filename = 'favorite-excuses.json';
        mimeType = 'application/json';
        break;
      case 'csv':
        content = 'Excuse,Date Added\n' + 
          favorites.map((excuse, index) => `"${excuse.replace(/"/g, '""')}","${new Date().toISOString()}"`).join('\n');
        filename = 'favorite-excuses.csv';
        mimeType = 'text/csv';
        break;
    }

    const blob = new Blob([content], { type: mimeType });
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url;
    a.download = filename;
    document.body.appendChild(a);
    a.click();
    document.body.removeChild(a);
    URL.revokeObjectURL(url);
  };

  const exportHistory = (format: 'txt' | 'json' | 'csv') => {
    let content = '';
    let filename = '';
    let mimeType = '';

    switch (format) {
      case 'txt':
        content = excuseHistory.map((entry, index) => 
          `${index + 1}. ${entry.excuse}\n   Date: ${entry.timestamp.toLocaleDateString()}\n   Context: ${entry.situation} - ${entry.tone}\n`
        ).join('\n');
        filename = 'excuse-history.txt';
        mimeType = 'text/plain';
        break;
      case 'json':
        content = JSON.stringify({
          history: excuseHistory,
          exportDate: new Date().toISOString(),
          totalCount: excuseHistory.length
        }, null, 2);
        filename = 'excuse-history.json';
        mimeType = 'application/json';
        break;
      case 'csv':
        content = 'Excuse,Date,Situation,Tone\n' + 
          excuseHistory.map(entry => 
            `"${entry.excuse.replace(/"/g, '""')}","${entry.timestamp.toISOString()}","${entry.situation}","${entry.tone}"`
          ).join('\n');
        filename = 'excuse-history.csv';
        mimeType = 'text/csv';
        break;
    }

    const blob = new Blob([content], { type: mimeType });
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url;
    a.download = filename;
    document.body.appendChild(a);
    a.click();
    document.body.removeChild(a);
    URL.revokeObjectURL(url);
  };

  // Function to get random incident descriptions in different languages
  const getRandomIncidentDescription = (language: string) => {
    const incidents = {
      en: [
        'Major multi-vehicle collision blocking multiple lanes',
        'Jackknifed semi-truck causing major delays',
        'Vehicle fire with emergency response ongoing',
        'Police investigation blocking traffic flow',
        'Emergency road repairs in progress',
        'Overturned vehicle blocking left lanes',
        'Hazmat spill requiring specialized cleanup',
        'Construction zone accident with injuries',
        'Disabled commercial vehicle blocking traffic',
        'Bridge maintenance reducing lanes',
        'Weather-related incident affecting visibility',
        'Emergency medical response blocking lanes',
        'Debris removal operation in progress',
        'Utility line work requiring lane closures',
        'Traffic signal malfunction causing backups'
      ],
      es: [
        'Colisi√≥n mayor de m√∫ltiples veh√≠culos bloqueando varios carriles',
        'Cami√≥n volcado causando grandes retrasos',
        'Incendio vehicular con respuesta de emergencia',
        'Investigaci√≥n policial bloqueando el tr√°fico',
        'Reparaciones de emergencia en progreso',
        'Veh√≠culo volcado bloqueando carriles izquierdos',
        'Derrame de materiales peligrosos requiriendo limpieza',
        'Accidente en zona de construcci√≥n con heridos',
        'Veh√≠culo comercial averiado bloqueando tr√°fico',
        'Mantenimiento de puente reduciendo carriles'
      ],
      fr: [
        'Collision majeure de v√©hicules multiples bloquant plusieurs voies',
        'Camion renvers√© causant des retards majeurs',
        'Incendie de v√©hicule avec intervention d\'urgence',
        'Enqu√™te polici√®re bloquant la circulation',
        'R√©parations routi√®res d\'urgence en cours',
        'V√©hicule renvers√© bloquant les voies de gauche',
        'D√©versement de mati√®res dangereuses n√©cessitant nettoyage',
        'Accident en zone de construction avec bless√©s',
        'V√©hicule commercial en panne bloquant circulation',
        'Maintenance de pont r√©duisant les voies'
      ],
      de: [
        'Schwerer Mehrfahrzeug-Unfall blockiert mehrere Spuren',
        'Umgest√ºrzter LKW verursacht gro√üe Verz√∂gerungen',
        'Fahrzeugbrand mit laufendem Notfalleinsatz',
        'Polizeiermittlung blockiert Verkehrsfluss',
        'Notfall-Stra√üenreparaturen im Gange',
        'Umgest√ºrztes Fahrzeug blockiert linke Spuren',
        'Gefahrgut-Versch√ºttung erfordert Spezialreinigung',
        'Baustellenunfall mit Verletzten',
        'Liegengebliebenes Nutzfahrzeug blockiert Verkehr',
        'Br√ºckenwartung reduziert Fahrspuren'
      ],
      it: [
        'Grave collisione multipla che blocca diverse corsie',
        'Camion ribaltato che causa gravi ritardi',
        'Incendio veicolare con intervento di emergenza',
        'Indagine di polizia che blocca il traffico',
        'Riparazioni stradali di emergenza in corso',
        'Veicolo ribaltato che blocca corsie di sinistra',
        'Sversamento materiali pericolosi richiede pulizia',
        'Incidente in zona cantiere con feriti',
        'Veicolo commerciale in panne blocca traffico',
        'Manutenzione ponte riduce corsie'
      ],
      pt: [
        'Grave colis√£o de m√∫ltiplos ve√≠culos bloqueando v√°rias faixas',
        'Caminh√£o tombado causando grandes atrasos',
        'Inc√™ndio veicular com resposta de emerg√™ncia',
        'Investiga√ß√£o policial bloqueando tr√°fego',
        'Reparos rodovi√°rios de emerg√™ncia em andamento',
        'Ve√≠culo capotado bloqueando faixas esquerdas',
        'Vazamento de materiais perigosos requer limpeza',
        'Acidente em zona de constru√ß√£o com feridos',
        'Ve√≠culo comercial quebrado bloqueia tr√°fego',
        'Manuten√ß√£o de ponte reduzindo faixas'
      ],
      ru: [
        '–°–µ—Ä—å–µ–∑–Ω–æ–µ —Å—Ç–æ–ª–∫–Ω–æ–≤–µ–Ω–∏–µ –Ω–µ—Å–∫–æ–ª—å–∫–∏—Ö –∞–≤—Ç–æ–º–æ–±–∏–ª–µ–π –±–ª–æ–∫–∏—Ä—É–µ—Ç –Ω–µ—Å–∫–æ–ª—å–∫–æ –ø–æ–ª–æ—Å',
        '–ü–µ—Ä–µ–≤–µ—Ä–Ω—É–≤—à–∏–π—Å—è –≥—Ä—É–∑–æ–≤–∏–∫ –≤—ã–∑—ã–≤–∞–µ—Ç —Å–µ—Ä—å–µ–∑–Ω—ã–µ –∑–∞–¥–µ—Ä–∂–∫–∏',
        '–ü–æ–∂–∞—Ä —Ç—Ä–∞–Ω—Å–ø–æ—Ä—Ç–Ω–æ–≥–æ —Å—Ä–µ–¥—Å—Ç–≤–∞ —Å –∞–≤–∞—Ä–∏–π–Ω—ã–º —Ä–µ–∞–≥–∏—Ä–æ–≤–∞–Ω–∏–µ–º',
        '–ü–æ–ª–∏—Ü–µ–π—Å–∫–æ–µ —Ä–∞—Å—Å–ª–µ–¥–æ–≤–∞–Ω–∏–µ –±–ª–æ–∫–∏—Ä—É–µ—Ç –¥–≤–∏–∂–µ–Ω–∏–µ',
        '–ê–≤–∞—Ä–∏–π–Ω—ã–π —Ä–µ–º–æ–Ω—Ç –¥–æ—Ä–æ–≥–∏ –≤ –ø—Ä–æ—Ü–µ—Å—Å–µ',
        '–ü–µ—Ä–µ–≤–µ—Ä–Ω—É—Ç–æ–µ —Ç—Ä–∞–Ω—Å–ø–æ—Ä—Ç–Ω–æ–µ —Å—Ä–µ–¥—Å—Ç–≤–æ –±–ª–æ–∫–∏—Ä—É–µ—Ç –ª–µ–≤—ã–µ –ø–æ–ª–æ—Å—ã',
        '–†–∞–∑–ª–∏–≤ –æ–ø–∞—Å–Ω—ã—Ö –º–∞—Ç–µ—Ä–∏–∞–ª–æ–≤ —Ç—Ä–µ–±—É–µ—Ç –æ—á–∏—Å—Ç–∫–∏',
        '–ê–≤–∞—Ä–∏—è –≤ –∑–æ–Ω–µ —Å—Ç—Ä–æ–∏—Ç–µ–ª—å—Å—Ç–≤–∞ —Å –ø–æ—Å—Ç—Ä–∞–¥–∞–≤—à–∏–º–∏',
        '–°–ª–æ–º–∞–Ω–Ω–æ–µ –∫–æ–º–º–µ—Ä—á–µ—Å–∫–æ–µ —Ç—Ä–∞–Ω—Å–ø–æ—Ä—Ç–Ω–æ–µ —Å—Ä–µ–¥—Å—Ç–≤–æ –±–ª–æ–∫–∏—Ä—É–µ—Ç –¥–≤–∏–∂–µ–Ω–∏–µ',
        '–û–±—Å–ª—É–∂–∏–≤–∞–Ω–∏–µ –º–æ—Å—Ç–∞ —Å–æ–∫—Ä–∞—â–∞–µ—Ç –ø–æ–ª–æ—Å—ã'
      ],
      ja: [
        'Ë§áÊï∞„ÅÆËªäÁ∑ö„ÇíÂ∞ÅÈéñ„Åô„ÇãÈáçÂ§ß„Å™Â§öÈáçËªä‰∏°Ë°ùÁ™Å',
        'Â§ßÂûã„Éà„É©„ÉÉ„ÇØ„ÅÆÊ®™Ëª¢„Å´„Çà„ÇäÂ§ßÂπÖ„Å™ÈÅÖÂª∂',
        'Á∑äÊÄ•ÂØæÂøú‰∏≠„ÅÆËªä‰∏°ÁÅ´ÁÅΩ',
        '‰∫§ÈÄö„ÅÆÊµÅ„Çå„ÇíÈòªÂÆ≥„Åô„ÇãË≠¶ÂØü„ÅÆÊçúÊüª',
        'ÈÄ≤Ë°å‰∏≠„ÅÆÁ∑äÊÄ•ÈÅìË∑Ø‰øÆÁêÜ',
        'Â∑¶ËªäÁ∑ö„ÇíÂ°û„ÅêÊ®™Ëª¢Ëªä‰∏°',
        'Â∞ÇÈñÄÊ∏ÖÊéÉ„ÇíË¶Å„Åô„ÇãÂç±Èô∫Áâ©ÊµÅÂá∫',
        'Ë≤†ÂÇ∑ËÄÖ„ÅÆ„ÅÑ„ÇãÂ∑•‰∫ãÁèæÂ†¥‰∫ãÊïÖ',
        '‰∫§ÈÄö„ÇíÈòªÂÆ≥„Åô„ÇãÊïÖÈöúÂïÜÁî®Ëªä',
        'ËªäÁ∑ö„ÇíÊ∏õ„Çâ„ÅôÊ©ãÊ¢Å‰øùÂÆà'
      ]
    };
    
    const languageIncidents = incidents[language as keyof typeof incidents] || incidents.en;
    return languageIncidents[Math.floor(Math.random() * languageIncidents.length)];
  };

  // Image generation functions for premium tools
  
  // Function to get realistic highways based on location
  const getLocalHighways = (locationInfo: any) => {
    const state = locationInfo?.state?.toLowerCase() || '';
    const city = locationInfo?.city?.toLowerCase() || '';
    
    // Major metropolitan area highway mapping
    const regionalHighways = {
      // Texas highways
      texas: {
        interstates: ['I-35', 'I-45', 'I-10', 'I-20', 'I-30', 'I-635', 'I-820'],
        usRoutes: ['US-75', 'US-183', 'US-380', 'US-121', 'US-114', 'US-287'],
        stateRoutes: ['TX-114', 'TX-121', 'TX-183', 'TX-360', 'TX-161']
      },
      // California highways  
      california: {
        interstates: ['I-5', 'I-405', 'I-10', 'I-110', 'I-605', 'I-210', 'I-101'],
        usRoutes: ['US-101', 'US-1', 'US-395', 'US-99'],
        stateRoutes: ['CA-1', 'CA-91', 'CA-134', 'CA-170']
      },
      // New York highways
      'new york': {
        interstates: ['I-95', 'I-87', 'I-278', 'I-495', 'I-678', 'I-295'],
        usRoutes: ['US-1', 'US-9', 'US-206'],
        stateRoutes: ['NY-25', 'NY-27', 'NY-135']
      },
      // Florida highways
      florida: {
        interstates: ['I-95', 'I-75', 'I-4', 'I-275', 'I-375', 'I-595'],
        usRoutes: ['US-1', 'US-19', 'US-41', 'US-192'],
        stateRoutes: ['FL-826', 'FL-836', 'FL-112']
      },
      // Illinois highways
      illinois: {
        interstates: ['I-94', 'I-90', 'I-55', 'I-57', 'I-290', 'I-355'],
        usRoutes: ['US-41', 'US-12', 'US-20', 'US-45'],
        stateRoutes: ['IL-53', 'IL-83', 'IL-31']
      },
      // Default/Generic highways for other areas
      default: {
        interstates: ['I-75', 'I-85', 'I-65', 'I-40', 'I-70', 'I-80'],
        usRoutes: ['US-1', 'US-50', 'US-60', 'US-70'],
        stateRoutes: ['Route 9', 'Route 17', 'Route 23']
      }
    };
    
    // Dallas-Fort Worth specific highways (for Coppell, Texas)
    if (city.includes('coppell') || city.includes('dallas') || city.includes('plano') || city.includes('irving')) {
      return {
        interstates: ['I-35E', 'I-635', 'I-820', 'I-30', 'I-20'],
        usRoutes: ['US-75', 'US-121', 'US-114', 'US-380'],
        stateRoutes: ['TX-114', 'TX-121', 'TX-183', 'TX-360']
      };
    }
    
    return (regionalHighways as any)[state] || regionalHighways['texas'] || regionalHighways['default'];
  };

  const generateWeatherAlertImage = (weatherData: any, locationInfo: any, alertInfo: any) => {
    const canvas = document.createElement('canvas');
    canvas.width = 850;
    canvas.height = 700;
    const ctx = canvas.getContext('2d');
    
    if (!ctx) return null;
    
    // Professional weather document background
    const gradient = ctx.createLinearGradient(0, 0, 0, 700);
    gradient.addColorStop(0, '#ffffff');
    gradient.addColorStop(1, '#f0f9ff');
    ctx.fillStyle = gradient;
    ctx.fillRect(0, 0, 850, 700);
    
    // Official header with seal area
    ctx.fillStyle = '#1e40af';
    ctx.fillRect(0, 0, 850, 120);
    
    // Draw official seal placeholder (circle)
    ctx.fillStyle = '#ffffff';
    ctx.beginPath();
    ctx.arc(70, 60, 35, 0, 2 * Math.PI);
    ctx.fill();
    
    ctx.fillStyle = '#1e40af';
    ctx.beginPath();
    ctx.arc(70, 60, 30, 0, 2 * Math.PI);
    ctx.fill();
    
    // Seal text
    ctx.fillStyle = '#ffffff';
    ctx.font = 'bold 8px Arial';
    ctx.textAlign = 'center';
    ctx.fillText('NOAA', 70, 58);
    ctx.fillText('NWS', 70, 68);
    
    // Main header text
    ctx.fillStyle = '#ffffff';
    ctx.font = 'bold 28px Arial';
    ctx.textAlign = 'center';
    ctx.fillText('NATIONAL WEATHER SERVICE', 425, 45);
    ctx.font = 'bold 20px Arial';
    ctx.fillText('WEATHER ALERT NOTIFICATION', 425, 75);
    
    // Office designation
    ctx.font = '14px Arial';
    ctx.fillText('Dallas/Fort Worth, TX Office', 425, 100);
    
    // Alert status bar
    const alertColor = alertInfo.severity === 'WARNING' ? '#dc2626' : 
                      alertInfo.severity === 'WATCH' ? '#ea580c' : '#059669';
    ctx.fillStyle = alertColor;
    ctx.fillRect(0, 120, 850, 60);
    
    // Alert text
    ctx.fillStyle = '#ffffff';
    ctx.font = 'bold 24px Arial';
    ctx.textAlign = 'center';
    ctx.fillText(`${alertInfo.type.toUpperCase()} ${alertInfo.severity}`, 425, 155);
    
    // Document body
    ctx.fillStyle = '#ffffff';
    ctx.fillRect(20, 200, 810, 480);
    ctx.strokeStyle = '#e5e7eb';
    ctx.lineWidth = 2;
    ctx.strokeRect(20, 200, 810, 480);
    
    // Document header
    ctx.fillStyle = '#111827';
    ctx.font = 'bold 18px Arial';
    ctx.textAlign = 'left';
    ctx.fillText('OFFICIAL WEATHER ADVISORY', 40, 230);
    
    // Horizontal line
    ctx.strokeStyle = '#6b7280';
    ctx.lineWidth = 1;
    ctx.beginPath();
    ctx.moveTo(40, 240);
    ctx.lineTo(810, 240);
    ctx.stroke();
    
    // Current date and time
    const now = new Date();
    ctx.fillStyle = '#374151';
    ctx.font = '12px Arial';
    ctx.fillText(`Issued: ${now.toLocaleDateString()} at ${now.toLocaleTimeString()}`, 40, 260);
    ctx.fillText(`Alert ID: NWS-${Math.floor(Math.random() * 90000) + 10000}`, 600, 260);
    
    // Location information
    ctx.fillStyle = '#111827';
    ctx.font = 'bold 16px Arial';
    ctx.fillText('AFFECTED AREA:', 40, 300);
    ctx.font = '14px Arial';
    ctx.fillText(`${locationInfo.city}${locationInfo.state ? `, ${locationInfo.state}` : ''} and surrounding counties`, 40, 320);
    
    // Weather details
    ctx.font = 'bold 16px Arial';
    ctx.fillText('CURRENT CONDITIONS:', 40, 360);
    ctx.font = '14px Arial';
    ctx.fillText(`Temperature: ${weatherData?.temperature || '45'}¬∞F`, 40, 385);
    ctx.fillText(`Conditions: ${weatherData?.description || 'Severe weather conditions'}`, 40, 405);
    ctx.fillText(`Wind Speed: ${weatherData?.windSpeed || '35'} mph`, 40, 425);
    ctx.fillText(`Humidity: ${weatherData?.humidity || '85'}%`, 40, 445);
    
    // Impact statement
    ctx.font = 'bold 16px Arial';
    ctx.fillText('EXPECTED IMPACTS:', 40, 485);
    ctx.font = '14px Arial';
    ctx.fillText('‚Ä¢ Travel will be extremely difficult or impossible', 40, 510);
    ctx.fillText('‚Ä¢ Widespread power outages expected', 40, 530);
    ctx.fillText('‚Ä¢ Emergency services may be limited', 40, 550);
    
    // Safety information
    ctx.font = 'bold 16px Arial';
    ctx.fillText('RECOMMENDED ACTIONS:', 40, 590);
    ctx.font = '14px Arial';
    ctx.fillText('‚Ä¢ Avoid all non-essential travel', 40, 615);
    ctx.fillText('‚Ä¢ Stay indoors and away from windows', 40, 635);
    ctx.fillText('‚Ä¢ Monitor weather radio for updates', 40, 655);
    
    // Footer
    ctx.fillStyle = '#6b7280';
    ctx.font = '10px Arial';
    ctx.textAlign = 'center';
    ctx.fillText('This is an official notification from the National Weather Service', 425, 690);
    
    return canvas.toDataURL('image/png');
  };

  const generateTrafficReportImage = (trafficData: any, locationInfo: any) => {
    const canvas = document.createElement('canvas');
    canvas.width = 850;
    canvas.height = 750;
    const ctx = canvas.getContext('2d');
    
    if (!ctx) return null;
    
    // Professional document background
    const gradient = ctx.createLinearGradient(0, 0, 0, 750);
    gradient.addColorStop(0, '#ffffff');
    gradient.addColorStop(1, '#f9fafb');
    ctx.fillStyle = gradient;
    ctx.fillRect(0, 0, 850, 750);
    
    // Official header
    ctx.fillStyle = '#0f172a';
    ctx.fillRect(0, 0, 850, 100);
    
    // Department seal
    ctx.fillStyle = '#ffffff';
    ctx.beginPath();
    ctx.arc(70, 50, 30, 0, 2 * Math.PI);
    ctx.fill();
    
    ctx.fillStyle = '#0f172a';
    ctx.beginPath();
    ctx.arc(70, 50, 25, 0, 2 * Math.PI);
    ctx.fill();
    
    // Seal text
    ctx.fillStyle = '#ffffff';
    ctx.font = 'bold 7px Arial';
    ctx.textAlign = 'center';
    ctx.fillText('TXDOT', 70, 48);
    ctx.fillText('TRAFFIC', 70, 57);
    
    // Main header
    ctx.fillStyle = '#ffffff';
    ctx.font = 'bold 24px Arial';
    ctx.textAlign = 'center';
    ctx.fillText('TEXAS DEPARTMENT OF TRANSPORTATION', 425, 40);
    ctx.font = 'bold 16px Arial';
    ctx.fillText('TRAFFIC INCIDENT REPORT', 425, 65);
    ctx.font = '12px Arial';
    ctx.fillText('District Office - Dallas/Fort Worth', 425, 85);
    
    // Alert status banner
    ctx.fillStyle = '#dc2626';
    ctx.fillRect(0, 100, 850, 50);
    
    ctx.fillStyle = '#ffffff';
    ctx.font = 'bold 20px Arial';
    ctx.textAlign = 'center';
    ctx.fillText('ACTIVE TRAFFIC INCIDENT', 425, 130);
    
    // Document body
    ctx.fillStyle = '#ffffff';
    ctx.fillRect(30, 170, 790, 550);
    ctx.strokeStyle = '#d1d5db';
    ctx.lineWidth = 2;
    ctx.strokeRect(30, 170, 790, 550);
    
    // Document header
    ctx.fillStyle = '#111827';
    ctx.font = 'bold 18px Arial';
    ctx.textAlign = 'left';
    ctx.fillText('OFFICIAL TRAFFIC REPORT', 50, 200);
    
    // Report details box
    ctx.fillStyle = '#f3f4f6';
    ctx.fillRect(50, 210, 750, 80);
    ctx.strokeStyle = '#9ca3af';
    ctx.lineWidth = 1;
    ctx.strokeRect(50, 210, 750, 80);
    
    // Report header info
    const now = new Date();
    ctx.fillStyle = '#374151';
    ctx.font = 'bold 14px Arial';
    ctx.fillText('INCIDENT DETAILS', 60, 230);
    ctx.font = '12px Arial';
    ctx.fillText(`Report Date: ${now.toLocaleDateString()}`, 60, 250);
    ctx.fillText(`Report Time: ${now.toLocaleTimeString()}`, 60, 268);
    ctx.fillText(`Incident ID: TXD-${Math.floor(Math.random() * 90000) + 10000}`, 450, 250);
    ctx.fillText(`Status: ACTIVE`, 450, 268);
    
    // Location section
    ctx.fillStyle = '#111827';
    ctx.font = 'bold 16px Arial';
    ctx.fillText('LOCATION INFORMATION:', 50, 320);
    ctx.font = '14px Arial';
    
    // Use location-aware highway for the image
    const highways = getLocalHighways(locationInfo);
    const selectedHighway = [...highways.interstates, ...highways.usRoutes][Math.floor(Math.random() * ([...highways.interstates, ...highways.usRoutes].length))];
    
    ctx.fillText(`Highway: ${selectedHighway}`, 60, 345);
    ctx.fillText(`Direction: ${['Northbound', 'Southbound', 'Eastbound', 'Westbound'][Math.floor(Math.random() * 4)]}`, 60, 365);
    ctx.fillText(`Mile Marker: ${Math.floor(Math.random() * 50) + 100}`, 60, 385);
    ctx.fillText(`City/Area: ${locationInfo.city}${locationInfo.state ? `, ${locationInfo.state}` : ''}`, 60, 405);
    
    // Incident details
    ctx.font = 'bold 16px Arial';
    ctx.fillText('INCIDENT TYPE:', 50, 445);
    ctx.font = '14px Arial';
    ctx.fillText(`Primary: ${trafficData?.type || 'Multi-vehicle collision'}`, 60, 470);
    ctx.fillText(`Severity: ${['Minor', 'Moderate', 'Major'][Math.floor(Math.random() * 3)]}`, 60, 490);
    ctx.fillText(`Vehicles Involved: ${Math.floor(Math.random() * 3) + 2}`, 60, 510);
    
    // Impact assessment
    ctx.font = 'bold 16px Arial';
    ctx.fillText('TRAFFIC IMPACT:', 50, 550);
    ctx.font = '14px Arial';
    ctx.fillText(`Lanes Blocked: ${Math.floor(Math.random() * 3) + 1} of ${Math.floor(Math.random() * 2) + 3}`, 60, 575);
    ctx.fillText(`Expected Duration: ${Math.floor(Math.random() * 3) + 2} hours`, 60, 595);
    ctx.fillText(`Alternate Route: Use frontage road or parallel highways`, 60, 615);
    
    // Emergency response
    ctx.font = 'bold 16px Arial';
    ctx.fillText('EMERGENCY RESPONSE:', 450, 445);
    ctx.font = '14px Arial';
    ctx.fillText('‚Ä¢ State Troopers on scene', 460, 470);
    ctx.fillText('‚Ä¢ Emergency medical services dispatched', 460, 490);
    ctx.fillText('‚Ä¢ Tow trucks en route', 460, 510);
    ctx.fillText('‚Ä¢ Traffic control established', 460, 530);
    
    // Advisory information
    ctx.font = 'bold 16px Arial';
    ctx.fillText('MOTORIST ADVISORY:', 450, 570);
    ctx.font = '14px Arial';
    ctx.fillText('‚Ä¢ Expect significant delays', 460, 595);
    ctx.fillText('‚Ä¢ Use extreme caution in area', 460, 615);
    ctx.fillText('‚Ä¢ Follow flagman directions', 460, 635);
    
    // Footer with official info
    ctx.fillStyle = '#6b7280';
    ctx.font = '10px Arial';
    ctx.textAlign = 'center';
    ctx.fillText('This report is generated by TxDOT Traffic Management Center', 425, 730);
    ctx.fillText('For real-time traffic information, visit DriveTexas.org', 425, 742);
    
    return canvas.toDataURL('image/png');
  };

  const generateMedicalDocumentImage = (patientName: string, locationInfo: any, patientDateOfBirth?: string) => {
    console.log('generateMedicalDocumentImage called');
    console.log('patientName:', patientName);
    console.log('locationInfo:', locationInfo);
    console.log('patientDateOfBirth:', patientDateOfBirth);
    
    const canvas = document.createElement('canvas');
    canvas.width = 850;
    canvas.height = 1100;
    const ctx = canvas.getContext('2d');
    
    if (!ctx) return null;
    
    // Select consistent doctor name for entire document
    const doctorNames = [
      { full: 'Dr. Sarah Johnson', last: 'Johnson' },
      { full: 'Dr. Michael Smith', last: 'Smith' },
      { full: 'Dr. Emily Williams', last: 'Williams' },
      { full: 'Dr. David Brown', last: 'Brown' },
      { full: 'Dr. Lisa Davis', last: 'Davis' }
    ];
    const selectedDoctor = doctorNames[Math.floor(Math.random() * doctorNames.length)];
    
    // Generate realistic patient information
    const firstNames = ['James', 'Mary', 'John', 'Patricia', 'Robert', 'Jennifer', 'Michael', 'Linda', 'David', 'Elizabeth', 'William', 'Barbara', 'Richard', 'Susan', 'Joseph', 'Jessica', 'Thomas', 'Sarah', 'Christopher', 'Karen'];
    const lastNames = ['Smith', 'Johnson', 'Williams', 'Brown', 'Jones', 'Garcia', 'Miller', 'Davis', 'Rodriguez', 'Martinez', 'Hernandez', 'Lopez', 'Gonzalez', 'Wilson', 'Anderson', 'Thomas', 'Taylor', 'Moore', 'Jackson', 'Martin'];
    
    // Use provided name or generate realistic one
    let finalPatientName = patientName;
    if (!patientName || patientName === 'Emergency Medical Certificate' || patientName === 'Patient') {
      const firstName = firstNames[Math.floor(Math.random() * firstNames.length)];
      const lastName = lastNames[Math.floor(Math.random() * lastNames.length)];
      finalPatientName = `${firstName} ${lastName}`;
    }
    
    // Generate realistic patient details
    let dateOfBirth;
    if (patientDateOfBirth) {
      // Use provided date of birth
      dateOfBirth = new Date(patientDateOfBirth);
    } else {
      // Generate realistic age if not provided
      const birthYear = 1970 + Math.floor(Math.random() * 35); // Age 20-55
      const birthMonth = Math.floor(Math.random() * 12);
      const birthDay = Math.floor(Math.random() * 28) + 1;
      dateOfBirth = new Date(birthYear, birthMonth, birthDay);
    }
    
    const patientId = `P-${Math.floor(Math.random() * 900000) + 100000}`;
    const medicalRecordNumber = `MR-${Math.floor(Math.random() * 90000) + 10000}`;
    
    // Emergency contact information
    const emergencyContacts = [
      'Jane Doe (Spouse) - (214) 555-0123',
      'Robert Smith (Father) - (214) 555-0145', 
      'Maria Rodriguez (Sister) - (214) 555-0167',
      'Tom Johnson (Brother) - (214) 555-0189'
    ];
    const emergencyContact = emergencyContacts[Math.floor(Math.random() * emergencyContacts.length)];
    
    // Professional medical document background
    const gradient = ctx.createLinearGradient(0, 0, 0, 1100);
    gradient.addColorStop(0, '#ffffff');
    gradient.addColorStop(1, '#fefefe');
    ctx.fillStyle = gradient;
    ctx.fillRect(0, 0, 850, 1100);
    
    // Medical letterhead with logo area
    ctx.fillStyle = '#1565c0';
    ctx.fillRect(0, 0, 850, 120);
    
    // Medical symbol (cross)
    ctx.fillStyle = '#ffffff';
    ctx.fillRect(70, 35, 8, 50);
    ctx.fillRect(48, 55, 50, 8);
    
    // Main header
    ctx.fillStyle = '#ffffff';
    ctx.font = 'bold 28px Arial';
    ctx.textAlign = 'center';
    ctx.fillText('DALLAS URGENT CARE MEDICAL CENTER', 425, 45);
    ctx.font = '16px Arial';
    ctx.fillText('Certified Healthcare Providers ‚Ä¢ Est. 1995', 425, 70);
    ctx.font = '14px Arial';
    ctx.fillText('License #TX-UC-2024-447 ‚Ä¢ NPI: 1234567890', 425, 95);
    
    // Medical document header
    ctx.fillStyle = '#ffffff';
    ctx.fillRect(50, 150, 750, 60);
    ctx.fillStyle = '#1565c0';
    ctx.strokeStyle = '#1565c0';
    ctx.lineWidth = 2;
    ctx.strokeRect(50, 150, 750, 60);
    
    ctx.fillStyle = '#1565c0';
    ctx.font = 'bold 24px Arial';
    ctx.textAlign = 'center';
    ctx.fillText('MEDICAL EXCUSE CERTIFICATE', 425, 185);
    
    // Document body with border
    ctx.fillStyle = '#ffffff';
    ctx.fillRect(50, 230, 750, 800);
    ctx.strokeStyle = '#d1d5db';
    ctx.lineWidth = 1;
    ctx.strokeRect(50, 230, 750, 800);
    
    // Official document header
    ctx.fillStyle = '#111827';
    ctx.font = 'bold 18px Arial';
    ctx.textAlign = 'left';
    ctx.fillText('OFFICIAL MEDICAL DOCUMENTATION', 70, 260);
    
    // Date and document info
    const now = new Date();
    ctx.fillStyle = '#374151';
    ctx.font = '12px Arial';
    ctx.fillText(`Document Date: ${now.toLocaleDateString()}`, 70, 285);
    ctx.fillText(`Document Time: ${now.toLocaleTimeString()}`, 70, 302);
    ctx.fillText(`Certificate ID: MC-${Math.floor(Math.random() * 90000) + 10000}`, 500, 285);
    ctx.fillText(`Provider ID: DUC-${Math.floor(Math.random() * 9000) + 1000}`, 500, 302);
    
    // Horizontal divider
    ctx.strokeStyle = '#9ca3af';
    ctx.lineWidth = 1;
    ctx.beginPath();
    ctx.moveTo(70, 320);
    ctx.lineTo(780, 320);
    ctx.stroke();
    
    // Patient information section
    ctx.fillStyle = '#111827';
    ctx.font = 'bold 16px Arial';
    ctx.fillText('PATIENT INFORMATION:', 70, 350);
    
    ctx.fillStyle = '#f3f4f6';
    ctx.fillRect(70, 360, 710, 140);
    ctx.strokeStyle = '#d1d5db';
    ctx.lineWidth = 1;
    ctx.strokeRect(70, 360, 710, 140);
    
    ctx.fillStyle = '#374151';
    ctx.font = '14px Arial';
    ctx.fillText(`Patient Name: ${finalPatientName}`, 90, 385);
    ctx.fillText(`Date of Birth: ${dateOfBirth.toLocaleDateString()}`, 90, 405);
    ctx.fillText(`Patient ID: ${patientId}`, 90, 425);
    ctx.fillText(`Date of Examination: ${now.toLocaleDateString()}`, 450, 385);
    ctx.fillText(`Time of Examination: ${now.toLocaleTimeString()}`, 450, 405);
    ctx.fillText(`Attending Physician: ${selectedDoctor.full}`, 450, 425);
    ctx.fillText(`Medical Record #: ${medicalRecordNumber}`, 90, 455);
    ctx.fillText(`Insurance Verified: Yes`, 450, 455);
    
    // Additional patient details
    ctx.fillText(`Emergency Contact: ${emergencyContact}`, 90, 475);
    
    // Medical findings section
    ctx.fillStyle = '#111827';
    ctx.font = 'bold 16px Arial';
    ctx.fillText('CLINICAL FINDINGS:', 70, 540);
    
    ctx.fillStyle = '#374151';
    ctx.font = '14px Arial';
    ctx.fillText('Following comprehensive medical examination, the following conditions were observed:', 90, 565);
    
    const conditions = [
      'Acute viral syndrome with associated symptoms',
      'Moderate to severe respiratory distress',
      'Elevated temperature and systemic inflammation',
      'Recommended bed rest and medical monitoring'
    ];
    
    conditions.forEach((condition, index) => {
      ctx.fillText(`‚Ä¢ ${condition}`, 90, 590 + (index * 25));
    });
    
    // Medical recommendation section
    ctx.font = 'bold 16px Arial';
    ctx.fillText('MEDICAL RECOMMENDATIONS:', 70, 710);
    
    ctx.font = '14px Arial';
    ctx.fillText('Based on the clinical examination and current health status:', 90, 735);
    
    const recommendations = [
      'Patient is medically excused from work/school activities',
      `Recommended rest period: ${Math.floor(Math.random() * 3) + 1} to ${Math.floor(Math.random() * 3) + 4} days`,
      'Follow-up appointment scheduled if symptoms persist',
      'Return to normal activities when symptom-free for 24 hours'
    ];
    
    recommendations.forEach((rec, index) => {
      ctx.fillText(`‚Ä¢ ${rec}`, 90, 760 + (index * 25));
    });
    
    // Provider certification section
    ctx.fillStyle = '#1565c0';
    ctx.fillRect(70, 870, 710, 2);
    
    ctx.fillStyle = '#111827';
    ctx.font = 'bold 16px Arial';
    ctx.fillText('PROVIDER CERTIFICATION:', 70, 900);
    
    ctx.font = '14px Arial';
    ctx.fillText('I hereby certify that the above patient was examined by me on the date stated', 90, 925);
    ctx.fillText('above and that the medical findings and recommendations are accurate.', 90, 945);
    
    // Physician signature - handwritten style
    // Draw handwritten signature
    ctx.strokeStyle = '#1e3a8a';
    ctx.lineWidth = 2;
    ctx.lineCap = 'round';
    ctx.lineJoin = 'round';
    
    // Create signature path (cursive-style)
    ctx.beginPath();
    // First letter (large)
    ctx.moveTo(110, 965);
    ctx.bezierCurveTo(115, 955, 125, 960, 130, 970);
    ctx.bezierCurveTo(135, 980, 140, 975, 145, 965);
    
    // Middle part (flowing)
    ctx.moveTo(150, 970);
    ctx.bezierCurveTo(160, 965, 170, 975, 180, 970);
    ctx.bezierCurveTo(190, 965, 200, 980, 210, 970);
    ctx.bezierCurveTo(220, 960, 230, 975, 240, 970);
    
    // Last name initial (larger)
    ctx.moveTo(260, 960);
    ctx.bezierCurveTo(270, 950, 280, 965, 285, 975);
    ctx.bezierCurveTo(290, 985, 295, 970, 300, 960);
    
    // Final flourish
    ctx.moveTo(305, 970);
    ctx.bezierCurveTo(320, 965, 335, 980, 350, 975);
    ctx.bezierCurveTo(360, 970, 365, 965, 370, 970);
    
    ctx.stroke();
    
    // Add some signature dots/marks for authenticity
    ctx.fillStyle = '#1e3a8a';
    ctx.beginPath();
    ctx.arc(375, 968, 1, 0, 2 * Math.PI);
    ctx.fill();
    
    // Signature area
    ctx.strokeStyle = '#374151';
    ctx.lineWidth = 1;
    ctx.beginPath();
    ctx.moveTo(90, 990);
    ctx.lineTo(400, 990);
    ctx.stroke();
    
    ctx.fillStyle = '#374151';
    ctx.font = '12px Arial';
    ctx.fillText('Physician Signature', 90, 1005);
    ctx.fillText(`Date: ${now.toLocaleDateString()}`, 320, 1005);
    
    // Add typed doctor name below signature
    ctx.fillStyle = '#6b7280';
    ctx.font = '10px Arial';
    ctx.fillText(`${selectedDoctor.full}, MD`, 90, 1020);
    
    // Medical license info
    ctx.beginPath();
    ctx.moveTo(450, 990);
    ctx.lineTo(760, 990);
    ctx.stroke();
    
    ctx.fillText('Medical License Number', 450, 1005);
    ctx.fillText(`TX-${Math.floor(Math.random() * 90000) + 10000}`, 650, 1005);
    
    // Footer with contact info
    ctx.fillStyle = '#6b7280';
    ctx.font = '10px Arial';
    ctx.textAlign = 'center';
    ctx.fillText('Dallas Urgent Care Medical Center ‚Ä¢ 123 Medical Plaza Dr. ‚Ä¢ Dallas, TX 75201', 425, 1090);
    ctx.fillText('Phone: (214) 555-CARE ‚Ä¢ Fax: (214) 555-0199 ‚Ä¢ www.dallasurgentcare.com', 425, 1105);
    
    console.log('Medical document image generated successfully');
    return canvas.toDataURL('image/png');
  };

  const downloadImageFile = (dataUrl: string, filename: string) => {
    const a = document.createElement('a');
    a.href = dataUrl;
    a.download = filename;
    document.body.appendChild(a);
    a.click();
    document.body.removeChild(a);
  };

  const generateMedicalProofWithPatientInfo = async () => {
    console.log('generateMedicalProofWithPatientInfo called');
    console.log('Patient name:', patientName);
    console.log('Patient DOB:', patientDateOfBirth);
    
    if (!patientName.trim()) {
      alert('Please enter your name');
      return;
    }

    setShowPatientInfoDialog(false);
    setIsGeneratingProof(true);
    
    // Ensure we're in the main app view
    setShowSettings(false);
    setShowShare(false);
    
    try {
      // Use a default location for medical certificates to avoid API issues
      const locationForImage = userLocation || {
        city: 'Dallas',
        state: 'TX',
        lat: 32.7767,
        lon: -96.7970,
        address: 'Dallas, TX'
      };

      console.log('Using location for medical certificate:', locationForImage);

      // Generate medical certificate with user's name
      const proofImage = await generateMedicalDocumentImage(patientName.trim(), locationForImage, patientDateOfBirth);
      
      console.log('Medical document image result:', proofImage ? 'Generated successfully' : 'Failed to generate');
      
      if (proofImage) {
        console.log('Setting generated proof with medical certificate');
        setGeneratedProof({
          type: 'Medical Certificate',
          content: 'Official medical documentation has been generated.',
          image: proofImage
        });
        
        // Show success message
        console.log('Medical certificate generated successfully');
      } else {
        console.error('Failed to generate medical certificate image');
        alert('Failed to generate medical certificate image. Please try again.');
      }
      
    } catch (error) {
      console.error('Error generating medical proof:', error);
      alert('Failed to generate medical certificate. Please try again.');
    } finally {
      setIsGeneratingProof(false);
    }
  };

  const generateProof = async (type: 'weather' | 'traffic' | 'medical') => {
    console.log('generateProof called with type:', type, 'isPremium:', isPremium);
    console.log('showPatientInfoDialog state:', showPatientInfoDialog);
    
    if (!isPremium) {
      console.log('User is not premium, showing premium dialog');
      setShowPremium(true);
      return;
    }

    // For medical certificates, show patient info dialog first
    if (type === 'medical') {
      console.log('Showing patient info dialog for medical certificate');
      setShowPatientInfoDialog(true);
      return;
    }

    if (isGeneratingProof) return; // Prevent multiple simultaneous generations
    
    setIsGeneratingProof(true);
    
    // Ensure we're in the main app view, not in settings or other screens
    setShowSettings(false);
    setShowShare(false);
    setShowPremium(false);

    // Small delay for better UX
    await new Promise(resolve => setTimeout(resolve, 1000));

    const now = new Date();
    const currentTime = now.toLocaleTimeString('en-US', { hour: '2-digit', minute: '2-digit' });
    const currentDate = now.toLocaleDateString('en-US', { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' });
    
    // Use real location data if available, otherwise fallback to localized generic data
    const getLocationInfo = () => {
      if (userLocation && userLocation.city) {
        return {
          city: userLocation.city,
          state: userLocation.state || '',
          address: userLocation.address || `${userLocation.city}, ${userLocation.state || ''}`,
          neighborhood: userLocation.neighborhood || ''
        };
      }
      // Fallback to generic localized data
      const localizedCities = {
        en: ['Downtown', 'Midtown', 'North Side', 'South District', 'East End', 'West Hills', 'Central'],
        es: ['Centro', 'Zona Media', 'Lado Norte', 'Distrito Sur', 'Extremo Este', 'Colinas Oeste', 'Central'],
        fr: ['Centre-ville', 'Quartier Central', 'C√¥t√© Nord', 'District Sud', 'Extr√©mit√© Est', 'Collines Ouest', 'Central'],
        de: ['Innenstadt', 'Stadtmitte', 'Nordseite', 'S√ºdbezirk', 'Ostende', 'Westh√ºgel', 'Zentral'],
        it: ['Centro', 'Zona Centrale', 'Lato Nord', 'Distretto Sud', 'Estremo Est', 'Colline Ovest', 'Centrale'],
        pt: ['Centro', 'Zona Central', 'Lado Norte', 'Distrito Sul', 'Extremo Leste', 'Colinas Oeste', 'Central'],
        ru: ['–¶–µ–Ω—Ç—Ä', '–°—Ä–µ–¥–Ω–∏–π —Ä–∞–π–æ–Ω', '–°–µ–≤–µ—Ä–Ω–∞—è —Å—Ç–æ—Ä–æ–Ω–∞', '–Æ–∂–Ω—ã–π —Ä–∞–π–æ–Ω', '–í–æ—Å—Ç–æ—á–Ω—ã–π –∫—Ä–∞–π', '–ó–∞–ø–∞–¥–Ω—ã–µ —Ö–æ–ª–º—ã', '–¶–µ–Ω—Ç—Ä–∞–ª—å–Ω—ã–π'],
        ja: ['„ÉÄ„Ç¶„É≥„Çø„Ç¶„É≥', '„Éü„ÉÉ„Éâ„Çø„Ç¶„É≥', '„Éé„Éº„Çπ„Çµ„Ç§„Éâ', 'ÂçóÂú∞Âå∫', '„Ç§„Éº„Çπ„Éà„Ç®„É≥„Éâ', '„Ç¶„Çß„Çπ„Éà„Éí„É´„Ç∫', '„Çª„É≥„Éà„É©„É´']
      };
      
      const localizedStreets = {
        en: ['Main St', 'Oak Ave', 'First St', 'Park Rd', 'Cedar Blvd', 'Pine Ave', 'Maple Dr'],
        es: ['Calle Principal', 'Av. del Roble', 'Primera St', 'Rd. del Parque', 'Blvd. Cedro', 'Av. Pino', 'Dr. Arce'],
        fr: ['Rue Principale', 'Ave. du Ch√™ne', 'Premi√®re Rue', 'Rd. du Parc', 'Blvd. C√®dre', 'Ave. Pin', 'Dr. √ârable'],
        de: ['Hauptstra√üe', 'Eichen-Allee', 'Erste Stra√üe', 'Park-Weg', 'Zedern-Boulevard', 'Kiefern-Allee', 'Ahorn-Dr.'],
        it: ['Via Principale', 'Viale Quercia', 'Prima Strada', 'Via Parco', 'Viale Cedro', 'Viale Pino', 'Via Acero'],
        pt: ['Rua Principal', 'Ave. do Carvalho', 'Primeira Rua', 'Est. do Parque', 'Blvd. Cedro', 'Ave. Pinho', 'Dr. Bordo'],
        ru: ['–ì–ª–∞–≤–Ω–∞—è —É–ª.', '–î—É–±–æ–≤—ã–π –ø—Ä.', '–ü–µ—Ä–≤–∞—è —É–ª.', '–ü–∞—Ä–∫–æ–≤–∞—è –¥–æ—Ä.', '–ö–µ–¥—Ä–æ–≤—ã–π –±—É–ª.', '–°–æ—Å–Ω–æ–≤—ã–π –ø—Ä.', '–ö–ª–µ–Ω–æ–≤—ã–π –¥—Ä.'],
        ja: ['„É°„Ç§„É≥ÈÄö„Çä', '„Ç™„Éº„ÇØÂ§ßÈÄö„Çä', '„Éï„Ç°„Éº„Çπ„ÉàË°ó', '„Éë„Éº„ÇØÈÄö„Çä', '„Ç∑„ÉÄ„ÉºÂ§ßÈÄö„Çä', '„Éë„Ç§„É≥Â§ßÈÄö„Çä', '„É°„Éº„Éó„É´ÈÄö„Çä']
      };
      
      const cities = localizedCities[selectedLanguage] || localizedCities['en'];
      const streets = localizedStreets[selectedLanguage] || localizedStreets['en'];
      const randomCity = cities[Math.floor(Math.random() * cities.length)];
      const randomStreet = streets[Math.floor(Math.random() * streets.length)];
      
      return {
        city: randomCity,
        state: '',
        address: `${randomStreet}, ${randomCity}`,
        neighborhood: randomCity
      };
    };
    
    const locationInfo = getLocationInfo();
    // Keep these for backward compatibility with existing traffic/medical generators
    const randomCity = locationInfo.city;
    const randomStreet = locationInfo.address.split(',')[0] || 'Main St';
    
    // Official phone numbers for SMS format
    const officialNumbers = {
      weather: {
        en: ['(555) NWS-WARN', '67283 (NWS)', '+1-555-WEATHER'],
        es: ['(555) MET-ALAR', '62834 (METEO)', '+34-555-TIEMPO'],
        fr: ['(555) MET-ALER', '63836 (METEO)', '+33-555-METEO'],
        de: ['(555) WET-WARN', '93883 (WETTER)', '+49-555-WETTER'],
        it: ['(555) MET-ALAR', '63836 (METEO)', '+39-555-METEO'],
        pt: ['(555) MET-ALAR', '63836 (METEO)', '+351-555-TEMPO'],
        ru: ['(555) –ü–û–ì-–ü–†–ï–î', '76476 (–ü–û–ì–û–î–ê)', '+7-555-–ü–û–ì–û–î–ê'],
        ja: ['(555) Â§©Ê∞ó-Ë≠¶Â†±', '83654 (Â§©Ê∞ó)', '+81-555-Â§©Ê∞ó']
      },
      traffic: {
        en: ['DOT-ALERT', '368-2537', '+1-555-DOT-INFO'],
        es: ['DGT-ALERT', '348-2537', '+34-555-DGT-INFO'],
        fr: ['DDE-ALERT', '333-2537', '+33-555-DDE-INFO'],
        de: ['BAB-ALERT', '222-2537', '+49-555-BAB-INFO'],
        it: ['AUT-ALERT', '288-2537', '+39-555-AUT-INFO'],
        pt: ['EP-ALERT', '37-2537', '+351-555-EP-INFO'],
        ru: ['–ì–ò–ë-ALERT', '442-2537', '+7-555-–ì–ò–ë–î–î'],
        ja: ['ÈÅìË∑Ø-Ë≠¶Â†±', '368-2537', '+81-555-ÈÅìË∑ØÊÉÖÂ†±']
      },
      medical: {
        en: ['(555) 123-4567', '(555) 987-6543', '(555) 246-8135'],
        es: ['(555) 123-4567', '(555) 987-6543', '(555) 246-8135'],
        fr: ['(555) 123-4567', '(555) 987-6543', '(555) 246-8135'],
        de: ['(555) 123-4567', '(555) 987-6543', '(555) 246-8135'],
        it: ['(555) 123-4567', '(555) 987-6543', '(555) 246-8135'],
        pt: ['(555) 123-4567', '(555) 987-6543', '(555) 246-8135'],
        ru: ['(555) 123-4567', '(555) 987-6543', '(555) 246-8135'],
        ja: ['(555) 123-4567', '(555) 987-6543', '(555) 246-8135']
      }
    };
    
    const proofGenerators = {
      weather: () => {
        // Use real weather data if available, but enhance it for excuse generation
        const getWeatherCondition = () => {
          if (liveWeatherData) {
            // If weather is clear, we can still generate weather excuses by predicting upcoming weather or using nearby weather
            if (liveWeatherData.condition === 'Clear') {
              // For excuse purposes, generate a "developing weather situation"
              const developingConditions = [
                { type: 'Severe Thunderstorm', icon: '‚õàÔ∏è', severity: 'WARNING', details: 'Rapid storm development expected - conditions deteriorating quickly' },
                { type: 'Flash Flood Watch', icon: 'üåä', severity: 'WATCH', details: 'Sudden weather change - flash flood conditions possible' },
                { type: 'High Wind Advisory', icon: 'üí®', severity: 'ADVISORY', details: 'Unexpected wind advisory issued - gusts up to 45 mph expected' },
                { type: 'Dense Fog Advisory', icon: 'üå´Ô∏è', severity: 'ADVISORY', details: 'Rapidly developing fog - visibility dropping to near zero' }
              ];
              return developingConditions[Math.floor(Math.random() * developingConditions.length)];
            }
            
            // Enhanced mapping for existing weather conditions
            return {
              type: liveWeatherData.condition === 'Thunderstorm' ? 'Severe Thunderstorm' :
                   liveWeatherData.condition === 'Rain' ? 'Heavy Rain' :
                   liveWeatherData.condition === 'Snow' ? 'Winter Storm' :
                   liveWeatherData.condition === 'Fog' ? 'Dense Fog' :
                   liveWeatherData.condition === 'Clouds' ? 'Severe Weather Developing' :
                   liveWeatherData.condition === 'Drizzle' ? 'Freezing Drizzle' : 'Severe Weather',
              icon: liveWeatherData.condition === 'Thunderstorm' ? '‚õàÔ∏è' :
                   liveWeatherData.condition === 'Rain' || liveWeatherData.condition === 'Drizzle' ? 'üåßÔ∏è' :
                   liveWeatherData.condition === 'Snow' ? '‚ùÑÔ∏è' :
                   liveWeatherData.condition === 'Fog' ? 'üå´Ô∏è' :
                   liveWeatherData.condition === 'Clouds' ? '‚òÅÔ∏è' : 'üå¶Ô∏è',
              severity: liveWeatherData.condition === 'Thunderstorm' ? 'WARNING' : 
                       (liveWeatherData.condition === 'Rain' || liveWeatherData.condition === 'Drizzle') ? 'WATCH' : 
                       liveWeatherData.condition === 'Snow' ? 'WARNING' : 
                       liveWeatherData.condition === 'Fog' ? 'ADVISORY' : 'WATCH',
              details: liveWeatherData.condition === 'Thunderstorm' ? 'Severe thunderstorms with damaging winds and heavy rain' :
                      (liveWeatherData.condition === 'Rain' || liveWeatherData.condition === 'Drizzle') ? 'Heavy rainfall creating hazardous travel conditions' :
                      liveWeatherData.condition === 'Snow' ? 'Heavy snow creating dangerous driving conditions' :
                      liveWeatherData.condition === 'Fog' ? 'Dense fog reducing visibility to less than 1/4 mile' :
                      liveWeatherData.condition === 'Clouds' ? 'Rapidly developing severe weather conditions' :
                      liveWeatherData.description || 'Severe weather conditions affecting travel'
            };
          }
          // Fallback to generic conditions
          const conditions = [
            { type: 'Severe Thunderstorm', icon: '‚õàÔ∏è', severity: 'WARNING', details: 'Hail up to 1 inch diameter, winds up to 70 mph' },
            { type: 'Flash Flood', icon: 'üåä', severity: 'WATCH', details: 'Rainfall rates of 2-3 inches per hour expected' },
            { type: 'Ice Storm', icon: 'üßä', severity: 'WARNING', details: 'Ice accumulation of 0.25 to 0.5 inches' },
            { type: 'Dense Fog', icon: 'üå´Ô∏è', severity: 'ADVISORY', details: 'Visibility reduced to less than 1/4 mile' },
            { type: 'High Wind', icon: 'üí®', severity: 'WARNING', details: 'Sustained winds of 40-50 mph, gusts up to 75 mph' }
          ];
          return conditions[Math.floor(Math.random() * conditions.length)];
        };
        
        const condition = getWeatherCondition();
        const temp = liveWeatherData ? liveWeatherData.temperature : Math.floor(Math.random() * 40) + 20;
        const alertId = `NWS${Math.floor(Math.random() * 9000) + 1000}`;
        
        // Location-aware weather office codes and state codes
        const getWeatherOfficeInfo = () => {
          const state = locationInfo?.state?.toLowerCase() || '';
          const city = locationInfo?.city?.toLowerCase() || '';
          
          // Dallas-Fort Worth area (including Coppell)
          if (city.includes('coppell') || city.includes('dallas') || city.includes('plano') || city.includes('irving')) {
            return {
              wfoCode: ['FWD', 'SHV', 'HGX'][Math.floor(Math.random() * 3)], // Dallas, Shreveport, Houston offices
              stateCode: 'TX'
            };
          }
          
          const regionalOffices = {
            texas: {
              wfoCode: ['FWD', 'HGX', 'EWX', 'MAF', 'LUB', 'AMA'],
              stateCode: 'TX'
            },
            california: {
              wfoCode: ['LOX', 'SGX', 'MTR', 'STO', 'HNX'],
              stateCode: 'CA'
            },
            'new york': {
              wfoCode: ['OKX', 'ALY', 'BGM', 'BUF'],
              stateCode: 'NY'
            },
            florida: {
              wfoCode: ['MFL', 'TBW', 'MLB', 'JAX', 'TAE'],
              stateCode: 'FL'
            },
            illinois: {
              wfoCode: ['LOT', 'ILX', 'DVN'],
              stateCode: 'IL'
            },
            default: {
              wfoCode: ['LOT', 'GRB', 'MKX', 'DVN', 'ARX'],
              stateCode: ['TX', 'CA', 'NY', 'FL', 'IL'][Math.floor(Math.random() * 5)]
            }
          };
          
          const officeInfo = (regionalOffices as any)[state] || regionalOffices['texas'] || regionalOffices['default'];
          return {
            wfoCode: officeInfo.wfoCode[Math.floor(Math.random() * officeInfo.wfoCode.length)],
            stateCode: officeInfo.stateCode
          };
        };
        
        const weatherOffice = getWeatherOfficeInfo();
        const wfoCode = weatherOffice.wfoCode;
        const ugcCode = `${weatherOffice.stateCode}C${String(Math.floor(Math.random() * 200) + 1).padStart(3, '0')}`;
        const vtecCode = `/O.NEW.K${wfoCode}.SV.W.${Math.floor(Math.random() * 9000) + 1000}.250919T${String(now.getHours()).padStart(2, '0')}${String(now.getMinutes()).padStart(2, '0')}Z-250920T0600Z/`;
        
        return {
          type: 'National Weather Service Alert',
          content: `${condition.icon}  NATIONAL WEATHER SERVICE ${wfoCode.toUpperCase()} OFFICE

‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ
URGENT - IMMEDIATE BROADCAST REQUESTED
${condition.type} ${condition.severity} in effect until 6:00 AM ${new Date(now.getTime() + 24*60*60*1000).toLocaleDateString('en-US', { weekday: 'short', month: 'short', day: 'numeric' })}
‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ

VTEC: ${vtecCode}
UGC: ${ugcCode}
Alert ID: ${alertId}
Issued: ${currentTime} ${currentDate}

AFFECTED AREA: ${locationInfo.city}${locationInfo.state ? `, ${locationInfo.state}` : ''} County and surrounding areas
${userLocation ? `SPECIFIC LOCATION: ${locationInfo.address}` : ''}

SOURCE: Doppler radar and trained weather spotters

DETAILS: ${condition.details}

IMPACTS: 
‚òÖ Travel will be extremely difficult to impossible
‚òÖ Widespread power outages expected  
‚òÖ Emergency services may be limited or suspended
‚òÖ Property damage likely

PRECAUTIONARY/PREPAREDNESS ACTIONS:
Stay indoors and away from windows. Avoid all unnecessary travel.
If you must travel, keep a flashlight, food, water and warm clothing
in your vehicle. Monitor NOAA Weather Radio for updates.

This warning will be updated as conditions warrant.

‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ
ISSUED BY: National Weather Service ${wfoCode.toUpperCase()} Office
METEOROLOGIST: ${['John Smith', 'Sarah Johnson', 'Michael Davis', 'Lisa Chen'][Math.floor(Math.random() * 4)]}
‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ

Current Conditions${liveWeatherData ? ' (REAL-TIME DATA)' : ''}:
Temperature: ${temp}¬∞F
Barometric Pressure: ${(29.8 + Math.random() * 0.4).toFixed(2)} inHg  
Wind: ${['N', 'NE', 'E', 'SE', 'S', 'SW', 'W', 'NW'][Math.floor(Math.random() * 8)]} ${liveWeatherData ? liveWeatherData.windSpeed : Math.floor(Math.random() * 25) + 10} mph
Humidity: ${liveWeatherData ? liveWeatherData.humidity : Math.floor(Math.random() * 40) + 60}%
${liveWeatherData && liveWeatherData.visibility ? `Visibility: ${liveWeatherData.visibility.toFixed(1)} miles` : ''}

$$`
        };
      },
      
      traffic: () => {
        // Use real traffic data if available
        const getTrafficInfo = () => {
          if (liveTrafficData) {
            return {
              type: liveTrafficData.type,
              location: liveTrafficData.location,
              description: liveTrafficData.description,
              delay: liveTrafficData.delay,
              distance: liveTrafficData.distance,
              severity: liveTrafficData.type === 'accident' ? 'CRITICAL' : 
                       liveTrafficData.type === 'construction' ? 'MAJOR' : 'MODERATE',
              lanes: liveTrafficData.type === 'accident' ? 'Multiple lanes blocked' :
                    liveTrafficData.type === 'construction' ? '2 of 3 lanes closed' : 'Right shoulder blocked'
            };
          }
          // Fallback to generic incidents - much more variety
          const incidents = [
            { type: 'Multi-vehicle collision', severity: 'MAJOR', lanes: '3 of 4 lanes blocked' },
            { type: 'Jackknifed semi-truck', severity: 'CRITICAL', lanes: 'All lanes blocked' },
            { type: 'Vehicle fire', severity: 'MAJOR', lanes: '2 of 3 lanes blocked' },
            { type: 'Police investigation', severity: 'MODERATE', lanes: 'Right shoulder blocked' },
            { type: 'Emergency road repairs', severity: 'MAJOR', lanes: 'Left 2 lanes closed' },
            { type: 'Overturned vehicle', severity: 'MAJOR', lanes: 'Left lane blocked' },
            { type: 'Hazmat spill cleanup', severity: 'CRITICAL', lanes: 'All northbound lanes closed' },
            { type: 'Construction zone accident', severity: 'MAJOR', lanes: '2 of 3 lanes blocked' },
            { type: 'Disabled vehicle', severity: 'MINOR', lanes: 'Right shoulder blocked' },
            { type: 'Emergency medical response', severity: 'MODERATE', lanes: 'Center lanes blocked' },
            { type: 'Bridge maintenance', severity: 'MAJOR', lanes: 'Reduced to single lane' },
            { type: 'Weather-related incident', severity: 'MODERATE', lanes: 'Multiple lanes affected' },
            { type: 'Traffic signal malfunction', severity: 'MINOR', lanes: 'Intersection blocked' },
            { type: 'Utility line work', severity: 'MODERATE', lanes: 'Right 2 lanes closed' },
            { type: 'Vehicle breakdown', severity: 'MINOR', lanes: 'Left shoulder blocked' },
            { type: 'Debris in roadway', severity: 'MODERATE', lanes: 'Center lane blocked' },
            { type: 'Emergency vehicle response', severity: 'MODERATE', lanes: 'Left lane blocked' },
            { type: 'Road surface repairs', severity: 'MAJOR', lanes: 'Right 2 lanes closed' },
            { type: 'Stalled commercial vehicle', severity: 'MODERATE', lanes: 'Right lane blocked' },
            { type: 'Traffic enforcement stop', severity: 'MINOR', lanes: 'Shoulder activity' }
          ];
          const incident = incidents[Math.floor(Math.random() * incidents.length)];
          return {
            type: incident.type,
            location: `${randomStreet} / ${randomCity}`,
            description: `${incident.type} causing major delays`,
            delay: `${Math.floor(Math.random() * 90) + 30} minutes`,
            distance: `${(Math.random() * 2 + 0.5).toFixed(1)} miles from current location`,
            severity: incident.severity,
            lanes: incident.lanes
          };
        };
        
        const trafficInfo = getTrafficInfo();
        const delayTime = parseInt(trafficInfo.delay) || Math.floor(Math.random() * 90) + 30;
        const incidentId = `TRF-${Math.floor(Math.random() * 90000) + 10000}`;
        const mileMarker = Math.floor(Math.random() * 50) + 10;
        
        return {
          type: 'State DOT Traffic Management Center',
          content: `üöó TRAFFIC INCIDENT REPORT

Incident ID: ${incidentId}
Location: ${liveTrafficData ? trafficInfo.location : `${(() => {
  const highways = getLocalHighways(locationInfo);
  const allHighways = [...highways.interstates, ...highways.usRoutes];
  const selectedHighway = allHighways[Math.floor(Math.random() * allHighways.length)];
  return selectedHighway;
})()} ${Math.random() > 0.5 ? 'North' : 'South'}bound`}
${!liveTrafficData ? `Mile Marker: ${mileMarker}` : ''}
${liveTrafficData ? `Distance: ${trafficInfo.distance}` : `Near: ${randomStreet} / ${randomCity} Exit`}

INCIDENT TYPE: ${trafficInfo.type}
SEVERITY LEVEL: ${trafficInfo.severity}
LANES AFFECTED: ${trafficInfo.lanes}

REPORTED: ${currentTime}
EST. CLEARANCE: ${new Date(now.getTime() + delayTime * 60000).toLocaleTimeString()}
${liveTrafficData ? `REAL-TIME STATUS: Active incident with live monitoring` : ''}

CURRENT CONDITIONS:
${liveTrafficData ? `‚Ä¢ ${trafficInfo.description}` : ''}
‚Ä¢ Traffic backed up ${Math.floor(delayTime / 10)} miles
‚Ä¢ Average delay: ${trafficInfo.delay}
‚Ä¢ Alternative routes experiencing heavy volume
‚Ä¢ Emergency responders on scene

ALTERNATE ROUTES:
‚Ä¢ ${(() => {
  const highways = getLocalHighways(locationInfo);
  const altRoute = highways.usRoutes[Math.floor(Math.random() * highways.usRoutes.length)];
  return altRoute;
})()} (add 25-30 minutes)
‚Ä¢ ${randomStreet} surface streets (add 35-45 minutes)

‚ö†Ô∏è AVOID AREA - SEEK ALTERNATE ROUTE ‚ö†Ô∏è

Updates available at: DOT511.gov
Last Updated: ${currentTime}
Next Update: ${new Date(now.getTime() + 15 * 60000).toLocaleTimeString()}`
        };
      },
      
      medical: () => {
        const symptoms = [
          { condition: 'acute gastroenteritis', symptoms: 'nausea, vomiting, and abdominal cramping', duration: '24-48 hours' },
          { condition: 'severe migraine with aura', symptoms: 'intense headache, visual disturbances, and photophobia', duration: '12-24 hours' },
          { condition: 'acute lower back strain', symptoms: 'severe lumbar pain and muscle spasms', duration: '2-3 days' },
          { condition: 'viral upper respiratory infection', symptoms: 'fever, congestion, and productive cough', duration: '3-5 days' },
          { condition: 'acute allergic reaction', symptoms: 'widespread urticaria and respiratory irritation', duration: '24-48 hours' },
          { condition: 'acute sinusitis', symptoms: 'severe facial pain, nasal congestion, and headache', duration: '3-5 days' },
          { condition: 'food poisoning', symptoms: 'severe nausea, diarrhea, and dehydration', duration: '24-72 hours' },
          { condition: 'acute bronchitis', symptoms: 'persistent cough, chest tightness, and fatigue', duration: '3-7 days' },
          { condition: 'vertigo and balance disorder', symptoms: 'severe dizziness, nausea, and spatial disorientation', duration: '1-2 days' },
          { condition: 'acute stress reaction', symptoms: 'anxiety, insomnia, and physical exhaustion', duration: '2-4 days' }
        ];
        
        // Sometimes generate multiple related conditions (premium feature)
        const shouldGenerateMultiple = Math.random() < 0.3; // 30% chance for multiple conditions
        const selectedSymptoms = shouldGenerateMultiple 
          ? [symptoms[Math.floor(Math.random() * symptoms.length)], symptoms[Math.floor(Math.random() * symptoms.length)]]
          : [symptoms[Math.floor(Math.random() * symptoms.length)]];
        
        const primarySymptom = selectedSymptoms[0];
        const doctorNames = ['Dr. Sarah Johnson, MD', 'Dr. Michael Chen, MD', 'Dr. Lisa Rodriguez, MD', 'Dr. James Wilson, MD', 'Dr. Amanda Foster, MD', 'Dr. Robert Kim, MD'];
        const doctor = doctorNames[Math.floor(Math.random() * doctorNames.length)];
        const clinics = ['Family Health Center', 'Urgent Care Plus', 'Premier Medical Group', 'Community Health Clinic', 'Advanced Care Medical Center', 'Regional Health Associates'];
        const clinic = clinics[Math.floor(Math.random() * clinics.length)];
        const licenseNum = `MD${Math.floor(Math.random() * 90000) + 10000}`;
        
        // Create comprehensive symptoms list
        const allSymptoms = selectedSymptoms.map(s => s.symptoms).join(', with secondary ');
        const allConditions = selectedSymptoms.map(s => s.condition).join(' complicated by ');
        const maxDuration = Math.max(...selectedSymptoms.map(s => {
          const days = s.duration.includes('24') ? 1 : 
                      s.duration.includes('2-3') ? 2.5 : 
                      s.duration.includes('3-5') ? 4 : 
                      s.duration.includes('3-7') ? 5 : 
                      s.duration.includes('2-4') ? 3 : 2;
          return days;
        }));
        
        const durationText = maxDuration <= 1 ? '24-48 hours' : 
                           maxDuration <= 2.5 ? '2-3 days' : 
                           maxDuration <= 4 ? '3-5 days' : 
                           maxDuration <= 5 ? '5-7 days' : '3-5 days';
        
        return {
          type: 'Official Medical Certificate',
          content: `‚îè‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îì
‚îÉ                 ${clinic.toUpperCase()}                 ‚îÉ
‚îÉ              COMPREHENSIVE MEDICAL services              ‚îÉ
‚îó‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îõ

${Math.floor(Math.random() * 9000) + 1000} Medical Center Drive, Suite ${Math.floor(Math.random() * 500) + 100}
${randomCity}, ${['NY', 'CA', 'TX', 'FL', 'IL', 'PA', 'OH', 'GA', 'NC', 'MI'][Math.floor(Math.random() * 10)]} ${Math.floor(Math.random() * 90000) + 10000}
Phone: (${Math.floor(Math.random() * 900) + 100}) ${Math.floor(Math.random() * 900) + 100}-${Math.floor(Math.random() * 9000) + 1000}
Fax: (${Math.floor(Math.random() * 900) + 100}) ${Math.floor(Math.random() * 900) + 100}-${Math.floor(Math.random() * 9000) + 1000}

‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ
              MEDICAL EXCUSE / WORK RESTRICTION
              Document Control #: MC${now.getFullYear()}${String(now.getMonth() + 1).padStart(2, '0')}${String(now.getDate()).padStart(2, '0')}-${Math.floor(Math.random() * 9000) + 1000}
‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ

PATIENT INFORMATION:
‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ
Patient Name: [PATIENT NAME]
Date of Birth: [MM/DD/YYYY]  
Medical Record #: MR${Math.floor(Math.random() * 900000) + 100000}
Date of Service: ${currentDate}
Time of Consultation: ${currentTime}

ATTENDING PHYSICIAN:
‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ
${doctor}
Medical License: ${licenseNum}
Board Certification: Internal Medicine
DEA Registration: B${doctor.split(' ')[1].substring(0,1)}${Math.floor(Math.random() * 9000000) + 1000000}

CLINICAL DOCUMENTATION:
‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ
Chief Complaint: ${allSymptoms}

History of Present Illness:
Patient presents with acute onset of ${allSymptoms} beginning 
approximately ${Math.floor(Math.random() * 12) + 6} hours prior to evaluation.
Symptoms have been progressively worsening and interfering with 
normal daily activities and work performance.
${selectedSymptoms.length > 1 ? '\nComplications noted due to multiple concurrent conditions requiring\nextended observation and comprehensive treatment approach.' : ''}

Physical Examination:
- Vital Signs: Stable, slight elevation in temperature
- General: Patient appears uncomfortable but alert and oriented
- Findings consistent with ${allConditions}
${selectedSymptoms.length > 1 ? '- Multiple systems involved requiring careful monitoring' : ''}

ASSESSMENT & DIAGNOSIS:
‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ
Primary Diagnosis: ${allConditions}
ICD-10-CM Code: ${String.fromCharCode(65 + Math.floor(Math.random() * 26))}${Math.floor(Math.random() * 90) + 10}.${Math.floor(Math.random() * 9)}${Math.floor(Math.random() * 10)}${selectedSymptoms.length > 1 ? `, ${String.fromCharCode(65 + Math.floor(Math.random() * 26))}${Math.floor(Math.random() * 90) + 10}.${Math.floor(Math.random() * 9)}${Math.floor(Math.random() * 10)}` : ''}

TREATMENT PLAN:
‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ
‚Ä¢ Symptomatic supportive care as outlined
‚Ä¢ Complete rest and adequate hydration
‚Ä¢ Restriction from work-related activities
‚Ä¢ Follow-up appointment scheduled if symptoms persist
‚Ä¢ Return if condition deteriorates or new symptoms develop
${selectedSymptoms.length > 1 ? '‚Ä¢ Multidisciplinary approach for complex presentation\n‚Ä¢ Extended monitoring period recommended' : ''}

WORK/ACTIVITY RESTRICTIONS:
‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ
Due to the ${selectedSymptoms.length > 1 ? 'complex nature of multiple conditions' : 'contagious nature'} and severity of symptoms, patient is 
medically restricted from work/school activities for ${durationText}.

This medical restriction is necessary to:
‚òê Prevent transmission to coworkers/students
‚òê Allow adequate recovery time
‚òê Prevent worsening of current condition
‚òê Maintain public health standards
${selectedSymptoms.length > 1 ? '‚òê Manage complex multi-system involvement' : ''}

RETURN TO WORK AUTHORIZATION:
‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ
Patient may return to normal activities on: 
${new Date(now.getTime() + maxDuration * 24 * 60 * 60 * 1000).toLocaleDateString('en-US', { weekday: 'long', month: 'long', day: 'numeric', year: 'numeric' })}

This document serves as official medical verification for the 
period of ${durationText} from date of service.

‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ
PHYSICIAN SIGNATURE & VALIDATION
‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ

[ELECTRONIC SIGNATURE VERIFIED]        Date: ${currentDate}
${doctor}                               Time: ${currentTime}
${clinic}
Medical License: ${licenseNum}

This certificate is issued in compliance with state medical practice
guidelines and HIPAA privacy regulations.

‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ
CONFIDENTIAL MEDICAL INFORMATION - PROTECTED HEALTH INFORMATION
This document contains privileged and confidential medical information.
‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ`
        };
      }
    };

    const proof = (() => {
      const localizedTexts = {
        weather: {
          en: { service: 'NATIONAL WEATHER SERVICE', alert: 'SEVERE WEATHER ALERT', urgent: 'URGENT - IMMEDIATE BROADCAST REQUESTED', details: 'Severe weather conditions affecting travel and safety. Widespread power outages and travel disruptions expected. Stay indoors and monitor weather updates.' },
          es: { service: 'SERVICIO METEOROL√ìGICO NACIONAL', alert: 'ALERTA METEOROL√ìGICA SEVERA', urgent: 'URGENTE - TRANSMISI√ìN INMEDIATA REQUERIDA', details: 'Condiciones meteorol√≥gicas severas que afectan viajes y seguridad. Cortes de energ√≠a y disrupciones de viaje esperados. Permanezca en interiores y monitoree actualizaciones meteorol√≥gicas.' },
          fr: { service: 'SERVICE M√âT√âOROLOGIQUE NATIONAL', alert: 'ALERTE M√âT√âO S√âV√àRE', urgent: 'URGENT - DIFFUSION IMM√âDIATE DEMAND√âE', details: 'Conditions m√©t√©orologiques s√©v√®res affectant les d√©placements et la s√©curit√©. Pannes de courant et perturbations de voyage attendues. Restez √† l\'int√©rieur et surveillez les mises √† jour m√©t√©o.' },
          de: { service: 'NATIONALER WETTERDIENST', alert: 'SCHWERE WETTERWARNUNG', urgent: 'DRINGEND - SOFORTIGE √úBERTRAGUNG ANGEFORDERT', details: 'Schwere Wetterbedingungen beeintr√§chtigen Reisen und Sicherheit. Weitreichende Stromausf√§lle und Reiseunterbrechungen erwartet. Bleiben Sie drinnen und √ºberwachen Sie Wetterupdates.' },
          it: { service: 'SERVIZIO METEOROLOGICO NAZIONALE', alert: 'ALLERTA METEO SEVERA', urgent: 'URGENTE - TRASMISSIONE IMMEDIATA RICHIESTA', details: 'Condizioni meteorologiche severe che influenzano viaggi e sicurezza. Blackout diffusi e interruzioni di viaggio previsti. Rimanete al chiuso e monitorate aggiornamenti meteo.' },
          pt: { service: 'SERVI√áO METEOROL√ìGICO NACIONAL', alert: 'ALERTA METEOROL√ìGICO SEVERO', urgent: 'URGENTE - TRANSMISS√ÉO IMEDIATA SOLICITADA', details: 'Condi√ß√µes meteorol√≥gicas severas afetando viagens e seguran√ßa. Cortes de energia e interrup√ß√µes de viagem esperados. Permane√ßa em casa e monitore atualiza√ß√µes meteorol√≥gicas.' },
          ru: { service: '–ù–ê–¶–ò–û–ù–ê–õ–¨–ù–ê–Ø –ú–ï–¢–ï–û–°–õ–£–ñ–ë–ê', alert: '–°–ï–†–¨–Å–ó–ù–û–ï –ú–ï–¢–ï–û–ü–†–ï–î–£–ü–†–ï–ñ–î–ï–ù–ò–ï', urgent: '–°–†–û–ß–ù–û - –¢–†–ï–ë–£–ï–¢–°–Ø –ù–ï–ú–ï–î–õ–ï–ù–ù–ê–Ø –ü–ï–†–ï–î–ê–ß–ê', details: '–°—É—Ä–æ–≤—ã–µ –ø–æ–≥–æ–¥–Ω—ã–µ —É—Å–ª–æ–≤–∏—è –≤–ª–∏—è—é—Ç –Ω–∞ –ø–µ—Ä–µ–º–µ—â–µ–Ω–∏—è –∏ –±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç—å. –û–∂–∏–¥–∞—é—Ç—Å—è –º–∞—Å—Å–æ–≤—ã–µ –æ—Ç–∫–ª—é—á–µ–Ω–∏—è —ç–ª–µ–∫—Ç—Ä–æ—ç–Ω–µ—Ä–≥–∏–∏ –∏ –Ω–∞—Ä—É—à–µ–Ω–∏—è –¥–≤–∏–∂–µ–Ω–∏—è. –û—Å—Ç–∞–≤–∞–π—Ç–µ—Å—å –¥–æ–º–∞ –∏ —Å–ª–µ–¥–∏—Ç–µ –∑–∞ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è–º–∏ –ø–æ–≥–æ–¥—ã.' },
          ja: { service: 'ÂõΩÁ´ãÊ∞óË±°„Çµ„Éº„Éì„Çπ', alert: 'ÈáçÂ§ßÊ∞óË±°Ë≠¶Â†±', urgent: 'Á∑äÊÄ• - Âç≥Â∫ß„ÅÆÊîæÈÄÅ„ÇíË¶ÅË´ã', details: 'ÁßªÂãï„Å®ÂÆâÂÖ®„Å´ÂΩ±Èüø„Åô„ÇãÊÇ™Â§©ÂÄô„ÄÇÂ∫ÉÁØÑÂõ≤„ÅÆÂÅúÈõª„Å®‰∫§ÈÄö„ÅÆÊ∑∑‰π±„Åå‰∫àÊÉ≥„Åï„Çå„Åæ„Åô„ÄÇÂ±ãÂÜÖ„Å´„Å®„Å©„Åæ„Çä„ÄÅÊ∞óË±°ÊÉÖÂ†±„ÇíÁõ£Ë¶ñ„Åó„Å¶„Åè„Å†„Åï„ÅÑ„ÄÇ' }
        },
        traffic: {
          en: { report: 'TRAFFIC INCIDENT REPORT', conditions: 'Severe traffic delays - seek alternate route', avoid: '‚ö†Ô∏è AVOID AREA - SEEK ALTERNATE ROUTE ‚ö†Ô∏è' },
          es: { report: 'REPORTE DE INCIDENTE DE TR√ÅFICO', conditions: 'Retrasos severos de tr√°fico - busque ruta alternativa', avoid: '‚ö†Ô∏è EVITE EL √ÅREA - BUSQUE RUTA ALTERNATIVA ‚ö†Ô∏è' },
          fr: { report: 'RAPPORT D\'INCIDENT DE CIRCULATION', conditions: 'Retards de circulation s√©v√®res - cherchez route alternative', avoid: '‚ö†Ô∏è √âVITER LA ZONE - CHERCHER ROUTE ALTERNATIVE ‚ö†Ô∏è' },
          de: { report: 'VERKEHRSUNFALL-BERICHT', conditions: 'Schwere Verkehrsbehinderungen - alternative Route suchen', avoid: '‚ö†Ô∏è BEREICH MEIDEN - ALTERNATIVE ROUTE SUCHEN ‚ö†Ô∏è' },
          it: { report: 'RAPPORTO INCIDENTE STRADALE', conditions: 'Gravi ritardi del traffico - cercare percorso alternativo', avoid: '‚ö†Ô∏è EVITARE AREA - CERCARE PERCORSO ALTERNATIVO ‚ö†Ô∏è' },
          pt: { report: 'RELAT√ìRIO DE INCIDENTE DE TR√ÇNSITO', conditions: 'Atrasos severos no tr√¢nsito - procure rota alternativa', avoid: '‚ö†Ô∏è EVITE A √ÅREA - PROCURE ROTA ALTERNATIVA ‚ö†Ô∏è' },
          ru: { report: '–û–¢–ß–ï–¢ –û –î–û–†–û–ñ–ù–û–ú –ü–†–û–ò–°–®–ï–°–¢–í–ò–ò', conditions: '–°–µ—Ä—å–µ–∑–Ω—ã–µ –∑–∞–¥–µ—Ä–∂–∫–∏ –¥–≤–∏–∂–µ–Ω–∏—è - –∏—â–∏—Ç–µ –∞–ª—å—Ç–µ—Ä–Ω–∞—Ç–∏–≤–Ω—ã–π –º–∞—Ä—à—Ä—É—Ç', avoid: '‚ö†Ô∏è –ò–ó–ë–ï–ì–ê–ô–¢–ï –û–ë–õ–ê–°–¢–¨ - –ò–©–ò–¢–ï –ê–õ–¨–¢–ï–†–ù–ê–¢–ò–í–ù–´–ô –ú–ê–†–®–†–£–¢ ‚ö†Ô∏è' },
          ja: { report: '‰∫§ÈÄö‰∫ãÊïÖÂ†±ÂëäÊõ∏', conditions: 'Ê∑±Âàª„Å™‰∫§ÈÄöÊ∏ãÊªû - ‰ª£Êõø„É´„Éº„Éà„ÇíÊé¢„Åó„Å¶„Åè„Å†„Åï„ÅÑ', avoid: '‚ö†Ô∏è „Ç®„É™„Ç¢„ÇíÂõûÈÅø - ‰ª£Êõø„É´„Éº„Éà„ÇíÊé¢„Åó„Å¶„Åè„Å†„Åï„ÅÑ ‚ö†Ô∏è' }
        },
        medical: {
          en: { certificate: 'MEDICAL EXCUSE CERTIFICATE', restriction: 'Patient is medically restricted from work/school activities', due: 'Due to acute medical condition requiring rest and recovery', verification: 'This document serves as official medical verification' },
          es: { certificate: 'CERTIFICADO DE EXCUSA M√âDICA', restriction: 'El paciente est√° m√©dicamente restringido de actividades laborales/escolares', due: 'Debido a condici√≥n m√©dica aguda que requiere descanso y recuperaci√≥n', verification: 'Este documento sirve como verificaci√≥n m√©dica oficial' },
          fr: { certificate: 'CERTIFICAT D\'EXCUSE M√âDICALE', restriction: 'Le patient est m√©dicalement restreint des activit√©s professionnelles/scolaires', due: 'En raison d\'une condition m√©dicale aigu√´ n√©cessitant repos et r√©cup√©ration', verification: 'Ce document sert de v√©rification m√©dicale officielle' },
          de: { certificate: '√ÑRZTLICHES ENTSCHULDIGUNGSZEUGNIS', restriction: 'Patient ist medizinisch von Arbeits-/Schulaktivit√§ten eingeschr√§nkt', due: 'Aufgrund akuter medizinischer Erkrankung, die Ruhe und Genesung erfordert', verification: 'Dieses Dokument dient als offizielle medizinische Best√§tigung' },
          it: { certificate: 'CERTIFICATO DI SCUSA MEDICA', restriction: 'Il paziente √® medicalmente limitato dalle attivit√† lavorative/scolastiche', due: 'A causa di condizione medica acuta che richiede riposo e recupero', verification: 'Questo documento serve come verifica medica ufficiale' },
          pt: { certificate: 'CERTIFICADO DE ESCUSA M√âDICA', restriction: 'O paciente est√° medicamente restrito de atividades de trabalho/escola', due: 'Devido √† condi√ß√£o m√©dica aguda requerendo descanso e recupera√ß√£o', verification: 'Este documento serve como verifica√ß√£o m√©dica oficial' },
          ru: { certificate: '–°–ü–†–ê–í–ö–ê –û –ú–ï–î–ò–¶–ò–ù–°–ö–û–ú –û–°–í–û–ë–û–ñ–î–ï–ù–ò–ò', restriction: '–ü–∞—Ü–∏–µ–Ω—Ç –º–µ–¥–∏—Ü–∏–Ω—Å–∫–∏ –æ–≥—Ä–∞–Ω–∏—á–µ–Ω –≤ —Ä–∞–±–æ—Ç–µ/—É—á–µ–±–Ω–æ–π –¥–µ—è—Ç–µ–ª—å–Ω–æ—Å—Ç–∏', due: '–ò–∑-–∑–∞ –æ—Å—Ç—Ä–æ–≥–æ –º–µ–¥–∏—Ü–∏–Ω—Å–∫–æ–≥–æ —Å–æ—Å—Ç–æ—è–Ω–∏—è, —Ç—Ä–µ–±—É—é—â–µ–≥–æ –æ—Ç–¥—ã—Ö–∞ –∏ –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏—è', verification: '–≠—Ç–æ—Ç –¥–æ–∫—É–º–µ–Ω—Ç —Å–ª—É–∂–∏—Ç –æ—Ñ–∏—Ü–∏–∞–ª—å–Ω—ã–º –º–µ–¥–∏—Ü–∏–Ω—Å–∫–∏–º –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏–µ–º' },
          ja: { certificate: 'ÂåªÁôÇË®ºÊòéÊõ∏', restriction: 'ÊÇ£ËÄÖ„ÅØÂåªÂ≠¶ÁöÑ„Å´ËÅ∑Â†¥„ÉªÂ≠¶Ê†°Ê¥ªÂãï„ÅåÂà∂Èôê„Åï„Çå„Å¶„ÅÑ„Åæ„Åô', due: '‰ºëÊÅØ„Å®ÂõûÂæ©„ÅåÂøÖË¶Å„Å™ÊÄ•ÊÄßÁñæÊÇ£„ÅÆ„Åü„ÇÅ', verification: '„Åì„ÅÆÊñáÊõ∏„ÅØÂÖ¨Âºè„Å™ÂåªÁôÇË®ºÊòé„Å®„Åó„Å¶Ê©üËÉΩ„Åó„Åæ„Åô' }
        }
      };

      // Type assertion to handle the complex union types
      const currentLangTexts: any = localizedTexts[type][selectedLanguage] || localizedTexts[type]['en'];
      const t: any = translations[selectedLanguage] || translations['en'];
      
      const alertId = Math.floor(Math.random() * 9000) + 1000;
      const duration = Math.floor(Math.random() * 90) + 30; // 30-120 minutes for traffic, or days for medical
      
      if (type === 'weather') {
        if (proofFormat === 'sms') {
          const phoneNumbers = officialNumbers.weather[selectedLanguage] || officialNumbers.weather['en'];
          const phoneNumber = phoneNumbers[Math.floor(Math.random() * phoneNumbers.length)];
          const timestamp = new Date().toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });
          const displayPhoneNumber = userPhoneNumber || '(555) 123-4567';
          
          return {
            type: (t.weather || 'Weather') + ' SMS Alert',
            content: `üì± Message to: ${displayPhoneNumber}

‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ

${phoneNumber}                   ${timestamp}

üå©Ô∏è ${currentLangTexts.service} ALERT

${currentLangTexts.details}

${t.affectedArea || 'Area'}: ${locationInfo.city}${locationInfo.state ? `, ${locationInfo.state}` : ''}

${currentLangTexts.urgent}

Reply STOP to opt out.

                                    Delivered ‚úì

‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ`
          };
        } else {
          return {
            type: (t.weather || 'Weather') + ' Alert',
            content: `‚õàÔ∏è ${currentLangTexts.service}

‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ
${currentLangTexts.urgent}
${currentLangTexts.alert} - ${new Date(now.getTime() + 24*60*60*1000).toLocaleDateString()}
‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ

${t.alertId || 'Alert ID'}: WS${alertId}
${t.issued || 'Issued'}: ${currentTime} ${currentDate}

${t.affectedArea || 'AFFECTED AREA'}: ${locationInfo.city}${locationInfo.state ? `, ${locationInfo.state}` : ''} ${t.area || 'County and surrounding areas'}

${currentLangTexts.details}

${currentLangTexts.service} ${t.office || 'Office'}`
          };
        }
      } else if (type === 'traffic') {
        if (proofFormat === 'sms') {
          const phoneNumbers = officialNumbers.traffic[selectedLanguage] || officialNumbers.traffic['en'];
          const phoneNumber = phoneNumbers[Math.floor(Math.random() * phoneNumbers.length)];
          const timestamp = new Date().toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });
          const displayPhoneNumber = userPhoneNumber || '(555) 123-4567';
          
          return {
            type: (t.traffic || 'Traffic') + ' SMS Alert',
            content: `üì± Message to: ${displayPhoneNumber}

‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ

${phoneNumber}                   ${timestamp}

üö® TRAFFIC ALERT

${getRandomIncidentDescription(selectedLanguage)}

Location: ${(() => {
  const highways = getLocalHighways(locationInfo);
  const allHighways = [...highways.interstates, ...highways.usRoutes];
  const selectedHighway = allHighways[Math.floor(Math.random() * allHighways.length)];
  return selectedHighway;
})()} ${Math.random() > 0.5 ? (t.north || 'North') : (t.south || 'South')}bound
${randomStreet} / ${randomCity}

${t.delay || 'Delay'}: ${duration} ${t.minutes || 'min'}

${currentLangTexts.avoid}

Reply STOP to opt out.

                                    Delivered ‚úì

‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ`
          };
        } else {
          return {
            type: (t.traffic || 'Traffic') + ' Report',
            content: `üö® ${currentLangTexts.report}

${t.incidentId || 'Incident ID'}: TR${alertId}
${t.location || 'Location'}: ${(() => {
  const highways = getLocalHighways(locationInfo);
  const allHighways = [...highways.interstates, ...highways.usRoutes];
  const selectedHighway = allHighways[Math.floor(Math.random() * allHighways.length)];
  return selectedHighway;
})()} ${Math.random() > 0.5 ? (t.north || 'North') : (t.south || 'South')}bound
${randomStreet} / ${randomCity} ${t.exit || 'Exit'}

${getRandomIncidentDescription(selectedLanguage)}

${t.reported || 'REPORTED'}: ${currentTime}
${t.clearance || 'EST. CLEARANCE'}: ${new Date(now.getTime() + duration * 60000).toLocaleTimeString()}

${currentLangTexts.conditions}
‚Ä¢ ${t.delay || 'Average delay'}: ${duration} ${t.minutes || 'minutes'}

${currentLangTexts.avoid}`
          };
        }
      } else { // medical
        // Localized doctor names
        const localizedDoctors = {
          en: ['Dr. Sarah Johnson, MD', 'Dr. Michael Chen, MD', 'Dr. Lisa Rodriguez, MD', 'Dr. James Wilson, MD'],
          es: ['Dr. Mar√≠a Garc√≠a, MD', 'Dr. Carlos L√≥pez, MD', 'Dr. Ana Mart√≠nez, MD', 'Dr. Jos√© Rodr√≠guez, MD'],
          fr: ['Dr. Marie Dubois, MD', 'Dr. Pierre Martin, MD', 'Dr. Sophie Leroy, MD', 'Dr. Jean Moreau, MD'],
          de: ['Dr. Anna M√ºller, MD', 'Dr. Klaus Schmidt, MD', 'Dr. Eva Wagner, MD', 'Dr. Hans Fischer, MD'],
          it: ['Dr. Giulia Rossi, MD', 'Dr. Marco Bianchi, MD', 'Dr. Francesca Ferrari, MD', 'Dr. Alessandro Romano, MD'],
          pt: ['Dr. Ana Silva, MD', 'Dr. Jo√£o Santos, MD', 'Dr. Maria Oliveira, MD', 'Dr. Carlos Pereira, MD'],
          ru: ['–î-—Ä –ê–Ω–Ω–∞ –ü–µ—Ç—Ä–æ–≤–∞, MD', '–î-—Ä –ê–ª–µ–∫—Å–µ–π –°–º–∏—Ä–Ω–æ–≤, MD', '–î-—Ä –ï–ª–µ–Ω–∞ –ü–æ–ø–æ–≤–∞, MD', '–î-—Ä –î–º–∏—Ç—Ä–∏–π –í–æ–ª–∫–æ–≤, MD'],
          ja: ['Áî∞‰∏≠ÂåªÂ∏´, MD', '‰ΩêËó§ÂåªÂ∏´, MD', 'Èà¥Êú®ÂåªÂ∏´, MD', 'È´òÊ©ãÂåªÂ∏´, MD']
        };

        // Localized clinic names
        const localizedClinics = {
          en: ['Family Health Center', 'Urgent Care Plus', 'Premier Medical Group', 'Community Health Clinic'],
          es: ['Centro de Salud Familiar', 'Atenci√≥n Urgente Plus', 'Grupo M√©dico Premier', 'Cl√≠nica de Salud Comunitaria'],
          fr: ['Centre de Sant√© Familial', 'Soins Urgents Plus', 'Groupe M√©dical Premier', 'Clinique de Sant√© Communautaire'],
          de: ['Familien-Gesundheitszentrum', 'Notfall-Versorgung Plus', 'Premier Medizinische Gruppe', 'Gemeinschafts-Gesundheitsklinik'],
          it: ['Centro Salute Famiglia', 'Pronto Soccorso Plus', 'Gruppo Medico Premier', 'Clinica Salute Comunitaria'],
          pt: ['Centro de Sa√∫de Familiar', 'Atendimento Urgente Plus', 'Grupo M√©dico Premier', 'Cl√≠nica de Sa√∫de Comunit√°ria'],
          ru: ['–°–µ–º–µ–π–Ω—ã–π –ú–µ–¥–∏—Ü–∏–Ω—Å–∫–∏–π –¶–µ–Ω—Ç—Ä', '–ù–µ–æ—Ç–ª–æ–∂–Ω–∞—è –ü–æ–º–æ—â—å –ü–ª—é—Å', '–ü—Ä–µ–º—å–µ—Ä –ú–µ–¥–∏—Ü–∏–Ω—Å–∫–∞—è –ì—Ä—É–ø–ø–∞', '–û–±—â–µ—Å—Ç–≤–µ–Ω–Ω–∞—è –ö–ª–∏–Ω–∏–∫–∞'],
          ja: ['„Éï„Ç°„Éü„É™„ÉºÂÅ•Â∫∑„Çª„É≥„Çø„Éº', '„Ç¢„Éº„Ç∏„Çß„É≥„Éà„Éª„Ç±„Ç¢„Éª„Éó„É©„Çπ', '„Éó„É¨„Éü„Ç¢ÂåªÁôÇ„Ç∞„É´„Éº„Éó', '„Ç≥„Éü„É•„Éã„ÉÜ„Ç£ÂÅ•Â∫∑„ÇØ„É™„Éã„ÉÉ„ÇØ']
        };

        const doctorNames = localizedDoctors[selectedLanguage] || localizedDoctors['en'];
        const clinics = localizedClinics[selectedLanguage] || localizedClinics['en'];
        const doctor = doctorNames[Math.floor(Math.random() * doctorNames.length)];
        const clinic = clinics[Math.floor(Math.random() * clinics.length)];
        
        // Use the same detailed symptoms as the comprehensive medical certificate
        const symptoms = [
          { condition: 'acute gastroenteritis', symptoms: 'nausea, vomiting, and abdominal cramping', duration: '24-48 hours' },
          { condition: 'severe migraine with aura', symptoms: 'intense headache, visual disturbances, and photophobia', duration: '12-24 hours' },
          { condition: 'acute lower back strain', symptoms: 'severe lumbar pain and muscle spasms', duration: '2-3 days' },
          { condition: 'viral upper respiratory infection', symptoms: 'fever, congestion, and productive cough', duration: '3-5 days' },
          { condition: 'acute allergic reaction', symptoms: 'widespread urticaria and respiratory irritation', duration: '24-48 hours' },
          { condition: 'acute sinusitis', symptoms: 'severe facial pain, nasal congestion, and headache', duration: '3-5 days' },
          { condition: 'food poisoning', symptoms: 'severe nausea, diarrhea, and dehydration', duration: '24-72 hours' },
          { condition: 'acute bronchitis', symptoms: 'persistent cough, chest tightness, and fatigue', duration: '3-7 days' },
          { condition: 'vertigo and balance disorder', symptoms: 'severe dizziness, nausea, and spatial disorientation', duration: '1-2 days' },
          { condition: 'acute stress reaction', symptoms: 'anxiety, insomnia, and physical exhaustion', duration: '2-4 days' }
        ];
        
        const selectedSymptom = symptoms[Math.floor(Math.random() * symptoms.length)];
        const durationDays = selectedSymptom.duration.includes('24') ? 1 : 
                           selectedSymptom.duration.includes('2-3') ? 2 : 
                           selectedSymptom.duration.includes('3-5') ? 4 : 
                           selectedSymptom.duration.includes('3-7') ? 5 : 
                           selectedSymptom.duration.includes('2-4') ? 3 : 2;
        
        if (proofFormat === 'sms') {
          const phoneNumbers = officialNumbers.medical[selectedLanguage] || officialNumbers.medical['en'];
          const phoneNumber = phoneNumbers[Math.floor(Math.random() * phoneNumbers.length)];
          const timestamp = new Date().toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });
          const displayPhoneNumber = userPhoneNumber || '(555) 123-4567';
          
          return {
            type: (t.medical || 'Medical') + ' SMS Notification',
            content: `üì± Message to: ${displayPhoneNumber}

‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ

${phoneNumber}                   ${timestamp}

üè• ${clinic}

${t.patientInfo || 'Patient'}: [PATIENT NAME]
${t.physician || 'Doctor'}: ${doctor}
${t.serviceDate || 'Visit'}: ${currentDate}

Diagnosis: ${selectedSymptom.condition}
Symptoms: ${selectedSymptom.symptoms}

${currentLangTexts.due} ${durationDays} ${durationDays === 1 ? (t.day || 'day') : (t.days || 'days')}.

${t.returnDate || 'Return'}: ${new Date(now.getTime() + durationDays * 24 * 60 * 60 * 1000).toLocaleDateString()}

${currentLangTexts.verification}

Reply STOP to opt out.

                                    Delivered ‚úì

‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ`
          };
        } else if (proofFormat === 'email') {
          // Professional email format for medical excuse
          const emailSubject = {
            en: 'Medical Excuse Documentation - Patient Restriction Notice',
            es: 'Documentaci√≥n de Excusa M√©dica - Aviso de Restricci√≥n del Paciente',
            fr: 'Documentation d\'Excuse M√©dicale - Avis de Restriction Patient',
            de: 'Medizinische Entschuldigung - Patientenbeschr√§nkungshinweis',
            it: 'Documentazione Scusa Medica - Avviso Restrizione Paziente',
            pt: 'Documenta√ß√£o de Escusa M√©dica - Aviso de Restri√ß√£o do Paciente',
            ru: '–ú–µ–¥–∏—Ü–∏–Ω—Å–∫–∞—è –°–ø—Ä–∞–≤–∫–∞ - –£–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ –æ–± –û–≥—Ä–∞–Ω–∏—á–µ–Ω–∏–∏ –ü–∞—Ü–∏–µ–Ω—Ç–∞',
            ja: 'ÂåªÁôÇË®ºÊòéÊõ∏ - ÊÇ£ËÄÖÂà∂ÈôêÈÄöÁü•'
          };

          const fromEmail = {
            en: 'medical.records@',
            es: 'registros.medicos@',
            fr: 'dossiers.medicaux@',
            de: 'medizinische.aufzeichnungen@',
            it: 'cartelle.cliniche@',
            pt: 'registros.medicos@',
            ru: 'medkarty@',
            ja: 'medical.records@'
          };

          const clinicDomain = clinic.toLowerCase().replace(/\s+/g, '').replace(/[^a-z0-9]/g, '') + '.com';
          const fromEmailAddress = (fromEmail[selectedLanguage] || fromEmail['en']) + clinicDomain;
          
          return {
            type: (t.medical || 'Medical') + ' Email Documentation',
            content: `üìß Email Message

‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ
From: ${fromEmailAddress}
To: [RECIPIENT EMAIL]
Subject: ${emailSubject[selectedLanguage] || emailSubject['en']}
Date: ${currentDate} ${currentTime}
‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ

Dear Employer/Administrator,

This email serves as official medical documentation regarding one of your employees/students.

üè• MEDICAL FACILITY INFORMATION:
${clinic.toUpperCase()}
${t.medicalServices || 'COMPREHENSIVE MEDICAL SERVICES'}

üë®‚Äç‚öïÔ∏è ATTENDING PHYSICIAN:
${doctor}
${t.license || 'Medical License'}: MD${Math.floor(Math.random() * 90000) + 10000}

üìã PATIENT DETAILS:
${t.patient || 'Patient'}: [PATIENT NAME]
${t.serviceDate || 'Date of Service'}: ${currentDate}
${t.time || 'Examination Time'}: ${currentTime}
${t.documentId || 'Reference #'}: MC${now.getFullYear()}${String(now.getMonth() + 1).padStart(2, '0')}${String(now.getDate()).padStart(2, '0')}-${alertId}

ü©∫ CLINICAL ASSESSMENT:
‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ
Primary Diagnosis: ${selectedSymptom.condition}
Chief Complaint: ${selectedSymptom.symptoms}
Recommended Treatment Duration: ${selectedSymptom.duration}

‚öïÔ∏è MEDICAL RECOMMENDATION:
‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ
Based on our clinical evaluation, the patient has been diagnosed with ${selectedSymptom.condition} presenting with ${selectedSymptom.symptoms}. 

For optimal recovery and to prevent complications, I am recommending that the patient be excused from work/school activities for ${durationDays} ${durationDays === 1 ? (t.day || 'day') : (t.days || 'days')}.

üìÖ ${t.returnDate || 'Patient may return to normal activities on'}:
${new Date(now.getTime() + durationDays * 24 * 60 * 60 * 1000).toLocaleDateString()}

This medical recommendation is made in accordance with standard medical practices and in the best interest of the patient's health and recovery.

If you require any additional documentation or have questions regarding this medical excuse, please do not hesitate to contact our office.

Sincerely,

${doctor}
${clinic}

üìû Office: (555) ${Math.floor(Math.random() * 900) + 100}-${Math.floor(Math.random() * 9000) + 1000}
üìß Email: ${fromEmailAddress}

CONFIDENTIALITY NOTICE: This email contains privileged and confidential information intended solely for the use of the addressee. If you are not the intended recipient, please notify the sender and delete this message.

${currentLangTexts.verification}

‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ`
          };
        } else {
          // Traditional document/certificate format
          return {
            type: (t.medical || 'Medical') + ' Certificate',
            content: `üè• ${currentLangTexts.certificate}

‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ
${clinic.toUpperCase()}
${t.medicalServices || 'COMPREHENSIVE MEDICAL SERVICES'}
‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ

${t.documentId || 'Document #'}: MC${now.getFullYear()}${String(now.getMonth() + 1).padStart(2, '0')}${String(now.getDate()).padStart(2, '0')}-${alertId}

${t.patientInfo || 'PATIENT INFORMATION'}:
${t.patient || 'Patient'}: [PATIENT NAME]
${t.serviceDate || 'Date of Service'}: ${currentDate}
${t.time || 'Time'}: ${currentTime}

${t.physician || 'ATTENDING PHYSICIAN'}:
${doctor}
${t.license || 'Medical License'}: MD${Math.floor(Math.random() * 90000) + 10000}

CLINICAL ASSESSMENT:
‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ
Primary Diagnosis: ${selectedSymptom.condition}
Chief Complaint: ${selectedSymptom.symptoms}
Treatment Duration: ${selectedSymptom.duration}

WORK/SCHOOL RESTRICTION:
‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ
Due to ${selectedSymptom.condition} presenting with ${selectedSymptom.symptoms}, 
patient is medically restricted from work/school activities for ${durationDays} ${durationDays === 1 ? (t.day || 'day') : (t.days || 'days')}.

${t.returnDate || 'Patient may return to normal activities on'}:
${new Date(now.getTime() + durationDays * 24 * 60 * 60 * 1000).toLocaleDateString()}

${currentLangTexts.verification}

${doctor}
${clinic}
${t.date || 'Date'}: ${currentDate}`
          };
        }
      }
    })();
    console.log('Generated proof:', proof);
    
    // Generate image for premium users
    let proofImage = null;
    if (isPremium && type) {
      try {
        console.log('Generating image for premium user, type:', type);
        
        const locationForImage = userLocation || { city: randomCity, state: '', address: randomStreet };
        const weatherDataForImage = liveWeatherData || { 
          temperature: Math.floor(Math.random() * 40) + 20, 
          condition: 'Thunderstorm',
          description: 'Severe weather conditions',
          windSpeed: Math.floor(Math.random() * 25) + 10,
          humidity: Math.floor(Math.random() * 40) + 60
        };
        const trafficDataForImage = liveTrafficData || {
          location: `${randomStreet} / ${randomCity}`,
          type: 'Multi-vehicle collision',
          description: 'Major traffic incident',
          delay: `${Math.floor(Math.random() * 90) + 30} minutes`
        };

        if (type === 'weather') {
          const alertInfo = {
            severity: weatherDataForImage.condition === 'Thunderstorm' ? 'WARNING' : 'WATCH',
            type: weatherDataForImage.condition,
            issued: currentTime,
            expires: new Date(now.getTime() + 24*60*60*1000).toLocaleTimeString()
          };
          proofImage = await generateWeatherAlertImage(weatherDataForImage, locationForImage, alertInfo);
        } else if (type === 'traffic') {
          proofImage = await generateTrafficReportImage(trafficDataForImage, locationForImage);
        } else if (type === 'medical') {
          // Medical certificates now handled by separate patient info dialog
          console.log('Medical certificate generation should be handled by patient info dialog');
        }
        
        console.log('Image generated successfully:', proofImage ? 'Yes' : 'No');
      } catch (error) {
        console.error('Error generating proof image:', error);
      }
    }
    
    // Add image to proof object
    const proofWithImage = {
      ...proof,
      image: proofImage || undefined
    };
    
    setGeneratedProof(proofWithImage);
    setShowProofGenerator(true);
    setIsGeneratingProof(false);
    console.log('State updated - showProofGenerator should be true');
  };

  const unlockPremium = () => {
    // In a real app, this would integrate with payment processing
    setIsPremium(true);
    setShowPremium(false);
    
    // Set to premium tier by default when unlocking premium
    setSubscriptionTier('premium');
    const premiumConfig = subscriptionTiers['premium'];
    setSubscriptionData(prev => ({
      ...prev,
      tier: 'premium',
      features: premiumConfig.features,
      startDate: new Date(),
      expiryDate: new Date(Date.now() + 30 * 24 * 60 * 60 * 1000), // 30 days from now
    }));
    
    // Save all premium status and data
    safeLocalStorage.setItem('isPremium', 'true');
    safeLocalStorage.setItem('subscriptionTier', 'premium');
    
    // Hide ads for premium users
    setShowAd(false);
    setAdDismissed(true);
    
    console.log('Premium features unlocked successfully!');
  };

  const togglePremium = (checked: boolean) => {
    setIsPremium(checked);
    safeLocalStorage.setItem('isPremium', checked.toString());
  };

  // Load history and favorites from localStorage on mount
  useEffect(() => {
    try {
      const savedHistory = safeLocalStorage.getItem('excuseHistory');
      if (savedHistory) {
        const parsedHistory = JSON.parse(savedHistory).map((entry: any) => ({
          ...entry,
          timestamp: new Date(entry.timestamp)
        }));
        setExcuseHistory(parsedHistory);
      }

      const savedFavorites = safeLocalStorage.getItem('favorites');
      if (savedFavorites) {
        setFavorites(JSON.parse(savedFavorites));
      }

      const savedRatings = safeLocalStorage.getItem('excuseRatings');
      if (savedRatings) {
        const parsedRatings = JSON.parse(savedRatings);
        // Convert timestamp strings back to Date objects
        const ratingsWithDates = Object.fromEntries(
          Object.entries(parsedRatings).map(([excuse, data]: [string, any]) => [
            excuse,
            { ...data, timestamp: new Date(data.timestamp) }
          ])
        );
        setExcuseRatings(ratingsWithDates);
      }

      const savedPremiumStatus = safeLocalStorage.getItem('isPremium');
      if (savedPremiumStatus === 'true') {
        setIsPremium(true);
      }

      const savedCustomExcuses = safeLocalStorage.getItem('customExcuses');
      if (savedCustomExcuses) {
        setCustomExcuses(JSON.parse(savedCustomExcuses));
      }

      // Load analytics data
      const savedUsageStats = safeLocalStorage.getItem('usageStats');
      if (savedUsageStats) {
        setUsageStats(JSON.parse(savedUsageStats));
      }

      const savedExcuseAnalytics = safeLocalStorage.getItem('excuseAnalytics');
      if (savedExcuseAnalytics) {
        const parsedAnalytics = JSON.parse(savedExcuseAnalytics);
        // Convert date strings back to Date objects
        const analyticsWithDates = Object.fromEntries(
          Object.entries(parsedAnalytics).map(([excuse, data]: [string, any]) => [
            excuse,
            { ...data, lastUsed: new Date(data.lastUsed) }
          ])
        );
        setExcuseAnalytics(analyticsWithDates);
      }

      const savedAbTestGroups = safeLocalStorage.getItem('abTestGroups');
      if (savedAbTestGroups) {
        setAbTestGroups(JSON.parse(savedAbTestGroups));
      } else {
        // Initialize A/B testing on first load
        initializeABTest();
      }
      
      // Load subscription data
      const savedSubscriptionData = safeLocalStorage.getItem('subscriptionData');
      if (savedSubscriptionData) {
        const parsedSubData = JSON.parse(savedSubscriptionData);
        // Convert date strings back to Date objects
        setSubscriptionData({
          ...parsedSubData,
          startDate: new Date(parsedSubData.startDate),
          expiryDate: parsedSubData.expiryDate ? new Date(parsedSubData.expiryDate) : undefined,
          usage: {
            ...parsedSubData.usage,
            lastReset: new Date(parsedSubData.usage.lastReset)
          }
        });
      }
      
      const savedSubscriptionTier = safeLocalStorage.getItem('subscriptionTier');
      if (savedSubscriptionTier && ['free', 'pro', 'premium'].includes(savedSubscriptionTier)) {
        setSubscriptionTier(savedSubscriptionTier as 'free' | 'pro' | 'premium');
        
        // Automatically set premium status for Pro and Premium tiers
        if (savedSubscriptionTier === 'pro' || savedSubscriptionTier === 'premium') {
          setIsPremium(true);
        }
      }
      
      // Load language preference
      const savedLanguage = safeLocalStorage.getItem('selectedLanguage');
      if (savedLanguage && ['en', 'es', 'fr', 'de', 'it', 'pt', 'ru', 'ja'].includes(savedLanguage)) {
        setSelectedLanguage(savedLanguage as 'en' | 'es' | 'fr' | 'de' | 'it' | 'pt' | 'ru' | 'ja');
      }
      
      // Load phone number preference
      const savedPhoneNumber = safeLocalStorage.getItem('userPhoneNumber');
      if (savedPhoneNumber) {
        setUserPhoneNumber(savedPhoneNumber);
      }
    } catch (error) {
      console.error('Error loading data from localStorage:', error);
    }
  }, []);

  // Save history to localStorage whenever it changes
  useEffect(() => {
    try {
      safeLocalStorage.setItem('excuseHistory', JSON.stringify(excuseHistory));
    } catch (error) {
      console.error('Error saving history to localStorage:', error);
    }
  }, [excuseHistory]);

  // Save favorites to localStorage whenever it changes
  useEffect(() => {
    try {
      safeLocalStorage.setItem('favorites', JSON.stringify(favorites));
    } catch (error) {
      console.error('Error saving favorites to localStorage:', error);
    }
  }, [favorites]);

  // Save ratings to localStorage whenever it changes
  useEffect(() => {
    try {
      safeLocalStorage.setItem('excuseRatings', JSON.stringify(excuseRatings));
    } catch (error) {
      console.error('Error saving ratings to localStorage:', error);
    }
  }, [excuseRatings]);

  // Save custom excuses to localStorage whenever it changes
  useEffect(() => {
    try {
      safeLocalStorage.setItem('customExcuses', JSON.stringify(customExcuses));
    } catch (error) {
      console.error('Error saving custom excuses to localStorage:', error);
    }
  }, [customExcuses]);

  // Save usage statistics to localStorage whenever it changes
  useEffect(() => {
    try {
      safeLocalStorage.setItem('usageStats', JSON.stringify(usageStats));
    } catch (error) {
      console.error('Error saving usage stats to localStorage:', error);
    }
  }, [usageStats]);

  // Save excuse analytics to localStorage whenever it changes
  useEffect(() => {
    try {
      safeLocalStorage.setItem('excuseAnalytics', JSON.stringify(excuseAnalytics));
    } catch (error) {
      console.error('Error saving excuse analytics to localStorage:', error);
    }
  }, [excuseAnalytics]);

  // Save A/B test groups to localStorage whenever it changes
  useEffect(() => {
    try {
      safeLocalStorage.setItem('abTestGroups', JSON.stringify(abTestGroups));
    } catch (error) {
      console.error('Error saving A/B test groups to localStorage:', error);
    }
  }, [abTestGroups]);

  // Save subscription data to localStorage whenever it changes
  useEffect(() => {
    try {
      safeLocalStorage.setItem('subscriptionData', JSON.stringify(subscriptionData));
      safeLocalStorage.setItem('subscriptionTier', subscriptionTier);
    } catch (error) {
      console.error('Error saving subscription data to localStorage:', error);
    }
  }, [subscriptionData, subscriptionTier]);

  // Save language selection to localStorage
  useEffect(() => {
    try {
      safeLocalStorage.setItem('selectedLanguage', selectedLanguage);
    } catch (error) {
      console.error('Error saving language to localStorage:', error);
    }
  }, [selectedLanguage]);

  // Save phone number to localStorage
  useEffect(() => {
    try {
      safeLocalStorage.setItem('userPhoneNumber', userPhoneNumber);
    } catch (error) {
      console.error('Error saving phone number to localStorage:', error);
    }
  }, [userPhoneNumber]);

  // Pick random excuse for daily widget - updates when language changes
  useEffect(() => {
    const allExcuses = Object.values(sampleExcuses).flatMap(category => 
      Object.values(category).flatMap(toneArray => toneArray)
    );
    const randomExcuse = allExcuses[Math.floor(Math.random() * allExcuses.length)];
    setDailyExcuse(randomExcuse);
  }, [selectedLanguage]); // Removed sampleExcuses to prevent infinite loop

  // Onboarding screen for first-time users
  if (onboarding) {
    return (
      <div className="min-h-screen bg-gradient-to-br from-yellow-100 to-orange-100 flex flex-col items-center justify-center p-6">
        <Card className="w-full max-w-md shadow-xl rounded-2xl">
          <CardContent className="p-6 space-y-6 text-center">
            <h1 className="text-3xl font-bold mb-2">{t.welcomeTitle}</h1>
            <p className="text-gray-600">{t.welcomeDescription}</p>

            {/* Language Selector */}
            <div className="mb-4">
              <label htmlFor="onboarding-language-select" className="block mb-2 text-sm font-medium text-gray-700">{t.chooseLanguageLabel}</label>
              <Select onValueChange={(val: 'en' | 'es' | 'fr' | 'de' | 'it' | 'pt' | 'ru' | 'ja') => setSelectedLanguage(val)} value={selectedLanguage}>
                <SelectTrigger id="onboarding-language-select" aria-label="Choose language for excuses" className="w-full">
                  <SelectValue placeholder="Select language" />
                </SelectTrigger>
                <SelectContent role="listbox" aria-label="Language options">
                  {Object.entries(availableLanguages).map(([code, lang]) => (
                    <SelectItem key={code} value={code} role="option">
                      {lang.flag} {lang.nativeName}
                    </SelectItem>
                  ))}
                </SelectContent>
              </Select>
            </div>

            <h2 className="text-lg font-semibold mb-4">{t.chooseStyleTitle}</h2>
            <div className="grid grid-cols-1 gap-3 mt-6">
              <Button className="w-full bg-purple-500 hover:bg-purple-600 text-white" onClick={() => { setTone("funny"); setOnboarding(false); }}>
                {t.funnyStyle}
              </Button>
              <Button className="w-full bg-blue-500 hover:bg-blue-600 text-white" onClick={() => { setTone("professional"); setOnboarding(false); }}>
                {t.professionalStyle}
              </Button>
              <Button className="w-full bg-green-500 hover:bg-green-600 text-white" onClick={() => { setTone("believable"); setOnboarding(false); }}>
                {t.believableStyle}
              </Button>
              <Button className="w-full bg-red-500 hover:bg-red-600 text-white" onClick={() => { setTone("dramatic"); setOnboarding(false); }}>
                {t.dramaticStyle}
              </Button>
            </div>

            <div className="mt-6 text-sm text-gray-500 flex items-center justify-center space-x-1">
              <Zap className="w-4 h-4 text-yellow-500" />
              <span>Change style anytime in settings</span>
            </div>
          </CardContent>
        </Card>
      </div>
    );
  }

  // Settings/Profile screen
  if (showSettings) {
    return (
      <div className="min-h-screen bg-gradient-to-br from-gray-100 to-gray-200 flex flex-col items-center justify-center p-6">
        <Card className="w-full max-w-md shadow-xl rounded-2xl">
          <CardContent className="p-6 space-y-6">
            <h2 className="text-2xl font-bold flex items-center space-x-2">
              <Settings className="w-5 h-5" /> <span>Settings & Profile</span>
            </h2>

            <div className="space-y-4">
              <div>
                <h3 className="font-semibold mb-2">üé≠ Favorite Excuses</h3>
                {favorites.length > 0 ? (
                  <ul className="list-disc pl-6 text-sm text-gray-700 space-y-1 max-h-32 overflow-y-auto">
                    {favorites.map((fav, index) => (
                      <li key={index}>{fav}</li>
                    ))}
                  </ul>
                ) : (
                  <p className="text-sm text-gray-500">No favorites saved yet.</p>
                )}
              </div>

              <div>
                <div className="flex items-center justify-between mb-2">
                  <h3 className="font-semibold flex items-center space-x-1">
                    <History className="w-4 h-4" /> <span>Recent History</span>
                  </h3>
                  {excuseHistory.length > 0 && (
                    <Button variant="ghost" size="sm" onClick={() => setExcuseHistory([])}>
                      <Trash2 className="w-3 h-3" />
                    </Button>
                  )}
                </div>
                {excuseHistory.length > 0 ? (
                  <div className="max-h-40 overflow-y-auto space-y-2">
                    {excuseHistory.slice(0, 10).map((entry, index) => (
                      <div key={index} className="text-xs p-2 bg-gray-50 rounded border">
                        <p className="text-gray-800 font-medium mb-1">{entry.excuse}</p>
                        <div className="flex justify-between text-gray-500">
                          <span>{entry.situation} ‚Ä¢ {entry.tone}</span>
                          <span>{entry.timestamp.toLocaleDateString()} {entry.timestamp.toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'})}</span>
                        </div>
                      </div>
                    ))}
                  </div>
                ) : (
                  <p className="text-sm text-gray-500">No excuses generated yet.</p>
                )}
              </div>

              <div>
                <div className="flex items-center justify-between mb-2">
                  <h3 className="font-semibold flex items-center space-x-1">
                    <TrendingUp className="w-4 h-4" /> <span>Rating Analytics</span>
                  </h3>
                </div>
                {(() => {
                  const stats = getRatingStats();
                  const topRated = getTopRatedExcuses();
                  
                  if (stats.totalRatings > 0) {
                    return (
                      <div className="space-y-3">
                        <div className="grid grid-cols-3 gap-2 text-center text-xs">
                          <div className="p-2 bg-green-50 rounded border">
                            <div className="text-green-600 font-semibold">{stats.upCount}</div>
                            <div className="text-gray-600">üëç Good</div>
                          </div>
                          <div className="p-2 bg-red-50 rounded border">
                            <div className="text-red-600 font-semibold">{stats.downCount}</div>
                            <div className="text-gray-600">üëé Poor</div>
                          </div>
                          <div className="p-2 bg-blue-50 rounded border">
                            <div className="text-blue-600 font-semibold">{stats.percentage}%</div>
                            <div className="text-gray-600">Success</div>
                          </div>
                        </div>
                        
                        {topRated.length > 0 && (
                          <div>
                            <h4 className="text-sm font-medium text-gray-700 mb-2">üèÜ Top Rated</h4>
                            <div className="space-y-1">
                              {topRated.slice(0, 3).map((excuse, index) => (
                                <div key={index} className="text-xs p-2 bg-green-50 rounded border">
                                  <span className="text-green-600 mr-1">#{index + 1}</span>
                                  <span className="text-gray-700">{excuse}</span>
                                </div>
                              ))}
                            </div>
                          </div>
                        )}
                      </div>
                    );
                  } else {
                    return (
                      <p className="text-sm text-gray-500">Start rating excuses to see analytics!</p>
                    );
                  }
                })()}
              </div>

              <div>
                <h3 className="font-semibold mb-2">üëë Subscription</h3>
                <div className="space-y-3">
                  <div className="flex items-center justify-between">
                    <p className="text-sm text-gray-600">
                      Current Plan: {isPremium ? (
                        <span className="text-yellow-600 font-semibold">‚ú® Premium</span>
                      ) : (
                        <span>Free</span>
                      )}
                    </p>
                    <div className="flex items-center space-x-2">
                      <span className="text-xs text-gray-500">Premium</span>
                      <Switch 
                        checked={isPremium} 
                        onCheckedChange={togglePremium}
                      />
                    </div>
                  </div>
                  {isPremium ? (
                    <div className="p-3 bg-yellow-50 rounded-lg border border-yellow-200">
                      <p className="text-sm text-yellow-800">
                        üéâ You have access to all premium features!
                      </p>
                      <ul className="text-xs text-yellow-700 mt-2 space-y-1">
                        <li>‚Ä¢ Enhanced excuse categories</li>
                        <li>‚Ä¢ Weather, traffic & medical proofs</li>
                        <li>‚Ä¢ Priority customer support</li>
                      </ul>
                    </div>
                  ) : (
                    <div className="p-3 bg-gray-50 rounded-lg border border-gray-200">
                      <p className="text-sm text-gray-700">
                        üí° Upgrade to unlock premium features:
                      </p>
                      <ul className="text-xs text-gray-600 mt-2 space-y-1">
                        <li>‚Ä¢ More excuse categories</li>
                        <li>‚Ä¢ Proof generators</li>
                        <li>‚Ä¢ Advanced analytics</li>
                      </ul>
                    </div>
                  )}
                </div>
              </div>

              <Button variant="outline" className="w-full mt-4" onClick={() => setShowSettings(false)}>‚¨ÖÔ∏è Back</Button>
            </div>
          </CardContent>
        </Card>
      </div>
    );
  }

  // Helper functions for beta feedback
  const getLanguageName = (langCode: string): string => {
    const languageNames = {
      'en': 'English',
      'es': 'Spanish',
      'fr': 'French', 
      'de': 'German',
      'it': 'Italian',
      'pt': 'Portuguese',
      'ru': 'Russian',
      'ja': 'Japanese'
    };
    return languageNames[langCode as keyof typeof languageNames] || 'English';
  };

  const getCurrentStyleName = (): string => {
    const styleNames = {
      'funny': 'Sneaky & Funny',
      'professional': 'Smooth & Professional',
      'believable': 'Realistic & Believable',
      'dramatic': 'Dramatic & Theatrical'
    };
    return styleNames[tone as keyof typeof styleNames] || tone;
  };

  return (
    <div className="min-h-screen bg-gradient-to-br from-purple-100 to-pink-100 flex flex-col items-center justify-center p-4 sm:p-6 space-y-4 sm:space-y-6">
      {/* Main Excuses, Excuses! App */}
      <Card className="w-full max-w-md shadow-xl rounded-2xl">
        <CardContent className="p-4 sm:p-6 space-y-4 sm:space-y-6">
          <div className="flex justify-between items-center">
            <h1 className="text-xl sm:text-2xl font-bold">üé≠ {t.appTitle}</h1>
            <div className="flex gap-2">
              <Button 
                variant="ghost" 
                size="sm" 
                onClick={() => setShowBetaFeedback(true)}
                className="text-blue-600 hover:text-blue-700 hover:bg-blue-50"
                title="Give beta feedback"
              >
                <TestTube className="w-4 h-4" />
                <span className="hidden sm:inline ml-1 text-xs">Beta</span>
              </Button>
              <Button variant="ghost" size="sm" onClick={() => setShowSettings(true)}>
                <Settings className="w-5 h-5" />
              </Button>
            </div>
          </div>

          {/* Daily Excuse Widget */}
          <div className="mt-4 p-4 bg-yellow-100 border border-yellow-300 rounded-xl text-center">
            <h3 className="font-semibold flex items-center justify-center space-x-2 text-yellow-800">
              <Calendar className="w-4 h-4" /> <span>{t.dailyExcuseTitle}</span>
            </h3>
            <p className="text-sm text-gray-700 mt-2 mb-2">{dailyExcuse}</p>
            <Button 
              variant="outline" 
              size="sm" 
              className="text-xs bg-white hover:bg-gray-50 border-gray-300 shadow-sm" 
              onClick={() => copyToClipboard(dailyExcuse)}
            >
              {copied ? <Check className="w-3 h-3 text-green-500 mr-1" /> : <Copy className="w-3 h-3 mr-1" />}
              {copied ? t.copied : t.copy}
            </Button>
          </div>

          <p className="text-gray-600 text-center mt-4">{t.pickInstructions}</p>
          {excuseHistory.length > 0 && (
            <div className="text-xs text-gray-500 text-center space-y-1">
              <p>üéØ {excuseHistory.length} excuse{excuseHistory.length !== 1 ? 's' : ''} generated</p>
              {(() => {
                const stats = getRatingStats();
                return stats.totalRatings > 0 ? (
                  <p>üìä {stats.percentage}% {t.successRate} ({stats.upCount}üëç {stats.downCount}üëé)</p>
                ) : null;
              })()}
            </div>
          )}

          <div className="space-y-4">
            <div>
              <label htmlFor="situation-select" className="block mb-1 text-sm font-medium">{t.situation}</label>
              <Select onValueChange={(val) => setSituation(val)} value={situation}>
                <SelectTrigger id="situation-select" aria-label="Choose a situation for your excuse">
                  <SelectValue placeholder={t.situationPlaceholder} />
                </SelectTrigger>
                <SelectContent role="listbox" aria-label="Situation options">
                  <SelectItem value="work" role="option">{t.situations.work}</SelectItem>
                  <SelectItem value="school" role="option">{t.situations.school}</SelectItem>
                  <SelectItem value="date" role="option">{t.situations.date}</SelectItem>
                  <SelectItem value="family" role="option">{t.situations.family}</SelectItem>
                  <SelectItem value="social" role="option">{t.situations.social}</SelectItem>
                  <SelectItem value="exercise">{t.situations.exercise}</SelectItem>
                  <SelectItem value="weather">{t.situations.weather}</SelectItem>
                  <SelectItem value="traffic">{t.situations.traffic}</SelectItem>
                  <SelectItem value="medical">{t.situations.medical}</SelectItem>
                  {isPremium && (
                    <>
                      <SelectItem value="emergency">{t.situations.emergency}</SelectItem>
                      <SelectItem value="travel">{t.situations.travel}</SelectItem>
                    </>
                  )}
                </SelectContent>
              </Select>
            </div>

            <div>
              <label htmlFor="tone-select" className="block mb-1 text-sm font-medium">{t.tone}</label>
              <Select onValueChange={(val) => setTone(val)} value={tone}>
                <SelectTrigger id="tone-select" aria-label="Choose the tone for your excuse">
                  <SelectValue placeholder={t.tonePlaceholder} />
                </SelectTrigger>
                <SelectContent role="listbox" aria-label="Tone options">
                  <SelectItem value="funny" role="option">{t.tones.funny}</SelectItem>
                  <SelectItem value="professional" role="option">{t.tones.professional}</SelectItem>
                  <SelectItem value="believable" role="option">{t.tones.believable}</SelectItem>
                  <SelectItem value="dramatic" role="option">{t.tones.dramatic}</SelectItem>
                </SelectContent>
              </Select>
            </div>

            {/* Live Location & Weather Controls */}
            <div className="mt-3 p-3 bg-gradient-to-r from-green-50 to-blue-50 rounded-lg border border-green-200">
              <div className="flex items-center justify-between mb-2">
                <div className="flex items-center space-x-2">
                  <span className="text-sm font-semibold text-green-800">üåç Live Location Data</span>
                  {userLocation && (
                    <div className="text-xs bg-green-100 text-green-700 px-2 py-1 rounded max-w-xs">
                      <div className="font-medium">üìç Current Location</div>
                      <div className="text-xs opacity-90 truncate">
                        {userLocation.address || 
                         `${userLocation.city || 'Unknown City'}${userLocation.state ? `, ${userLocation.state}` : ''}` ||
                         `${userLocation.lat.toFixed(3)}, ${userLocation.lon.toFixed(3)}`}
                      </div>
                    </div>
                  )}
                </div>
                <button
                  onClick={() => setUseRealData(!useRealData)}
                  className={`px-2 py-1 rounded text-xs font-medium transition-colors ${
                    useRealData && userLocation
                      ? 'bg-green-500 text-white' 
                      : 'bg-gray-200 text-gray-600 hover:bg-gray-300'
                  }`}
                  disabled={!userLocation}
                >
                  {useRealData && userLocation ? 'ON' : 'OFF'}
                </button>
              </div>
              
              {!userLocation ? (
                <div className="space-y-2">
                  <p className="text-xs text-gray-600">
                    üí° Share your location for ultra-realistic weather and traffic excuses!
                  </p>
                  <button
                    onClick={requestLocation}
                    disabled={isLoadingLocation || locationPermission === 'denied'}
                    className={`w-full py-2 px-3 rounded font-medium text-sm transition-colors ${
                      isLoadingLocation
                        ? 'bg-gray-100 text-gray-500 cursor-not-allowed'
                        : locationPermission === 'denied'
                        ? 'bg-red-100 text-red-600 cursor-not-allowed'
                        : 'bg-blue-500 text-white hover:bg-blue-600'
                    }`}
                  >
                    {isLoadingLocation ? (
                      <>
                        <div className="animate-spin rounded-full h-4 w-4 border-2 border-white border-t-transparent inline-block mr-2"></div>
                        Getting Location...
                      </>
                    ) : locationPermission === 'denied' ? (
                      '‚ùå Location Access Denied'
                    ) : (
                      'üìç Share My Location'
                    )}
                  </button>
                </div>
              ) : (
                <div className="space-y-2">
                  <div className="flex items-center justify-between text-xs">
                    <span className="text-gray-600">Weather:</span>
                    <span className="font-medium text-blue-600">
                      {liveWeatherData ? `${liveWeatherData.condition} ${liveWeatherData.temperature}¬∞F` : 'Loading...'}
                    </span>
                  </div>
                  <div className="flex items-center justify-between text-xs">
                    <span className="text-gray-600">Traffic:</span>
                    <span className="font-medium text-orange-600">
                      {liveTrafficData ? `${liveTrafficData.type} delays` : 'Loading...'}
                    </span>
                  </div>
                  {useRealData && (
                    <div className="text-xs text-green-600 font-medium text-center">
                      ‚úÖ Using real conditions for authentic excuses!
                    </div>
                  )}
                </div>
              )}
            </div>

            {/* Format Selection - Available to All Users */}
            <div className="mt-3 p-2 bg-gray-50 rounded-lg border">
              <div className="flex items-center justify-between mb-2">
                <span className="text-xs font-medium text-gray-700">Proof Format:</span>
                <div className="flex items-center space-x-1">
                  <button
                    onClick={() => setProofFormat('document')}
                    className={`px-2 py-1 rounded text-xs font-medium transition-colors ${
                      proofFormat === 'document' 
                        ? 'bg-blue-100 text-blue-700 border border-blue-300' 
                        : 'bg-white text-gray-600 hover:bg-gray-100'
                    }`}
                  >
                    üìÑ Document
                  </button>
                  <button
                    onClick={() => setProofFormat('email')}
                    className={`px-2 py-1 rounded text-xs font-medium transition-colors ${
                      proofFormat === 'email' 
                        ? 'bg-blue-100 text-blue-700 border border-blue-300' 
                        : 'bg-white text-gray-600 hover:bg-gray-100'
                    }`}
                  >
                    üìß Email
                  </button>
                  <button
                    onClick={() => setProofFormat('sms')}
                    className={`px-2 py-1 rounded text-xs font-medium transition-colors ${
                      proofFormat === 'sms' 
                        ? 'bg-blue-100 text-blue-700 border border-blue-300' 
                        : 'bg-white text-gray-600 hover:bg-gray-100'
                    }`}
                  >
                    üì± SMS
                  </button>
                </div>
              </div>
              
              {/* Phone Number Input - Only show for SMS format */}
              {proofFormat === 'sms' && (
                <div className="mt-2">
                  <label className="block text-xs font-medium text-gray-700 mb-1">
                    Your Phone Number (for SMS recipient):
                  </label>
                  <input
                    type="tel"
                    value={userPhoneNumber}
                    onChange={(e) => setUserPhoneNumber(e.target.value)}
                    placeholder="(555) 123-4567"
                    className="w-full px-2 py-1 text-xs border border-gray-300 rounded focus:outline-none focus:ring-1 focus:ring-blue-500 focus:border-blue-500 text-gray-900 bg-white"
                    maxLength={20}
                  />
                </div>
              )}
              
              {/* Email Address Input - Show for Email format with better styling */}
              {proofFormat === 'email' && (
                <div className="mt-3 p-3 bg-green-50 border-2 border-green-200 rounded-lg">
                  <label className="block text-sm font-semibold text-green-800 mb-2">
                    üìß Send To Email Address:
                  </label>
                  <input
                    type="email"
                    value={userEmailAddress}
                    onChange={(e) => setUserEmailAddress(e.target.value)}
                    placeholder="boss@company.com or hr@company.com"
                    className="w-full px-3 py-2 text-sm border-2 border-green-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-green-500 focus:border-green-500 text-gray-900 bg-white"
                    autoFocus
                  />
                  <p className="text-xs text-green-600 mt-1">
                    üí° This will open your email app with the proof ready to send!
                  </p>
                </div>
              )}
            </div>

            <div className="flex items-center space-x-2">
              <Switch 
                checked={isPremium} 
                onCheckedChange={isPremium ? () => {} : () => setShowPremium(true)} 
                disabled={!isPremium}
              />
              <span className="text-sm">Add Proof {!isPremium && '(Premium)'}</span>
              {isPremium && (
                <div className="flex space-x-1 ml-2">
                  <Button variant="ghost" size="sm" onClick={() => generateProof('weather')}>
                    <Cloud className="w-3 h-3" />
                  </Button>
                  <Button variant="ghost" size="sm" onClick={() => generateProof('traffic')}>
                    <MapPin className="w-3 h-3" />
                  </Button>
                  <Button variant="ghost" size="sm" onClick={() => {
                    console.log('Medical certificate button clicked (small)');
                    generateProof('medical');
                  }}>
                    <FileText className="w-3 h-3" />
                  </Button>
                </div>
              )}
            </div>

            <Button 
              className="w-full flex items-center justify-center space-x-2" 
              onClick={() => {
                console.log('Generate button clicked on mobile/desktop');
                generateExcuse();
              }}
              disabled={isGenerating}
              aria-label={isGenerating ? t.generating : t.generateAriaLabel}
              aria-describedby="excuse-help-text"
            >
              {isGenerating ? (
                <>
                  <div className="animate-spin rounded-full h-4 w-4 border-2 border-white border-t-transparent" aria-hidden="true"></div>
                  <span>{t.generating}</span>
                </>
              ) : (
                <>
                  <Sparkles className="w-4 h-4" aria-hidden="true" />
                  <span>{t.generateExcuse}</span>
                </>
              )}
            </Button>
            
            <p id="excuse-help-text" className="sr-only">
              {t.generateAriaDescription}
            </p>

            {/* New Feature Buttons */}
            <div className="grid grid-cols-2 gap-2 sm:grid-cols-5 sm:gap-2" role="group" aria-label="Additional features">
              <Button 
                variant="outline" 
                size="sm" 
                className="text-xs py-2 px-1 sm:px-2" 
                onClick={() => {
                  if (!checkSubscriptionLimits('custom')) {
                    setShowSubscription(true);
                    return;
                  }
                  setShowCustomExcuse(true);
                }}
                aria-label="Add your own custom excuse"
              >
                <span className="hidden sm:inline" aria-hidden="true">‚úçÔ∏è </span>{t.custom}
              </Button>
              <Button 
                variant="outline" 
                size="sm" 
                className="text-xs py-2 px-1 sm:px-2" 
                onClick={() => {
                  if (!checkSubscriptionLimits('template')) {
                    setShowSubscription(true);
                    return;
                  }
                  setShowTemplates(true);
                }}
                aria-label="Use customizable excuse templates"
              >
                <span className="hidden sm:inline" aria-hidden="true">üìù </span>{t.templates}
              </Button>
              <Button 
                variant="outline" 
                size="sm" 
                className="text-xs py-2 px-1 sm:px-2" 
                onClick={() => {
                  if (!hasFeature('analytics')) {
                    setShowSubscription(true);
                    return;
                  }
                  setShowAnalytics(true);
                }}
                aria-label="View usage analytics and statistics"
              >
                <span className="hidden sm:inline" aria-hidden="true">üìä </span>{t.analytics}
              </Button>
              <Button 
                variant="outline" 
                size="sm" 
                className="text-xs py-2 px-1 sm:px-2" 
                onClick={() => {
                  if (!hasFeature('exportFeatures')) {
                    setShowSubscription(true);
                    return;
                  }
                  setShowExport(true);
                }}
                aria-label="Export your favorites and history"
              >
                <span className="hidden sm:inline" aria-hidden="true">üì§ </span>{t.export}
              </Button>
              <Button 
                variant="outline" 
                size="sm" 
                className={`text-xs py-2 px-1 sm:px-2 ${
                  subscriptionTier === 'premium' 
                    ? 'bg-gradient-to-r from-yellow-50 to-orange-50 border-yellow-300' 
                    : subscriptionTier === 'pro' 
                      ? 'bg-gradient-to-r from-purple-50 to-blue-50 border-purple-300'
                      : ''
                }`}
                onClick={() => setShowSubscription(true)}
                aria-label="Manage subscription and billing"
              >
                {subscriptionTier === 'premium' && <Crown className="w-3 h-3 text-yellow-500 hidden sm:inline mr-1" />}
                {subscriptionTier === 'pro' && <Sparkles className="w-3 h-3 text-purple-500 hidden sm:inline mr-1" />}
                <span className="sm:hidden">üí≥</span>
                <span className="hidden sm:inline capitalize">{subscriptionTier}</span>
              </Button>
            </div>

            {/* Subscription Status Display */}
            <div className="mt-3 p-2 bg-gradient-to-r from-gray-50 to-blue-50 rounded-lg border">
              <div className="flex justify-between items-center text-xs text-gray-600">
                <span>Today's Usage:</span>
                <span className="font-medium">
                  {subscriptionData.usage.excusesToday}/{subscriptionData.features.dailyExcuseLimit === -1 ? '‚àû' : subscriptionData.features.dailyExcuseLimit} excuses
                </span>
              </div>
            </div>

            {/* Banner Ad for Free Users */}
            {shouldShowBannerAd() && !adDismissed && (
              <div className="mt-3 p-3 bg-gradient-to-r from-yellow-100 to-orange-100 rounded-lg border border-yellow-300 relative">
                <button 
                  onClick={dismissAd}
                  className="absolute top-1 right-2 text-gray-500 hover:text-gray-700 font-bold"
                  aria-label="Dismiss ad"
                >
                  √ó
                </button>
                <div className="text-center space-y-2">
                  <div className="text-xs text-gray-600 font-medium">Advertisement</div>
                  <div className="bg-white p-3 rounded border">
                    <div className="text-sm font-semibold text-blue-600 mb-1">üöÄ Excuses, Excuses! Pro</div>
                    <div className="text-xs text-gray-700 mb-2">Generate unlimited excuses with our professional AI assistant!</div>
                    <div className="flex items-center justify-center space-x-2 text-xs">
                      <span className="bg-blue-100 text-blue-800 px-2 py-1 rounded">Professional Tone</span>
                      <span className="bg-green-100 text-green-800 px-2 py-1 rounded">Weather Proof</span>
                      <span className="bg-purple-100 text-purple-800 px-2 py-1 rounded">Analytics</span>
                    </div>
                  </div>
                  <button 
                    onClick={() => setShowSubscription(true)}
                    className="text-xs text-blue-600 hover:text-blue-800 font-medium"
                  >
                    Remove Ads - Upgrade Now! ‚Üí
                  </button>
                </div>
              </div>
            )}

            {(hasFeature('proofGeneration') && subscriptionTier !== 'free') && (
              <div className="mt-4 p-3 bg-gradient-to-r from-yellow-50 to-orange-50 rounded-lg border border-yellow-200">
                <h4 className="text-sm font-semibold text-yellow-800 mb-2">‚ú® Premium Tools</h4>
                <p className="text-xs text-gray-600 mb-2">Current excuse count: {isPremium ? '240+' : '96'} available</p>
                
                {/* Format Toggle */}
                <div className="mb-3 flex items-center space-x-4">
                  <span className="text-xs font-medium text-gray-700">Format:</span>
                  <div className="flex items-center space-x-2">
                    <button
                      onClick={() => setProofFormat('document')}
                      className={`px-2 py-1 rounded text-xs font-medium transition-colors ${
                        proofFormat === 'document' 
                          ? 'bg-blue-100 text-blue-700 border border-blue-300' 
                          : 'bg-gray-100 text-gray-600 hover:bg-gray-200'
                      }`}
                    >
                      üìÑ Document
                    </button>
                    <button
                      onClick={() => setProofFormat('email')}
                      className={`px-2 py-1 rounded text-xs font-medium transition-colors ${
                        proofFormat === 'email' 
                          ? 'bg-blue-100 text-blue-700 border border-blue-300' 
                          : 'bg-gray-100 text-gray-600 hover:bg-gray-200'
                      }`}
                    >
                      üìß Email
                    </button>
                    <button
                      onClick={() => setProofFormat('sms')}
                      className={`px-2 py-1 rounded text-xs font-medium transition-colors ${
                        proofFormat === 'sms' 
                          ? 'bg-blue-100 text-blue-700 border border-blue-300' 
                          : 'bg-gray-100 text-gray-600 hover:bg-gray-200'
                      }`}
                    >
                      üì± SMS
                    </button>
                  </div>
                </div>
                
                {/* Phone Number Input - Only show for SMS format */}
                {proofFormat === 'sms' && (
                  <div className="mb-3">
                    <label className="block text-xs font-medium text-gray-700 mb-1">
                      Your Phone Number (for SMS recipient):
                    </label>
                    <input
                      type="tel"
                      value={userPhoneNumber}
                      onChange={(e) => setUserPhoneNumber(e.target.value)}
                      placeholder="(555) 123-4567"
                      className="w-full px-2 py-1 text-xs border border-gray-300 rounded focus:outline-none focus:ring-1 focus:ring-blue-500 focus:border-blue-500 text-gray-900 bg-white"
                      maxLength={20}
                    />
                  </div>
                )}
                
                <div className="flex space-x-2">
                  <Button 
                    variant="outline" 
                    size="sm" 
                    className="text-xs" 
                    onClick={() => generateProof('weather')}
                    disabled={isGeneratingProof}
                  >
                    {isGeneratingProof ? '‚è≥' : 'üåßÔ∏è'} {t.weather}
                  </Button>
                  <Button 
                    variant="outline" 
                    size="sm" 
                    className="text-xs" 
                    onClick={() => generateProof('traffic')}
                    disabled={isGeneratingProof}
                  >
                    {isGeneratingProof ? '‚è≥' : 'üöó'} {t.traffic}  
                  </Button>
                  <Button 
                    variant="outline" 
                    size="sm" 
                    className="text-xs" 
                    onClick={() => {
                      console.log('Medical certificate button clicked (large)');
                      generateProof('medical');
                    }}
                    disabled={isGeneratingProof}
                  >
                    {isGeneratingProof ? '‚è≥' : 'üè•'} {t.medical}
                  </Button>
                </div>
              </div>
            )}

            {isGenerating && (
              <div className="mt-4 p-4 bg-blue-50 rounded-xl border border-blue-200 text-center">
                <div className="flex items-center justify-center space-x-3">
                  <div className="animate-spin rounded-full h-6 w-6 border-2 border-blue-500 border-t-transparent"></div>
                  <div className="space-y-1">
                    <p className="text-sm font-medium text-blue-700">{t.generatingExcuse}</p>
                    <p className="text-xs text-blue-600">{t.craftingStory}</p>
                  </div>
                </div>
              </div>
            )}

            {excuse && !isGenerating && (
              <div 
                className="mt-4 p-4 bg-gray-100 rounded-xl border text-center text-gray-800 opacity-100 scale-100 animate-in fade-in-50 duration-500"
                role="region"
                aria-label="Generated excuse"
                aria-live="polite"
              >
                <p className="font-medium mb-3" id="generated-excuse">{excuse}</p>
                <div className="flex justify-center space-x-2 mb-3" role="group" aria-label="Excuse actions">
                  <Button 
                    variant="ghost" 
                    size="sm" 
                    className="flex items-center space-x-1" 
                    onClick={saveFavorite}
                    aria-label="Save this excuse to your favorites"
                  >
                    <Star className="w-4 h-4 text-yellow-500" aria-hidden="true" /> <span>Save</span>
                  </Button>
                  <Button 
                    variant="ghost" 
                    size="sm" 
                    className="flex items-center space-x-1" 
                    onClick={() => copyToClipboard(excuse)}
                    aria-label={copied ? "Excuse copied to clipboard" : t.copyAriaLabel}
                  >
                    {copied ? <Check className="w-4 h-4 text-green-500" aria-hidden="true" /> : <Copy className="w-4 h-4 text-blue-500" aria-hidden="true" />} 
                    <span>{copied ? t.copied : "Copy"}</span>
                  </Button>
                  <Button variant="ghost" size="sm" className="flex items-center space-x-1" onClick={() => setShowShare(true)}>
                    <Share2 className="w-4 h-4 text-purple-500" /> <span>{t.share}</span>
                  </Button>
                </div>
                <div className="flex justify-center space-x-2 pt-2 border-t border-gray-200">
                  <span className="text-xs text-gray-500 self-center">{t.rateThis}</span>
                  <Button 
                    variant="ghost" 
                    size="sm" 
                    className={`flex items-center space-x-1 ${currentExcuseRated === 'up' || getExcuseRating(excuse) === 'up' ? 'text-green-600' : 'text-gray-400'}`}
                    onClick={() => rateExcuse(excuse, 'up')}
                  >
                    <ThumbsUp className="w-4 h-4" />
                    <span className="text-xs">{currentExcuseRated === 'up' ? t.thanks : t.good}</span>
                  </Button>
                  <Button 
                    variant="ghost" 
                    size="sm" 
                    className={`flex items-center space-x-1 ${currentExcuseRated === 'down' || getExcuseRating(excuse) === 'down' ? 'text-red-600' : 'text-gray-400'}`}
                    onClick={() => rateExcuse(excuse, 'down')}
                  >
                    <ThumbsDown className="w-4 h-4" />
                    <span className="text-xs">{currentExcuseRated === 'down' ? t.noted : t.bad}</span>
                  </Button>
                </div>
              </div>
            )}
          </div>
        </CardContent>
      </Card>

      {/* Proof Generator Screen */}
      {showProofGenerator && generatedProof && (
        <Card className="w-full max-w-md shadow-xl rounded-2xl border-2 border-green-400">
          <CardContent className="p-6 space-y-4">
            <h2 className="text-lg font-bold flex items-center space-x-2 text-green-600">
              <Camera className="w-5 h-5" /> <span>{generatedProof.type} Generated</span>
            </h2>
            
            <div className="bg-gray-50 p-4 rounded-lg border font-mono text-sm whitespace-pre-line max-h-96 overflow-y-auto text-gray-800">
              {generatedProof.content || 'No content generated'}
            </div>

            <div className="bg-green-50 p-3 rounded-lg border border-green-200">
              <p className="text-sm text-green-800">
                üí° <strong>Pro Tip:</strong> Use &quot;Send as SMS&quot; to open your phone&apos;s messaging app with the proof ready to send, or copy/screenshot for other uses!
              </p>
            </div>

            <div className="space-y-2">
              <Button 
                className="w-full bg-green-500 hover:bg-green-600 text-white" 
                onClick={() => copyToClipboard(generatedProof.content)}
              >
                {copied ? <Check className="w-4 h-4 mr-2" /> : <Copy className="w-4 h-4 mr-2" />}
                {copied ? t.copied : t.copyProof}
              </Button>
              
              {/* SMS Send Button - Show for all proofs but highlight for SMS format */}
              <Button 
                variant={proofFormat === 'sms' ? "default" : "outline"} 
                className={`w-full ${proofFormat === 'sms' ? 'bg-blue-500 hover:bg-blue-600 text-white' : ''}`}
                onClick={() => sendAsSMS(generatedProof.content, userPhoneNumber || undefined)}
              >
                <MessageSquare className="w-4 h-4 mr-2" />
                üì± Send as SMS
              </Button>
              
              {/* Email Send Button - Show for all proofs but highlight for Email format */}
              <Button 
                variant={proofFormat === 'email' ? "default" : "outline"} 
                className={`w-full ${proofFormat === 'email' ? 'bg-green-500 hover:bg-green-600 text-white' : ''}`}
                onClick={() => sendAsEmail(generatedProof.content, userEmailAddress || 'employer@company.com')}
                disabled={emailSending}
              >
                {emailSending ? (
                  <>
                    <div className="animate-spin rounded-full h-4 w-4 border-2 border-white border-t-transparent mr-2"></div>
                    Opening Email...
                  </>
                ) : (
                  <>
                    <Mail className="w-4 h-4 mr-2" />
                    üìß Open Email App
                  </>
                )}
              </Button>
              
              {/* Quick Email Button - Always works, no email required */}
              {proofFormat !== 'email' && (
                <Button 
                  variant="outline" 
                  className="w-full border-green-300 text-green-700 hover:bg-green-50"
                  onClick={() => {
                    const subject = 'Medical Excuse Documentation';
                    const mailtoUrl = `mailto:?subject=${encodeURIComponent(subject)}&body=${encodeURIComponent(generatedProof.content)}`;
                    window.location.href = mailtoUrl;
                    alert('üìß Email app should open now! Add your employer\'s email address in the "To" field.');
                  }}
                >
                  <Mail className="w-4 h-4 mr-2" />
                  ‚úâÔ∏è Quick Email
                </Button>
              )}
              
              {/* Copy for Email Button - Backup option */}
              <Button 
                variant="outline" 
                className="w-full border-green-300 text-green-700 hover:bg-green-50"
                onClick={() => {
                  navigator.clipboard.writeText(generatedProof.content);
                  alert('üìã Copied! Now:\n1. Open your email\n2. Paste the proof (Ctrl+V)\n3. Send to your employer');
                }}
              >
                üìã Copy for Email
              </Button>

              {/* Premium Image Download Buttons */}
              {generatedProof.image && (
                <>
                  <div className="bg-gradient-to-r from-yellow-50 to-orange-50 p-3 rounded-lg border border-yellow-200">
                    <p className="text-sm text-yellow-800 font-medium mb-2">
                      üé® <strong>Premium Visual Proof:</strong> Download the official document image for maximum believability!
                    </p>
                  </div>
                  
                  <Button 
                    className="w-full bg-gradient-to-r from-yellow-500 to-orange-500 hover:from-yellow-600 hover:to-orange-600 text-white" 
                    onClick={() => {
                      if (generatedProof.image) {
                        downloadImageFile(generatedProof.image, `${generatedProof.type.replace(/[^a-zA-Z0-9]/g, '_')}_${Date.now()}.png`);
                      }
                    }}
                  >
                    <Camera className="w-4 h-4 mr-2" />
                    üì∏ Download Visual Proof
                  </Button>
                  
                  <Button 
                    variant="outline" 
                    className="w-full border-yellow-300 text-yellow-700 hover:bg-yellow-50"
                    onClick={() => {
                      if (generatedProof.image) {
                        // Open image in new tab for sharing
                        const newWindow = window.open();
                        if (newWindow) {
                          newWindow.document.write(`
                            <html>
                              <head><title>${generatedProof.type}</title></head>
                              <body style="margin:0;padding:20px;background:#f0f0f0;">
                                <img src="${generatedProof.image}" style="max-width:100%;height:auto;border:1px solid #ccc;box-shadow:0 4px 8px rgba(0,0,0,0.1);">
                                <p style="margin-top:10px;font-family:Arial,sans-serif;color:#666;font-size:14px;">Right-click the image above to save or share</p>
                              </body>
                            </html>
                          `);
                        }
                      }
                    }}
                  >
                    <Share className="w-4 h-4 mr-2" />
                    üëÅÔ∏è View & Share Image
                  </Button>
                </>
              )}
              
              <Button variant="outline" className="w-full" onClick={() => setShowProofGenerator(false)}>
                ‚¨ÖÔ∏è Back
              </Button>
            </div>
          </CardContent>
        </Card>
      )}

      {/* Premium Screen */}
      {showPremium && (
        <Card className="w-full max-w-md shadow-xl rounded-2xl border-2 border-yellow-400">
          <CardContent className="p-6 space-y-4">
            <h2 className="text-xl font-bold flex items-center space-x-2 text-yellow-600">
              <Crown className="w-5 h-5" /> <span>Unlock Premium</span>
            </h2>
            <p className="text-gray-600">Get realistic proof generators, unlimited excuses, and advanced features.</p>
            
            <div className="space-y-3">
              <h3 className="font-semibold text-gray-700">‚ú® Premium Features:</h3>
              <ul className="space-y-2 text-sm text-gray-700">
                <li className="flex items-center space-x-2">
                  <Cloud className="w-4 h-4 text-blue-500" />
                  <span>Fake weather alerts & screenshots</span>
                </li>
                <li className="flex items-center space-x-2">
                  <MapPin className="w-4 h-4 text-red-500" />
                  <span>Traffic jam reports & maps</span>
                </li>
                <li className="flex items-center space-x-2">
                  <FileText className="w-4 h-4 text-green-500" />
                  <span>Doctor's note templates</span>
                </li>
                <li className="flex items-center space-x-2">
                  <Sparkles className="w-4 h-4 text-purple-500" />
                  <span>Unlimited excuse categories</span>
                </li>
                <li className="flex items-center space-x-2">
                  <TrendingUp className="w-4 h-4 text-orange-500" />
                  <span>Advanced analytics & insights</span>
                </li>
              </ul>
            </div>

            <div className="bg-yellow-50 p-3 rounded-lg border border-yellow-200">
              <p className="text-sm text-yellow-800">
                üéâ <strong>Launch Special:</strong> Get lifetime access for just $9.99 (normally $4.99/month)
              </p>
            </div>

            <div className="space-y-2">
              <Button className="w-full bg-yellow-500 hover:bg-yellow-600 text-white" onClick={unlockPremium}>
                üöÄ Unlock Premium - $9.99
              </Button>
              <Button variant="ghost" className="w-full" onClick={() => setShowPremium(false)}>
                Maybe Later
              </Button>
            </div>
          </CardContent>
        </Card>
      )}

      {/* Patient Information Dialog */}
      {showPatientInfoDialog && (
        <Card className="w-full max-w-md shadow-xl rounded-2xl border-2 border-blue-400">
          <CardContent className="p-6 space-y-4">
            <h2 className="text-xl font-bold flex items-center space-x-2 text-blue-600">
              <FileText className="w-5 h-5" /> <span>Medical Certificate</span>
            </h2>
            <p className="text-gray-600">Please provide your information for the medical certificate.</p>
            
            <div className="space-y-4">
              <div>
                <label className="block text-sm font-medium text-gray-700 mb-1">
                  Full Name *
                </label>
                <input
                  type="text"
                  value={patientName}
                  onChange={(e) => setPatientName(e.target.value)}
                  placeholder="Enter your full name"
                  className="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent text-gray-900 bg-white placeholder-gray-400"
                />
              </div>
              
              <div>
                <label className="block text-sm font-medium text-gray-700 mb-1">
                  Date of Birth (Optional)
                </label>
                <input
                  type="date"
                  value={patientDateOfBirth}
                  onChange={(e) => setPatientDateOfBirth(e.target.value)}
                  className="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent text-gray-900 bg-white"
                />
              </div>
            </div>
            
            <div className="bg-blue-50 p-3 rounded-lg border border-blue-200">
              <p className="text-sm text-blue-800">
                üìã <strong>Note:</strong> This information will be used to create a realistic medical certificate document.
              </p>
            </div>
            
            <div className="space-y-2">
              <Button 
                className="w-full bg-blue-500 hover:bg-blue-600 text-white" 
                onClick={generateMedicalProofWithPatientInfo}
                disabled={!patientName.trim()}
              >
                üè• Generate Medical Certificate
              </Button>
              <Button variant="ghost" className="w-full" onClick={() => setShowPatientInfoDialog(false)}>
                Cancel
              </Button>
            </div>
          </CardContent>
        </Card>
      )}

      {/* Share Screen */}
      {showShare && excuse && (
        <Card className="w-full max-w-md shadow-xl rounded-2xl">
          <CardContent className="p-6 space-y-4">
            <h2 className="text-lg font-semibold text-center">Share Your Excuse</h2>
            <div className="p-3 bg-gray-50 rounded-lg border text-center">
              <p className="text-sm font-medium text-gray-800">"{excuse}"</p>
            </div>
            
            <div className="space-y-3">
              <h3 className="text-sm font-medium text-gray-600">Quick Actions</h3>
              <div className="grid grid-cols-2 gap-2">
                <Button variant="outline" className="flex items-center space-x-2 text-sm" onClick={() => copyToClipboard(excuse)}>
                  {copied ? <Check className="w-4 h-4 text-green-500" /> : <Copy className="w-4 h-4" />} 
                  <span>{copied ? t.copied : t.copy}</span>
                </Button>
                <Button variant="outline" className="flex items-center space-x-2 text-sm" onClick={() => shareViaSMS(excuse)}>
                  <MessageCircle className="w-4 h-4" /> <span>SMS</span>
                </Button>
                <Button variant="outline" className="flex items-center space-x-2 text-sm" onClick={() => shareViaEmail(excuse)}>
                  <Mail className="w-4 h-4" /> <span>Email</span>
                </Button>
                <Button variant="outline" className="flex items-center space-x-2 text-sm" onClick={() => shareViaWhatsApp(excuse)}>
                  <MessageCircle className="w-4 h-4 text-green-600" /> <span>WhatsApp</span>
                </Button>
              </div>

              <h3 className="text-sm font-medium text-gray-600 pt-2">Social Media</h3>
              <div className="grid grid-cols-2 gap-2">
                <Button variant="outline" className="flex items-center space-x-2 text-sm" onClick={() => shareViaTwitter(excuse)}>
                  <Twitter className="w-4 h-4 text-blue-500" /> <span>Twitter</span>
                </Button>
                <Button variant="outline" className="flex items-center space-x-2 text-sm" onClick={() => shareViaFacebook(excuse)}>
                  <Facebook className="w-4 h-4 text-blue-600" /> <span>Facebook</span>
                </Button>
              </div>

              {typeof navigator !== 'undefined' && 'share' in navigator && (
                <>
                  <h3 className="text-sm font-medium text-gray-600 pt-2">System Share</h3>
                  <Button variant="outline" className="w-full flex items-center justify-center space-x-2 text-sm" onClick={() => shareNative(excuse)}>
                    <Share2 className="w-4 h-4" /> <span>More Apps...</span>
                  </Button>
                </>
              )}
            </div>

            <Button variant="ghost" className="w-full mt-4" onClick={() => setShowShare(false)}>
              ‚¨ÖÔ∏è Back
            </Button>
          </CardContent>
        </Card>
      )}

      {/* Custom Excuse Modal */}
      {showCustomExcuse && (
        <Card className="w-full max-w-md mx-4 sm:mx-auto shadow-xl rounded-2xl animate-in fade-in-0 slide-in-from-bottom-4 duration-300">
          <CardContent className="p-4 sm:p-6">
            <h2 className="text-lg sm:text-xl font-bold mb-4">‚úçÔ∏è Add Custom Excuse</h2>
            
            <div className="space-y-4">
              <div>
                <label className="block mb-1 text-sm font-medium">Situation</label>
                <Select onValueChange={setCustomSituation} value={customSituation}>
                  <SelectTrigger>
                    <SelectValue />
                  </SelectTrigger>
                  <SelectContent>
                    <SelectItem value="work">üíº Work</SelectItem>
                    <SelectItem value="school">üéì School</SelectItem>
                    <SelectItem value="date">üíï Date</SelectItem>
                  </SelectContent>
                </Select>
              </div>

              <div>
                <label className="block mb-1 text-sm font-medium">Tone</label>
                <Select onValueChange={setCustomTone} value={customTone}>
                  <SelectTrigger>
                    <SelectValue />
                  </SelectTrigger>
                  <SelectContent>
                    <SelectItem value="funny">üòÇ Funny</SelectItem>
                    <SelectItem value="professional">üíº Professional</SelectItem>
                    <SelectItem value="believable">‚úÖ Believable</SelectItem>
                    <SelectItem value="dramatic">üé≠ Dramatic</SelectItem>
                  </SelectContent>
                </Select>
              </div>

              <div>
                <label className="block mb-1 text-sm font-medium">Your Custom Excuse</label>
                <textarea 
                  value={newCustomExcuse}
                  onChange={(e) => setNewCustomExcuse(e.target.value)}
                  className="w-full p-3 border border-gray-300 rounded-lg resize-none"
                  rows={3}
                  placeholder="Enter your creative excuse here..."
                />
              </div>

              <div className="flex space-x-2">
                <Button className="flex-1" onClick={addCustomExcuse} disabled={!newCustomExcuse.trim()}>
                  Add Excuse
                </Button>
                <Button variant="outline" onClick={() => setShowCustomExcuse(false)}>
                  Cancel
                </Button>
              </div>
            </div>

            {/* Display existing custom excuses */}
            {Object.keys(customExcuses).length > 0 && (
              <div className="mt-6">
                <h3 className="text-sm font-medium mb-3">Your Custom Excuses</h3>
                <div className="max-h-60 overflow-y-auto space-y-2">
                  {Object.entries(customExcuses).map(([situation, tones]) => 
                    Object.entries(tones).map(([tone, excuses]) => 
                      excuses.map((excuse, index) => (
                        <div key={`${situation}-${tone}-${index}`} className="p-2 bg-gray-50 rounded text-sm flex justify-between items-start">
                          <div className="flex-1">
                            <div className="text-xs text-gray-500 mb-1">{situation} ‚Ä¢ {tone}</div>
                            <div>{excuse}</div>
                          </div>
                          <Button 
                            variant="ghost" 
                            size="sm" 
                            onClick={() => deleteCustomExcuse(excuse, situation, tone)}
                            className="text-red-500 hover:text-red-700 ml-2"
                          >
                            <Trash2 className="w-3 h-3" />
                          </Button>
                        </div>
                      ))
                    )
                  )}
                </div>
              </div>
            )}
          </CardContent>
        </Card>
      )}

      {/* Templates Modal */}
      {showTemplates && (
        <Card className="w-full max-w-2xl shadow-xl rounded-2xl max-h-[80vh] overflow-hidden">
          <CardContent className="p-6">
            <h2 className="text-xl font-bold mb-4">üìù Excuse Templates</h2>
            
            <div className="space-y-4">
              <div className="grid grid-cols-2 gap-4">
                <div>
                  <label className="block mb-1 text-sm font-medium">Situation</label>
                  <Select onValueChange={(val) => setSituation(val)} value={situation}>
                    <SelectTrigger>
                      <SelectValue />
                    </SelectTrigger>
                    <SelectContent>
                      <SelectItem value="work">üíº Work</SelectItem>
                      <SelectItem value="school">üéì School</SelectItem>
                      <SelectItem value="date">üíï Date</SelectItem>
                    </SelectContent>
                  </Select>
                </div>
                <div>
                  <label className="block mb-1 text-sm font-medium">Tone</label>
                  <Select onValueChange={(val) => setTone(val)} value={tone}>
                    <SelectTrigger>
                      <SelectValue />
                    </SelectTrigger>
                    <SelectContent>
                      <SelectItem value="funny">üòÇ Funny</SelectItem>
                      <SelectItem value="professional">üíº Professional</SelectItem>
                      <SelectItem value="believable">‚úÖ Believable</SelectItem>
                      <SelectItem value="dramatic">üé≠ Dramatic</SelectItem>
                    </SelectContent>
                  </Select>
                </div>
              </div>

              <div className="max-h-96 overflow-y-auto">
                {(excuseTemplates[situation as keyof typeof excuseTemplates]?.[tone as keyof typeof excuseTemplates['work']] || []).map((template: string, index: number) => (
                  <div key={index} className="mb-4 p-3 border border-gray-200 rounded-lg">
                    <div className="text-sm mb-2">{template}</div>
                    <div className="flex space-x-2 mb-2">
                      {(template.match(/{([^}]+)}/g) || []).map((placeholder: string, pIndex: number) => {
                        const key = placeholder.slice(1, -1);
                        return (
                          <input
                            key={pIndex}
                            type="text"
                            placeholder={key.replace(/_/g, ' ')}
                            className="flex-1 p-1 text-xs border border-gray-300 rounded"
                            value={templateValues[key] || ''}
                            onChange={(e) => setTemplateValues(prev => ({...prev, [key]: e.target.value}))}
                          />
                        );
                      })}
                    </div>
                    <div className="text-xs text-gray-600 p-2 bg-gray-50 rounded mb-2">
                      Preview: {generateFromTemplate(template)}
                    </div>
                    <Button size="sm" onClick={() => fillTemplate(template)} className="text-xs">
                      Use This Template
                    </Button>
                  </div>
                ))}
              </div>
            </div>

            <Button variant="outline" className="w-full mt-4" onClick={() => setShowTemplates(false)}>
              ‚¨ÖÔ∏è Back
            </Button>
          </CardContent>
        </Card>
      )}

      {/* Export Modal */}
      {showExport && (
        <Card className="w-full max-w-md shadow-xl rounded-2xl">
          <CardContent className="p-6">
            <h2 className="text-xl font-bold mb-4">üì§ Export Your Data</h2>
            
            <div className="space-y-6">
              <div>
                <h3 className="text-sm font-medium text-gray-700 mb-3">Export Favorites ({favorites.length} items)</h3>
                <div className="grid grid-cols-3 gap-2">
                  <Button variant="outline" size="sm" onClick={() => exportFavorites('txt')} disabled={favorites.length === 0}>
                    üìÑ TXT
                  </Button>
                  <Button variant="outline" size="sm" onClick={() => exportFavorites('json')} disabled={favorites.length === 0}>
                    üìã JSON
                  </Button>
                  <Button variant="outline" size="sm" onClick={() => exportFavorites('csv')} disabled={favorites.length === 0}>
                    üìä CSV
                  </Button>
                </div>
                {favorites.length === 0 && (
                  <p className="text-xs text-gray-500 mt-2">No favorites to export. Save some excuses first!</p>
                )}
              </div>

              <div>
                <h3 className="text-sm font-medium text-gray-700 mb-3">Export History ({excuseHistory.length} items)</h3>
                <div className="grid grid-cols-3 gap-2">
                  <Button variant="outline" size="sm" onClick={() => exportHistory('txt')} disabled={excuseHistory.length === 0}>
                    üìÑ TXT
                  </Button>
                  <Button variant="outline" size="sm" onClick={() => exportHistory('json')} disabled={excuseHistory.length === 0}>
                    üìã JSON
                  </Button>
                  <Button variant="outline" size="sm" onClick={() => exportHistory('csv')} disabled={excuseHistory.length === 0}>
                    üìä CSV
                  </Button>
                </div>
                {excuseHistory.length === 0 && (
                  <p className="text-xs text-gray-500 mt-2">No history to export. Generate some excuses first!</p>
                )}
              </div>

              <div className="p-3 bg-blue-50 rounded-lg text-xs">
                <strong>File Formats:</strong><br/>
                ‚Ä¢ TXT: Simple text format<br/>
                ‚Ä¢ JSON: Structured data with timestamps<br/>
                ‚Ä¢ CSV: Spreadsheet-compatible format
              </div>
            </div>

            <Button variant="outline" className="w-full mt-4" onClick={() => setShowExport(false)}>
              ‚¨ÖÔ∏è Back
            </Button>
          </CardContent>
        </Card>
      )}

      {/* Analytics Modal */}
      {showAnalytics && (
        <Card className="w-full max-w-3xl mx-4 sm:mx-auto shadow-xl rounded-2xl max-h-[85vh] overflow-hidden animate-in fade-in-0 slide-in-from-bottom-4 duration-300">
          <CardContent className="p-4 sm:p-6">
            <h2 className="text-lg sm:text-xl font-bold mb-4">üìä Usage Analytics & Insights</h2>
            
            <div className="max-h-96 overflow-y-auto space-y-6">
              {/* Usage Statistics */}
              <div>
                <h3 className="text-md font-semibold text-gray-700 mb-3">üìà Usage Overview</h3>
                <div className="grid grid-cols-2 gap-4">
                  <div className="p-3 bg-blue-50 rounded-lg text-center">
                    <div className="text-2xl font-bold text-blue-600">{usageStats.totalGenerations}</div>
                    <div className="text-sm text-gray-600">Total Excuses Generated</div>
                  </div>
                  <div className="p-3 bg-green-50 rounded-lg text-center">
                    <div className="text-2xl font-bold text-green-600">
                      {Object.keys(usageStats.situationCounts).length > 0 ? getMostPopularSituation() : 'N/A'}
                    </div>
                    <div className="text-sm text-gray-600">Most Popular Situation</div>
                  </div>
                  <div className="p-3 bg-purple-50 rounded-lg text-center">
                    <div className="text-2xl font-bold text-purple-600">
                      {Object.keys(usageStats.toneCounts).length > 0 ? getMostPopularTone() : 'N/A'}
                    </div>
                    <div className="text-sm text-gray-600">Most Popular Tone</div>
                  </div>
                  <div className="p-3 bg-yellow-50 rounded-lg text-center">
                    <div className="text-2xl font-bold text-yellow-600">
                      {getRatingStats().percentage}%
                    </div>
                    <div className="text-sm text-gray-600">Success Rate</div>
                  </div>
                </div>
              </div>

              {/* Situation Breakdown */}
              {Object.keys(usageStats.situationCounts).length > 0 && (
                <div>
                  <h3 className="text-md font-semibold text-gray-700 mb-3">üéØ Situation Breakdown</h3>
                  <div className="space-y-2">
                    {Object.entries(usageStats.situationCounts)
                      .sort(([,a], [,b]) => b - a)
                      .map(([situation, count]) => (
                        <div key={situation} className="flex justify-between items-center p-2 bg-gray-50 rounded">
                          <span className="capitalize font-medium">{situation}</span>
                          <div className="flex items-center space-x-2">
                            <div className="w-20 bg-gray-200 rounded-full h-2">
                              <div 
                                className="bg-blue-500 h-2 rounded-full" 
                                style={{ width: `${(count / usageStats.totalGenerations) * 100}%` }}
                              ></div>
                            </div>
                            <span className="text-sm font-semibold">{count}</span>
                          </div>
                        </div>
                      ))}
                  </div>
                </div>
              )}

              {/* Top Performing Excuses */}
              {Object.keys(excuseAnalytics).length > 0 && (
                <div>
                  <h3 className="text-md font-semibold text-gray-700 mb-3">üèÜ Top Performing Excuses</h3>
                  <div className="space-y-2">
                    {getTopPerformingExcuses().slice(0, 5).map((data, index) => (
                      <div key={index} className="p-3 bg-gradient-to-r from-green-50 to-blue-50 rounded-lg border">
                        <div className="text-sm font-medium mb-1">{data.excuse}</div>
                        <div className="flex justify-between text-xs text-gray-600">
                          <span>{data.situation} ‚Ä¢ {data.tone}</span>
                          <div className="flex space-x-3">
                            <span>Generated: {data.timesGenerated}x</span>
                            <span>Rating: {Math.round(data.averageRating * 100)}%</span>
                            <span>Effectiveness: {Math.round(data.effectiveness * 100)}%</span>
                          </div>
                        </div>
                      </div>
                    ))}
                    {getTopPerformingExcuses().length === 0 && (
                      <p className="text-sm text-gray-500 text-center py-4">
                        Start rating excuses to see performance analytics!
                      </p>
                    )}
                  </div>
                </div>
              )}

              {/* Underused Combinations */}
              {usageStats.totalGenerations > 5 && (
                <div>
                  <h3 className="text-md font-semibold text-gray-700 mb-3">üí° Suggestions</h3>
                  <div className="space-y-2">
                    {getLeastPopularCombinations().slice(0, 3).map((item, index) => (
                      <div key={index} className="p-3 bg-orange-50 rounded-lg border border-orange-200">
                        <div className="flex justify-between items-center">
                          <div>
                            <span className="text-sm font-medium">Try {item.combo.replace('-', ' + ')} combinations</span>
                            <div className="text-xs text-gray-600">Only used {item.count} times</div>
                          </div>
                          <Button 
                            size="sm" 
                            variant="outline" 
                            className="text-xs"
                            onClick={() => {
                              const [newSituation, newTone] = item.combo.split('-');
                              setSituation(newSituation);
                              setTone(newTone);
                              setShowAnalytics(false);
                            }}
                          >
                            Try Now
                          </Button>
                        </div>
                      </div>
                    ))}
                  </div>
                </div>
              )}

              {/* A/B Test Results */}
              {Object.keys(abTestGroups).length > 0 && (
                <div>
                  <h3 className="text-md font-semibold text-gray-700 mb-3">üß™ A/B Test Results</h3>
                  {Object.entries(abTestGroups).map(([testId, testData]) => (
                    <div key={testId} className="p-3 bg-gray-50 rounded-lg">
                      <div className="text-sm font-medium mb-2">Excuse Effectiveness Test</div>
                      <div className="grid grid-cols-2 gap-4">
                        <div className="text-center">
                          <div className="text-lg font-bold text-blue-600">
                            {testData.results.A.generations > 0 
                              ? Math.round((testData.results.A.positiveRatings / testData.results.A.ratings) * 100) || 0
                              : 0}%
                          </div>
                          <div className="text-xs text-gray-600">Variant A Success Rate</div>
                          <div className="text-xs text-gray-500">{testData.results.A.generations} generations</div>
                        </div>
                        <div className="text-center">
                          <div className="text-lg font-bold text-green-600">
                            {testData.results.B.generations > 0 
                              ? Math.round((testData.results.B.positiveRatings / testData.results.B.ratings) * 100) || 0
                              : 0}%
                          </div>
                          <div className="text-xs text-gray-600">Variant B Success Rate</div>
                          <div className="text-xs text-gray-500">{testData.results.B.generations} generations</div>
                        </div>
                      </div>
                      <div className="text-xs text-gray-500 mt-2 text-center">
                        You're in group {testData.userGroup}
                      </div>
                    </div>
                  ))}
                </div>
              )}

              {usageStats.totalGenerations === 0 && (
                <div className="text-center py-8">
                  <div className="text-6xl mb-4">üìä</div>
                  <h3 className="text-lg font-semibold text-gray-700 mb-2">No Data Yet</h3>
                  <p className="text-sm text-gray-500">Generate some excuses to see your analytics!</p>
                </div>
              )}
            </div>

            <Button variant="outline" className="w-full mt-4" onClick={() => setShowAnalytics(false)}>
              ‚¨ÖÔ∏è Back
            </Button>
          </CardContent>
        </Card>
      )}

      {/* Interstitial Ad Modal for Free Users */}
      {showAd && adType === 'interstitial' && subscriptionTier === 'free' && (
        <div className="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50" onClick={() => setShowAd(false)}>
          <Card className="w-full max-w-md mx-4 shadow-xl rounded-2xl" onClick={(e) => e.stopPropagation()}>
            <CardContent className="p-6 text-center space-y-4">
              <div className="flex justify-between items-start">
                <div className="text-xs text-gray-500">Advertisement</div>
                <button 
                  onClick={() => setShowAd(false)}
                  className="text-gray-500 hover:text-gray-700 font-bold text-lg"
                  aria-label="Close ad"
                >
                  √ó
                </button>
              </div>
              
              <div className="bg-gradient-to-r from-blue-50 to-purple-50 p-4 rounded-lg">
                <div className="text-2xl mb-2">üéØ</div>
                <div className="text-lg font-bold text-gray-800 mb-2">Need Better Excuses?</div>
                <div className="text-sm text-gray-600 mb-3">
                  Upgrade to Pro and get access to professional-grade excuses, weather reports, and unlimited generations!
                </div>
                <div className="flex justify-center space-x-2 text-xs mb-3">
                  <span className="bg-blue-100 text-blue-800 px-2 py-1 rounded">No Ads</span>
                  <span className="bg-green-100 text-green-800 px-2 py-1 rounded">50/day</span>
                  <span className="bg-purple-100 text-purple-800 px-2 py-1 rounded">Analytics</span>
                </div>
                <Button 
                  onClick={() => {
                    setShowAd(false);
                    setShowSubscription(true);
                  }}
                  className="w-full bg-gradient-to-r from-blue-500 to-purple-600 hover:from-blue-600 hover:to-purple-700 text-white"
                >
                  Upgrade to Pro - $4.99/month
                </Button>
              </div>
              
              <div className="text-xs text-gray-400">
                <button 
                  onClick={() => setShowAd(false)}
                  className="text-gray-500 hover:text-gray-700 underline"
                >
                  Continue with Free (with ads)
                </button>
              </div>
            </CardContent>
          </Card>
        </div>
      )}

      {/* Subscription Modal */}
      {showSubscription && (
        <Card className="w-full max-w-4xl shadow-xl rounded-2xl">
          <CardContent className="p-6 space-y-6">
            <div className="text-center space-y-2">
              <h2 className="text-2xl font-bold text-gray-900">Choose Your Plan</h2>
              <p className="text-gray-700">Unlock premium features and unlimited excuse generation</p>
            </div>

            {/* Current Usage Display */}
            <div className="bg-gradient-to-r from-blue-50 to-purple-50 p-4 rounded-lg">
              <h3 className="font-medium text-gray-800 mb-2">Current Usage ({subscriptionTiers[subscriptionTier].name})</h3>
              <div className="grid grid-cols-3 gap-4 text-sm">
                <div className="text-center">
                  <div className="font-semibold text-blue-700">{getRemainingUsage().excuses}</div>
                  <div className="text-gray-600">Excuses</div>
                </div>
                <div className="text-center">
                  <div className="font-semibold text-purple-700">{getRemainingUsage().customExcuses}</div>
                  <div className="text-gray-600">Custom Excuses</div>
                </div>
                <div className="text-center">
                  <div className="font-semibold text-green-700">{getRemainingUsage().templates}</div>
                  <div className="text-gray-600">Templates</div>
                </div>
              </div>
            </div>

            {/* Subscription Tiers */}
            <div className="grid md:grid-cols-3 gap-4">
              {Object.entries(subscriptionTiers).map(([tier, config]) => (
                <div key={tier} className={`relative p-6 rounded-2xl border-2 transition-all duration-200 ${
                  subscriptionTier === tier 
                    ? 'border-blue-500 bg-blue-50 shadow-lg scale-105' 
                    : tier === 'pro' 
                      ? 'border-purple-300 bg-purple-50 hover:border-purple-400' 
                      : tier === 'premium'
                        ? 'border-yellow-300 bg-yellow-50 hover:border-yellow-400'
                        : 'border-gray-200 bg-white hover:border-gray-300'
                }`}>
                  {tier === 'premium' && (
                    <div className="absolute -top-3 left-1/2 transform -translate-x-1/2">
                      <span className="bg-gradient-to-r from-yellow-400 to-orange-400 text-white px-3 py-1 rounded-full text-xs font-bold">
                        MOST POPULAR
                      </span>
                    </div>
                  )}
                  
                  <div className="text-center space-y-4">
                    <div className="space-y-2">
                      <h3 className="text-xl font-bold flex items-center justify-center space-x-2">
                        <span>{config.name}</span>
                        {tier === 'premium' && <Crown className="w-5 h-5 text-yellow-500" />}
                        {tier === 'pro' && <Sparkles className="w-5 h-5 text-purple-500" />}
                      </h3>
                      <div className="text-3xl font-bold text-gray-900">
                        {config.price}
                        {tier !== 'free' && <span className="text-sm font-normal text-gray-600">/month</span>}
                      </div>
                    </div>

                    <div className="space-y-3">
                      {config.featureList.map((feature, index) => (
                        <div key={index} className="flex items-center space-x-2 text-sm">
                          <Check className="w-4 h-4 text-green-600 flex-shrink-0" />
                          <span className="text-left text-gray-800">{feature}</span>
                        </div>
                      ))}
                    </div>

                    <div className="pt-4">
                      {subscriptionTier === tier ? (
                        <Button disabled className="w-full bg-gray-200 text-gray-600 cursor-not-allowed font-medium">
                          Current Plan
                        </Button>
                      ) : tier === 'free' ? (
                        <Button 
                          variant="outline" 
                          className="w-full"
                          onClick={() => {
                            setSubscriptionTier('free');
                            setSubscriptionData(prev => ({
                              ...prev,
                              tier: 'free',
                              features: config.features,
                            }));
                            setShowSubscription(false);
                          }}
                        >
                          Downgrade to Free
                        </Button>
                      ) : (
                        <Button 
                          className={`w-full ${
                            tier === 'premium' 
                              ? 'bg-gradient-to-r from-yellow-400 to-orange-500 hover:from-yellow-500 hover:to-orange-600' 
                              : 'bg-gradient-to-r from-purple-500 to-blue-600 hover:from-purple-600 hover:to-blue-700'
                          } text-white`}
                          onClick={() => upgradeSubscription(tier as 'pro' | 'premium')}
                        >
                          {subscriptionTier === 'free' ? 'Upgrade' : tier === 'premium' ? 'Upgrade to Premium' : 'Switch'} 
                        </Button>
                      )}
                    </div>
                  </div>
                </div>
              ))}
            </div>

            {/* Feature Comparison */}
            <div className="bg-gray-50 p-4 rounded-lg">
              <h3 className="font-medium text-gray-800 mb-3">Feature Comparison</h3>
              <div className="overflow-x-auto">
                <table className="w-full text-sm">
                  <thead>
                    <tr className="border-b">
                      <th className="text-left py-2 text-gray-800 font-semibold">Feature</th>
                      <th className="text-center py-2 text-gray-800 font-semibold">Free</th>
                      <th className="text-center py-2 text-gray-800 font-semibold">Pro</th>
                      <th className="text-center py-2 text-gray-800 font-semibold">Premium</th>
                    </tr>
                  </thead>
                  <tbody className="space-y-2">
                    <tr className="border-b">
                      <td className="py-2 text-gray-700">Daily Excuses</td>
                      <td className="text-center text-gray-700">10</td>
                      <td className="text-center text-gray-700">50</td>
                      <td className="text-center text-gray-700">Unlimited</td>
                    </tr>
                    <tr className="border-b">
                      <td className="py-2 text-gray-700">Custom Excuses</td>
                      <td className="text-center text-gray-700">5</td>
                      <td className="text-center text-gray-700">25</td>
                      <td className="text-center text-gray-700">Unlimited</td>
                    </tr>
                    <tr className="border-b">
                      <td className="py-2 text-gray-700">Templates</td>
                      <td className="text-center text-gray-700">2</td>
                      <td className="text-center text-gray-700">10</td>
                      <td className="text-center text-gray-700">Unlimited</td>
                    </tr>
                    <tr className="border-b">
                      <td className="py-2 text-gray-700">Proof Generator</td>
                      <td className="text-center">‚ùå</td>
                      <td className="text-center">‚úÖ</td>
                      <td className="text-center">‚úÖ</td>
                    </tr>
                    <tr className="border-b">
                      <td className="py-2 text-gray-700">Analytics</td>
                      <td className="text-center">‚ùå</td>
                      <td className="text-center">‚úÖ</td>
                      <td className="text-center text-gray-700">‚úÖ + A/B Testing</td>
                    </tr>
                    <tr className="border-b">
                      <td className="py-2 text-gray-700">Export Features</td>
                      <td className="text-center">‚ùå</td>
                      <td className="text-center">‚úÖ</td>
                      <td className="text-center text-gray-700">‚úÖ Multiple Formats</td>
                    </tr>
                  </tbody>
                </table>
              </div>
            </div>

            <div className="flex justify-center">
              <Button 
                variant="outline" 
                onClick={() => setShowSubscription(false)}
                className="px-6"
              >
                ‚¨ÖÔ∏è Back
              </Button>
            </div>
          </CardContent>
        </Card>
      )}
      
      {/* Beta Feedback Form */}
      <BetaFeedbackForm 
        isOpen={showBetaFeedback}
        onClose={() => setShowBetaFeedback(false)}
        currentLanguage={selectedLanguage}
        currentStyle={getCurrentStyleName()}
      />
    </div>
  );
}
